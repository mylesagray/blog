<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Replicating SAN on openSUSE with VAAI | Blah, Cloud</title>
<meta name=keywords content="drbd,iscsi,linux,openSUSE,OSS,VAAI,lio-target">
<meta name=description content="Preamble This article was written a few years back, but never published - it was some work I was doing in my lab to try and get to grips around the work involved in creating a SAN with synchronous replication built in from scratch.
It in no way should be used for production, but rather as a learning exercise - as previously stated the instructions are a few years old and version specific, so openSUSE may well now support some of the modules I had to compile and create repos for manually, also DRBD9 has been released and should obviously be used in place of DRBD8 as I have below.">
<meta name=author content="Myles Gray">
<link rel=canonical href=https://blah.cloud/hardware/replicating-san-opensuse-vaai/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.e38a41c5e7d4d3ea02d394ee536b3395f1cb27bd5a9162de1e375c7d2d1bc8f0.css integrity="sha256-44pBxefU0+oC05TuU2szlfHLJ71akWLeHjdcfS0byPA=" rel="preload stylesheet" as=style>
<link rel=preload href=/images/logo-title.png as=image>
<script defer crossorigin=anonymous src=/assets/js/scroll-toc.min.a4bed116d37981ac4d9e6d35b2e80495aaddc43e6e6191cfd20f1d510a738b65.js integrity="sha256-pL7RFtN5gaxNnm01sugElardxD5uYZHP0g8dUQpzi2U="></script>
<link rel=icon href=https://blah.cloud/images/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://blah.cloud/images/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://blah.cloud/images/favicon-32x32.png>
<link rel=apple-touch-icon href=https://blah.cloud/images/apple-touch-icon.png>
<link rel=mask-icon href=https://blah.cloud/images/logo.png>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.88.1">
<meta property="og:title" content="Replicating SAN on openSUSE with VAAI">
<meta property="og:description" content="Preamble This article was written a few years back, but never published - it was some work I was doing in my lab to try and get to grips around the work involved in creating a SAN with synchronous replication built in from scratch.
It in no way should be used for production, but rather as a learning exercise - as previously stated the instructions are a few years old and version specific, so openSUSE may well now support some of the modules I had to compile and create repos for manually, also DRBD9 has been released and should obviously be used in place of DRBD8 as I have below.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blah.cloud/hardware/replicating-san-opensuse-vaai/">
<meta property="og:image" content="https://blah.cloud/images/OpenSUSE_Logo.svg_.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2016-08-27T12:59:18+00:00">
<meta property="article:modified_time" content="2016-08-27T12:59:18+00:00"><meta property="og:site_name" content="Blah, Cloud">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://blah.cloud/images/OpenSUSE_Logo.svg_.png">
<meta name=twitter:title content="Replicating SAN on openSUSE with VAAI">
<meta name=twitter:description content="Preamble This article was written a few years back, but never published - it was some work I was doing in my lab to try and get to grips around the work involved in creating a SAN with synchronous replication built in from scratch.
It in no way should be used for production, but rather as a learning exercise - as previously stated the instructions are a few years old and version specific, so openSUSE may well now support some of the modules I had to compile and create repos for manually, also DRBD9 has been released and should obviously be used in place of DRBD8 as I have below.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Replicating SAN on openSUSE with VAAI","item":"https://blah.cloud/hardware/replicating-san-opensuse-vaai/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Replicating SAN on openSUSE with VAAI","name":"Replicating SAN on openSUSE with VAAI","description":"Preamble This article was written a few years back, but never published - it was some work I was doing in my lab to try and get to grips around the work involved in creating a SAN with synchronous replication built in from scratch.\nIt in no way should be used for production, but rather as a learning exercise - as previously stated the instructions are a few years old and version specific, so openSUSE may well now support some of the modules I had to compile and create repos for manually, also DRBD9 has been released and should obviously be used in place of DRBD8 as I have below.","keywords":["drbd","iscsi","linux","openSUSE","OSS","VAAI","lio-target"],"articleBody":"Preamble This article was written a few years back, but never published - it was some work I was doing in my lab to try and get to grips around the work involved in creating a SAN with synchronous replication built in from scratch.\nIt in no way should be used for production, but rather as a learning exercise - as previously stated the instructions are a few years old and version specific, so openSUSE may well now support some of the modules I had to compile and create repos for manually, also DRBD9 has been released and should obviously be used in place of DRBD8 as I have below.\nThe purpose of posting this information is just as a knowledge dump and some configs may come in handy to others out there. I learned a lot about the open source community during this project, how helpful, but also at times how toxic the politics can be. I could have written about those, as all the information is out in the open, but have chosen not to write about the experiences therein and rather, let the incredible work these people are doing speak for themselves.\nThe section about Corosync/Pacemaker is missing from the below, I will create some VMs with the config below and try to finish off that section in the near future - but know that these HA daemons were used to orchestrate quorum and failure domains in the event of bad things happening (automatically take down iSCSI targets etc).\n Intro / Specification I will leave the hardware spec and definition for another article, this one is just about getting the software sorted out.\nI had the need to create 2x SANs that had to have the following features:\n synchronous replication asynchronous replication (offsite-replication to another paired array - possibly) iSCSI support RAID10 - Large array (36TB per SAN) 10GbE 10-20k IOPS per host  Research With this in mind I had a few “nice” features I wanted the SANs to support myself, through software, namely:\n SPC-3/4 XCOPY, Persistent Reservations commands (SCSI Locking, Cluster Aware for Primary/Primary cluster) VAAI support SSD cache in front of HDDs (LSI cards with CacheCade)  A word on the above:\n VAAI is nothing more than standard (t10) SCSI commands implemented into VMWare’s ESX iSCSI initiator, there is nothing VMWare or VMFS specific about these commands so any hypervisor could add support for VAAI compliant storage by adding this functionality to their iSCSI initiator. The amazing thing about this change however is that data processing is now offloaded to the SAN’s hardware. Meaning your ESX instance now no longer has to process the data - this is particularly handy for cloning, replication, templating - instead of a VM clone taking hours it can take minutes. The exact commands are:    Atomic Test \u0026 Set (ATS), which is used during creation and locking of files on the VMFS volume (SCSI COMPARE AND WRITE) Clone Blocks/Full Copy/XCOPY, which is used to copy or migrate data within the same physical array (SCSI EXTENDED COPY) Zero Blocks/Write Same, which is used to zero-out disk regions (SCSI WRITE SAME) Block Delete in ESXi 5.x and later hosts, which allows for space to be reclaimed using the SCSI UNMAP feature. For more information on Block Delete (SCSI UNMAP)    Operating Systems are easy to choose between - especially for clustering, you either use RHEL or its derivatives (Fedora/CentOS) or SLES and thus conversely - openSUSE. Why not use Ubuntu? I hear you ask, Ubuntu is not what I call “Enterprise OS” material - clustering has been broken from 10.10 right through to the current release 13.04 - too focused on Desktop UX and not enough on core functionality it would appear.  Replication: DRBD is going to be the replication framework of choice - this is because it offers great support, is proven to be stable in production environments and as of DRBD9 will support scale-out clustering and multi-primary). I chose this over GlusterFS et al. because of stability problems using iSCSI on GlusterFS with VMWare - this has apparently been fixed in v3.3/3.4 but I have not tested and rather not be the one to find out.\niSCSI: I wanted an iSCSI framework that would support VAAI and SCP-3/4 commands - there is only one at the moment that does this and it is (controversially) Linux’s kernel build in SCSI framework - LIO - after fighting off SCST for the retired IET module.\nCluster Management: Heartbeat is dead, so the natural stack of choice for cluster management is Pacemaker/Corosync - all of DRBD’s guides are written for this and is basically a standard.\nSoftware So a break-down of the software to be used then:\n openSUSE12.3 (upgraded to linux-3.12 kernel) Lio-target w/ targetcli (native linux kernel SCSI module) DRBD 8.4.3 (DRBD9 as a rolling upgrade when released) Pacemaker/Corosync  First we install our base openSUSE 12.3 install - as default this comes with the linux-3.7.10 kernel to use the VAAI features of LIO Target we need to have the linux-3.12 kernel installed, so we need to pull this from the openSUSE kernel HEAD repository, get sudo then enter the following:\nzypper ar http://download.opensuse.org/repositories/Kernel:/HEAD/standard/ Kernel-Head zypper refresh #Yes you want to always trust this repo when adding zypper in --from Kernel-Head kernel-desktop #Yeah, openSUSE uses the desktop kernel reboot Upon reboot your output should read similar to this:\n# uname -r 3.14.0-rc3-4.g1d0217b-desktop Let’s install DRBD, openSUSE’s drbd trails behind what is currently in the linux kernel somewhat (v8.4.3) - the userland as of openSUSE 12.3 is v8.3.11 so I created a package to upgrade the userland to v8.4.3:\nzypper ar http://download.opensuse.org/repositories/home:MylesGray/openSUSE_12.3/home:MylesGray.repo zypper refresh #Yes - trust source zypper in --from home_MylesGray drbd That’s nicely installed DRBD for you avoiding all those exceedingly annoying userland and kernel recompiling problems you’d otherwise have :)\nNext up, install targetcli (again another package not in the openSUSE repo - i’ve added it to my build.opensuse.org repo):\nzypper ar http://download.opensuse.org/repositories/home:/MylesGray:/targetcli/openSUSE_12.3/home:MylesGray:targetcli.repo zypper refresh #Yes - trust source Next we have to remove the OS versions of these libs - the lio-utils one seems broken as standard, as such we need to run:\nzypper in --from home_MylesGray targetcli #select option 1 if prompted - Solution 1: deinstallation of patterns-openSUSE-minimal_base-conflicts So that’s targetcli and DRBD installed, lets configure drbd:\nnano /etc/drbd.conf Paste in the following:\nglobal { usage-count no; } common { protocol C; net { cram-hmac-alg sha1; shared-secret \"abc123456789\"; } syncer { rate 750M; } } resource data0 { device /dev/drbd0; disk /dev/sda5; meta-disk internal; on atlas { address 10.0.5.2:7789; } on zeus { address 10.0.5.3:7789; } } Start up DRBD:\nservice drbd start Bring resources up and make one node primary:\ndrbdadm primary --force all drbdadm -- --overwrite-data-of-peer primary all drbdadm up all drbd-overview Let’s create our lio-target config:\ntargetcli //backstores/iblock create data0 /dev/drbd0 //iscsi create //iscsi/iqn..../tpg1/luns create /backstores/iblock/data0 //iscsi/iqn..../tpg1/portals create 10.0.5.2 /saveconfig /exit We should now be able to access our target from our ESXi hosts.\nWhy not follow @mylesagray on Twitter for more like this!\n","wordCount":"1165","inLanguage":"en","image":"https://blah.cloud/images/OpenSUSE_Logo.svg_.png","datePublished":"2016-08-27T12:59:18Z","dateModified":"2016-08-27T12:59:18Z","author":{"@type":"Person","name":"Myles Gray","url":"/about"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blah.cloud/hardware/replicating-san-opensuse-vaai/"},"publisher":{"@type":"Organization","name":"Blah, Cloud","logo":{"@type":"ImageObject","url":"https://blah.cloud/images/favicon.ico"}}}</script>
<script defer data-domain=blah.cloud src=https://plausible.io/js/plausible.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<script>var themeColor=getComputedStyle(document.body).getPropertyValue('--primary');document.querySelector('meta[name="theme-color"]').setAttribute('content',themeColor)</script>
<noscript>
<style type=text/css>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(240, 202, 102, 1);--secondary:rgba(216, 214, 197, 1);--tertiary:rgba(128, 130 ,133 , 1);--content:rgba(206, 205, 188, 1);--hljs-bg:#282a36;--code-bg:#282a36;--border:rgba(240, 202, 102, 1)}.list{background:var(--theme)}}</style>
</noscript>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://blah.cloud/ accesskey=h title="Blah, Cloud. (Alt + H)">
<img src=/images/logo-title.png alt=logo aria-label=logo height=40></a>
</div>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
<ul id=menu>
<li>
<a href=https://blah.cloud/blog/ title=blog>
<span>blog</span>
</a>
</li>
<li>
<a href=https://blah.cloud/search/ title=" (Alt + /)" accesskey=/>
<span><svg style="height:1em;margin-top:1.5em" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="fill-current w-5" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span>
</a>
</li>
</ul>
</nav>
</header>
<div class=container>
<main class=main>
<div class=wrapper>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>
Replicating SAN on openSUSE with VAAI
</h1>
<div class=post-meta>August 27, 2016&nbsp;·&nbsp;Myles Gray&nbsp;|&nbsp;<a href=https://github.com/mylesagray/blog/blob/master/content/posts/2016-08-27-replicating-san-opensuse-vaai/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div>
</header>
<figure class=entry-cover>
<img loading=lazy srcset="https://blah.cloud/hardware/replicating-san-opensuse-vaai/images/OpenSUSE_Logo.svg__huf5abe46b07906e79744ce5d8dee59e38_30748_360x0_resize_box_3.png 360w ,https://blah.cloud/hardware/replicating-san-opensuse-vaai/images/OpenSUSE_Logo.svg__huf5abe46b07906e79744ce5d8dee59e38_30748_480x0_resize_box_3.png 480w ,https://blah.cloud/hardware/replicating-san-opensuse-vaai/images/OpenSUSE_Logo.svg__huf5abe46b07906e79744ce5d8dee59e38_30748_720x0_resize_box_3.png 720w ,https://blah.cloud/hardware/replicating-san-opensuse-vaai/images/OpenSUSE_Logo.svg_.png 1024w" sizes="(min-width: 768px) 720px, 100vw" src=https://blah.cloud/hardware/replicating-san-opensuse-vaai/images/OpenSUSE_Logo.svg_.png alt width=1024 height=734>
</figure><div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#preamble aria-label=Preamble>Preamble</a></li>
<li>
<a href=#intro--specification aria-label="Intro / Specification">Intro / Specification</a></li>
<li>
<a href=#research aria-label=Research>Research</a></li>
<li>
<a href=#software aria-label=Software>Software</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><h2 id=preamble>Preamble<a hidden class=anchor aria-hidden=true href=#preamble>#</a></h2>
<p>This article was written a few years back, but never published - it was some work I was doing in my lab to try and get to grips around the work involved in creating a SAN with synchronous replication built in from scratch.</p>
<p>It in no way should be used for production, but rather as a learning exercise - as previously stated the instructions are a few years old and version specific, so openSUSE may well now support some of the modules I had to compile and create repos for manually, also DRBD9 has been released and should obviously be used in place of DRBD8 as I have below.</p>
<p>The purpose of posting this information is just as a knowledge dump and some configs may come in handy to others out there. I learned a lot about the open source community during this project, how helpful, but also at times how toxic the politics can be. I could have written about those, as all the information is out in the open, but have chosen not to write about the experiences therein and rather, let the incredible work these people are doing speak for themselves.</p>
<p>The section about Corosync/Pacemaker is missing from the below, I will create some VMs with the config below and try to finish off that section in the near future - but know that these HA daemons were used to orchestrate quorum and failure domains in the event of bad things happening (automatically take down iSCSI targets etc).</p>
<hr>
<h2 id=intro--specification>Intro / Specification<a hidden class=anchor aria-hidden=true href=#intro--specification>#</a></h2>
<p>I will leave the hardware spec and definition for another article, this one is just about getting the software sorted out.</p>
<p>I had the need to create 2x SANs that had to have the following features:</p>
<ul>
<li>synchronous replication</li>
<li>asynchronous replication (offsite-replication to another paired array - possibly)</li>
<li>iSCSI support</li>
<li>RAID10 - Large array (36TB per SAN)</li>
<li>10GbE</li>
<li>10-20k IOPS per host</li>
</ul>
<h2 id=research>Research<a hidden class=anchor aria-hidden=true href=#research>#</a></h2>
<p>With this in mind I had a few &ldquo;nice&rdquo; features I wanted the SANs to support myself, through software, namely:</p>
<ul>
<li>SPC-3/4 <code>XCOPY</code>, <code>Persistent Reservations</code> commands (SCSI Locking, Cluster Aware for Primary/Primary cluster)</li>
<li><a href="http://kb.vmware.com/selfservice/microsites/search.do?language=en_US&cmd=displayKC&externalId=1021976">VAAI support</a></li>
<li>SSD cache in front of HDDs (LSI cards with CacheCade)</li>
</ul>
<p>A word on the above:</p>
<ul>
<li><code>VAAI</code> is nothing more than standard (<code>t10</code>) SCSI commands implemented into VMWare&rsquo;s ESX iSCSI initiator, there is nothing VMWare or VMFS specific about these commands so <em>any</em> hypervisor could add support for <code>VAAI</code> compliant storage by adding this functionality to their iSCSI initiator. <em>The amazing thing about this change however is that data processing is now offloaded to the SAN&rsquo;s hardware</em>. Meaning your ESX instance now no longer has to process the data - this is particularly handy for cloning, replication, templating - instead of a VM clone taking hours it can take minutes. The exact commands are:</li>
</ul>
<blockquote>
<ul>
<li>Atomic Test & Set (ATS), which is used during creation and locking of files on the VMFS volume (<strong><code>SCSI COMPARE AND WRITE</code></strong>)</li>
<li>Clone Blocks/Full Copy/XCOPY, which is used to copy or migrate data within the same physical array (<strong><code>SCSI EXTENDED COPY</code></strong>)</li>
<li>Zero Blocks/Write Same, which is used to zero-out disk regions (<strong><code>SCSI WRITE SAME</code></strong>)</li>
<li>Block Delete in ESXi 5.x and later hosts, which allows for space to be reclaimed using the SCSI UNMAP feature. For more information on Block Delete (<strong><code>SCSI UNMAP</code></strong>)</li>
</ul>
</blockquote>
<ul>
<li>Operating Systems are easy to choose between - especially for clustering, you either use RHEL or its derivatives (Fedora/CentOS) or SLES and thus conversely - openSUSE. <em>Why not use Ubuntu?</em> I hear you ask, Ubuntu is not what I call &ldquo;Enterprise OS&rdquo; material - clustering has been broken from 10.10 right through to the current release 13.04 - too focused on Desktop UX and not enough on core functionality it would appear.</li>
</ul>
<p><strong>Replication:</strong> DRBD is going to be the replication framework of choice - this is because it offers great support, is proven to be stable in production environments and as of DRBD9 will support scale-out clustering and multi-primary). I chose this over GlusterFS et al. because of stability problems using iSCSI on GlusterFS with VMWare - this has apparently been fixed in v3.3/3.4 but I have not tested and rather not be the one to find out.</p>
<p><strong>iSCSI:</strong> I wanted an iSCSI framework that would support <code>VAAI</code> and <code>SCP-3/4</code> commands - there is only <em>one</em> at the moment that does this and it is (controversially) Linux&rsquo;s kernel build in SCSI framework - LIO - after fighting off SCST for the retired IET module.</p>
<p><strong>Cluster Management:</strong> Heartbeat is dead, so the natural stack of choice for cluster management is Pacemaker/Corosync - all of DRBD&rsquo;s guides are written for this and is basically a standard.</p>
<h2 id=software>Software<a hidden class=anchor aria-hidden=true href=#software>#</a></h2>
<p>So a break-down of the software to be used then:</p>
<ul>
<li>openSUSE12.3 (upgraded to linux-3.12 kernel)</li>
<li>Lio-target w/ targetcli (native linux kernel SCSI module)</li>
<li>DRBD 8.4.3 (DRBD9 as a rolling upgrade when released)</li>
<li>Pacemaker/Corosync</li>
</ul>
<p>First we install our base openSUSE 12.3 install - as default this comes with the <code>linux-3.7.10</code> kernel to use the <code>VAAI</code> features of <code>LIO Target</code> we need to have the <code>linux-3.12</code> kernel installed, so we need to pull this from the openSUSE kernel HEAD repository, get <code>sudo</code> then enter the following:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh>zypper ar http://download.opensuse.org/repositories/Kernel:/HEAD/standard/ Kernel-Head
zypper refresh <span class=c1>#Yes you want to always trust this repo when adding</span>
zypper in --from Kernel-Head kernel-desktop <span class=c1>#Yeah, openSUSE uses the desktop kernel</span>
reboot
</code></pre></div><p>Upon reboot your output should read similar to this:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=c1># uname -r</span>
3.14.0-rc3-4.g1d0217b-desktop
</code></pre></div><p>Let&rsquo;s install DRBD, openSUSE&rsquo;s drbd trails behind what is currently in the linux kernel somewhat (v8.4.3) - the userland as of openSUSE 12.3 is v8.3.11 so I created a package to upgrade the userland to v8.4.3:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh>zypper ar http://download.opensuse.org/repositories/home:MylesGray/openSUSE_12.3/home:MylesGray.repo
zypper refresh <span class=c1>#Yes - trust source</span>
zypper in --from home_MylesGray drbd
</code></pre></div><p>That&rsquo;s nicely installed DRBD for you avoiding all those exceedingly annoying userland and kernel recompiling problems you&rsquo;d otherwise have :)</p>
<p>Next up, install <code>targetcli</code> (again another package not in the openSUSE repo - i&rsquo;ve added it to my build.opensuse.org repo):</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh>zypper ar http://download.opensuse.org/repositories/home:/MylesGray:/targetcli/openSUSE_12.3/home:MylesGray:targetcli.repo
zypper refresh <span class=c1>#Yes - trust source</span>
</code></pre></div><p>Next we have to remove the OS versions of these libs - the lio-utils one seems broken as standard, as such we need to run:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh>zypper in --from home_MylesGray targetcli <span class=c1>#select option 1 if prompted - Solution 1: deinstallation of patterns-openSUSE-minimal_base-conflicts</span>
</code></pre></div><p>So that&rsquo;s <code>targetcli</code> and DRBD installed, lets configure drbd:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh>nano /etc/drbd.conf
</code></pre></div><p>Paste in the following:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=err>global</span> <span class=p>{</span>
        <span class=err>usage-count</span> <span class=err>no;</span>
<span class=p>}</span>

<span class=err>common</span> <span class=p>{</span>
        <span class=err>protocol</span> <span class=err>C;</span>

        <span class=err>net</span> <span class=err>{</span>
                <span class=err>cram-hmac-alg</span> <span class=err>sha1;</span>
                <span class=err>shared-secret</span> <span class=nt>&#34;abc123456789&#34;</span><span class=err>;</span>
        <span class=p>}</span>

        <span class=err>syncer</span> <span class=p>{</span>
                <span class=err>rate</span> <span class=err>750M;</span>
        <span class=p>}</span>
<span class=err>}</span>

<span class=err>resource</span> <span class=err>data</span><span class=mi>0</span> <span class=p>{</span>
        <span class=err>device</span> <span class=err>/dev/drbd0;</span>
        <span class=err>disk</span> <span class=err>/dev/sda5;</span>
        <span class=err>meta-disk</span> <span class=err>internal;</span>

        <span class=err>on</span> <span class=err>atlas</span> <span class=err>{</span>
                <span class=err>address</span> <span class=err>10.0.5.2:7789;</span>
        <span class=p>}</span>
        <span class=err>on</span> <span class=err>zeus</span> <span class=p>{</span>
                <span class=err>address</span> <span class=err>10.0.5.3:7789;</span>
        <span class=p>}</span>
<span class=err>}</span>
</code></pre></div><p>Start up DRBD:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh>service drbd start
</code></pre></div><p>Bring resources up and make one node primary:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh>drbdadm primary --force all
drbdadm -- --overwrite-data-of-peer primary all
drbdadm up all
drbd-overview
</code></pre></div><p>Let&rsquo;s create our <code>lio-target</code> config:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh>targetcli
/&gt;/backstores/iblock create data0 /dev/drbd0
/&gt;/iscsi create
/&gt;/iscsi/iqn..../tpg1/luns create /backstores/iblock/data0
/&gt;/iscsi/iqn..../tpg1/portals create 10.0.5.2
/&gt;saveconfig
/&gt;exit
</code></pre></div><p>We should now be able to access our target from our ESXi hosts.</p>
<p>Why not follow <a href=https://twitter.com/mylesagray>@mylesagray on Twitter</a> for more like this!</p>
</div>
<footer class=post-footer>
<section class="section post-tags">
<div class=content>
<h2>Tagged with</h2>
</div>
<ul class=post-tags>
<li><a href=https://blah.cloud/tags/drbd/>drbd</a></li>
<li><a href=https://blah.cloud/tags/iscsi/>iscsi</a></li>
<li><a href=https://blah.cloud/tags/linux/>linux</a></li>
<li><a href=https://blah.cloud/tags/opensuse/>openSUSE</a></li>
<li><a href=https://blah.cloud/tags/oss/>OSS</a></li>
<li><a href=https://blah.cloud/tags/vaai/>VAAI</a></li>
<li><a href=https://blah.cloud/tags/lio-target/>lio-target</a></li>
</ul>
</section>
<nav class=paginav>
<a class=prev href=https://blah.cloud/networks/enabling-mini-jumbo-frames-rfc4638-bt-infinity/>
<span class=title>« Prev Page</span>
<br>
<span>Enabling Mini Jumbo Frames (RFC4638) on OpenReach FTTC</span>
</a>
<a class=next href=https://blah.cloud/automation/configuring-auto-deploy-stateless-caching-vsphere-6-0/>
<span class=title>Next Page »</span>
<br>
<span>Configuring Auto Deploy Stateless Caching in vSphere 6.0</span>
</a>
</nav>
<section class="section related-links">
<div class="columns is-centered">
<div class="column max-800px">
<div class=content>
<h2>Related content</h2>
</div>
<div class="columns related-links-columns">
<div class="column is-one-third">
<div class=card>
<div class=card-image>
<figure class="image is-3by2">
<a href=/virtualisation/recovering-nsx-manager-corrupt-filesystem/><img src=/virtualisation/recovering-nsx-manager-corrupt-filesystem/images/Screen-Shot-2016-11-13-at-18.54.00.png alt></a>
</figure>
</div>
<div class=card-content>
<a class="title is-5" href=https://blah.cloud/virtualisation/recovering-nsx-manager-corrupt-filesystem/>Recovering NSX Manager with corrupt filesystem</a>
</div>
</div>
</div>
<div class="column is-one-third">
<div class=card>
<div class=card-image>
<figure class="image is-3by2">
<a href=/infrastructure/utilising-kerberosad-auth-ubuntu-14-04-realmd/><img src=/infrastructure/utilising-kerberosad-auth-ubuntu-14-04-realmd/images/Screen-Shot-2014-12-07-at-16.35.40.png alt></a>
</figure>
</div>
<div class=card-content>
<a class="title is-5" href=https://blah.cloud/infrastructure/utilising-kerberosad-auth-ubuntu-14-04-realmd/>Utilising Kerberos/AD auth in Ubuntu 14.04 with realmd</a>
</div>
</div>
</div>
<div class="column is-one-third">
<div class=card>
<div class=card-image>
<figure class="image is-3by2">
<a href=/hardware/setting-multi-nic-vmotion-vsphere-5-5/><img src=/hardware/setting-multi-nic-vmotion-vsphere-5-5/images/Screen-Shot-2014-06-07-at-16.14.14.png alt></a>
</figure>
</div>
<div class=card-content>
<a class="title is-5" href=https://blah.cloud/hardware/setting-multi-nic-vmotion-vsphere-5-5/>Setting Up Multi-NIC vMotion in vSphere 5.5</a>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section class="section share-icons">
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share Replicating SAN on openSUSE with VAAI on twitter" href="https://twitter.com/intent/tweet/?text=Replicating%20SAN%20on%20openSUSE%20with%20VAAI&url=https%3a%2f%2fblah.cloud%2fhardware%2freplicating-san-opensuse-vaai%2f&hashtags=drbd%2ciscsi%2clinux%2copenSUSE%2cOSS%2cVAAI%2clio-target"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Replicating SAN on openSUSE with VAAI on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fblah.cloud%2fhardware%2freplicating-san-opensuse-vaai%2f&title=Replicating%20SAN%20on%20openSUSE%20with%20VAAI"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Replicating SAN on openSUSE with VAAI on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblah.cloud%2fhardware%2freplicating-san-opensuse-vaai%2f&title=Replicating%20SAN%20on%20openSUSE%20with%20VAAI&summary=Replicating%20SAN%20on%20openSUSE%20with%20VAAI&source=https%3a%2f%2fblah.cloud%2fhardware%2freplicating-san-opensuse-vaai%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
</div>
</section>
</footer><script src=https://utteranc.es/client.js repo=mylesagray/blog-comments issue-term=title theme=preferred-color-scheme crossorigin=anonymous async></script>
</article>
<aside class="hidden lg:block tableOfContentContainer" id=tableOfContentContainer>
<nav id=TableOfContents>
<ul>
<li><a href=#preamble>Preamble</a></li>
<li><a href=#intro--specification>Intro / Specification</a></li>
<li><a href=#research>Research</a></li>
<li><a href=#software>Software</a></li>
</ul>
</nav>
</aside>
</div>
</main>
</div>
<footer class=footer>
<span>&copy; 2021 <a href=https://blah.cloud/>Blah, Cloud</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>