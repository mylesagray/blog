<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Using Velero for K8s Backup and Restore of CSI Volumes | Blah, Cloud</title>
<meta name=keywords content="backup,Kubernetes,vSphere,velero,heptio ark,persistent volumes">
<meta name=description content="How to backup and restore K8s applications on vSphere">
<meta name=author content="Myles Gray">
<link rel=canonical href=https://blah.cloud/automation/using-velero-for-k8s-backup-and-restore-of-csi-volumes/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.ef8bac17525c299e0f71a2594f31de4bec4d2654aa856f57aca5a9410c5e28da.css integrity="sha256-74usF1JcKZ4PcaJZTzHeS+xNJlSqhW9XrKWpQQxeKNo=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/scroll-toc.min.c4f9a8e78694df8c52f7d3b0c44492ff3dcfa95d42215176796bef76438bc463.js integrity="sha256-xPmo54aU34xS99OwxESS/z3PqV1CIVF2eWvvdkOLxGM="></script>
<link rel=icon href=https://blah.cloud/images/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://blah.cloud/images/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://blah.cloud/images/favicon-32x32.png>
<link rel=apple-touch-icon href=https://blah.cloud/images/apple-touch-icon.png>
<link rel=mask-icon href=https://blah.cloud/images/logo.png>
<meta name=theme-color media="(prefers-color-scheme: dark)" content="rgba(88, 89, 91, 1)">
<meta name=theme-color content="rgba(240, 202, 102, 1)">
<meta name=msapplication-TileColor content="rgba(240, 202, 102, 1)">
<meta name=generator content="Hugo 0.89.0">
<meta property="og:title" content="Using Velero for K8s Backup and Restore of CSI Volumes">
<meta property="og:description" content="How to backup and restore K8s applications on vSphere">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blah.cloud/automation/using-velero-for-k8s-backup-and-restore-of-csi-volumes/"><meta property="og:image" content="https://blah.cloud/automation/using-velero-for-k8s-backup-and-restore-of-csi-volumes/images/og-card.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2019-10-04T12:18:17+00:00">
<meta property="article:modified_time" content="2021-10-25T15:18:17+00:00"><meta property="og:site_name" content="Blah, Cloud">
<meta property="og:see_also" content="https://blah.cloud/kubernetes/clusterapi-for-vsphere-now-with-cns-support/"><meta property="og:see_also" content="https://blah.cloud/kubernetes/first-look-automated-k8s-lifecycle-with-clusterapi/"><meta property="og:see_also" content="https://blah.cloud/infrastructure/using-cloud-init-for-vm-templating-on-vsphere/"><meta property="og:see_also" content="https://blah.cloud/kubernetes/using-the-vsphere-cloud-provider-for-k8s-to-dynamically-deploy-volumes/"><meta property="og:see_also" content="https://blah.cloud/kubernetes/setting-up-k8s-and-the-vsphere-cloud-provider-using-kubeadm/">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://blah.cloud/automation/using-velero-for-k8s-backup-and-restore-of-csi-volumes/images/og-card.png"><meta name=twitter:title content="Using Velero for K8s Backup and Restore of CSI Volumes">
<meta name=twitter:description content="How to backup and restore K8s applications on vSphere">
<meta name=twitter:site content="@mylesagray">
<meta name=twitter:creator content="@mylesagray">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Using Velero for K8s Backup and Restore of CSI Volumes","item":"https://blah.cloud/automation/using-velero-for-k8s-backup-and-restore-of-csi-volumes/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Using Velero for K8s Backup and Restore of CSI Volumes","name":"Using Velero for K8s Backup and Restore of CSI Volumes","description":"How to backup and restore K8s applications on vSphere","keywords":["backup","Kubernetes","vSphere","velero","heptio ark","persistent volumes"],"wordCount":"2517","inLanguage":"en","image":"https://blah.cloud/automation/using-velero-for-k8s-backup-and-restore-of-csi-volumes/images/minio-data.png","datePublished":"2019-10-04T12:18:17Z","dateModified":"2021-10-25T15:18:17Z","author":{"@type":"Person","name":"Myles Gray","url":"https:\/\/blah.cloud\/about"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blah.cloud/automation/using-velero-for-k8s-backup-and-restore-of-csi-volumes/"},"copyrightHolder":"Myles Gray","copyrightYear":"2019","isFamilyFriendly":"true","publisher":{"@type":"Person","name":"Myles Gray","logo":{"@type":"ImageObject","url":"https://blah.cloud/images/me.jpg"}}}</script>
<script defer data-domain=blah.cloud data-api=/backend/api/event src=/backend/js/script.outbound-links.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script>
</head>
<body id=top>
<script>window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches?(document.body.classList.add('dark'),document.body.classList.remove('light')):(document.body.classList.remove('dark'),document.body.classList.add('light'));const darkModeMediaQuery=window.matchMedia('(prefers-color-scheme: dark)');darkModeMediaQuery.addListener(a=>{const b=a.matches;b?(document.body.classList.add('dark'),document.body.classList.remove('light')):(document.body.classList.remove('dark'),document.body.classList.add('light'))})</script>
<noscript>
<style type=text/css>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(240, 202, 102, 1);--secondary:rgba(216, 214, 197, 1);--tertiary:rgba(128, 130 ,133 , 1);--content:rgba(206, 205, 188, 1);--hljs-bg:#282a36;--code-bg:#282a36;--border:rgba(240, 202, 102, 1)}.list{background:var(--theme)}}</style>
</noscript>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://blah.cloud/ accesskey=h title="Blah, Cloud. (Alt + H)">
<picture>
<source media="(min-width: 768px)" srcset=/images/logo-title.avif type=image/avif alt=logo width=245 height=34>
<source media="(min-width: 768px)" srcset=/images/logo-title.webp type=image/webp alt=logo width=245 height=34>
<source srcset=/images/logo.avif type=image/avif alt=logo width=65 height=65>
<source srcset=/images/logo.webp type=image/webp alt=logo width=65 height=65>
<img src=/images/logo-title.png alt=logo aria-label=logo width=245 height=34>
</picture></a>
</div>
<span class=logo-switches>
</span>
<i class=hamburger><svg xmlns="http://www.w3.org/2000/svg" width="24" height="28" viewBox="0 0 24 28"><path d="M24 21v2c0 .547-.453 1-1 1H1c-.547.0-1-.453-1-1v-2c0-.547.453-1 1-1h22c.547.0 1 .453 1 1zm0-8v2c0 .547-.453 1-1 1H1c-.547.0-1-.453-1-1v-2c0-.547.453-1 1-1h22c.547.0 1 .453 1 1zm0-8v2c0 .547-.453 1-1 1H1c-.547.0-1-.453-1-1V5c0-.547.453-1 1-1h22c.547.0 1 .453 1 1z"/></svg>
</i>
<ul id=menu>
<li>
<a href=https://blah.cloud/blog/ title=blog>
<span>blog</span>
</a>
</li>
<li>
<a href=https://blah.cloud/works/ title=works>
<span>works</span>
</a>
</li>
<li>
<a href=https://blah.cloud/search/ title=" (Alt + /)" accesskey=/>
<span><svg style="height:1em" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="fill-current w-5" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span>
</a>
</li>
</ul>
</nav>
</header>
<div class=container>
<main class=main>
<div class=wrapper>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>
Using Velero for K8s Backup and Restore of CSI Volumes
</h1>
<div class=post-description>
How to backup and restore K8s applications on vSphere
</div>
<div class=post-meta>October 4, 2019&nbsp;·&nbsp;Myles Gray&nbsp;|&nbsp;<a href=https://github.com/mylesagray/blog/blob/master/content/posts/2019-10-04-using-velero-for-k8s-backup-and-restore-of-csi-volumes/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#introduction aria-label=Introduction>Introduction</a></li>
<li>
<a href=#prerequisites aria-label=Prerequisites>Prerequisites</a><ul>
<li>
<a href=#tools aria-label=Tools>Tools</a></li></ul>
</li>
<li>
<a href=#installation-and-use-workflow aria-label="Installation and Use Workflow">Installation and Use Workflow</a></li>
<li>
<a href=#installation aria-label=Installation>Installation</a><ul>
<li>
<a href=#velero-cli aria-label="Velero CLI">Velero CLI</a></li>
<li>
<a href=#installing-minio aria-label="Installing Minio">Installing Minio</a></li>
<li>
<a href=#installing-velero aria-label="Installing Velero">Installing Velero</a></li></ul>
</li>
<li>
<a href=#deploying-a-sample-application aria-label="Deploying a Sample Application">Deploying a Sample Application</a></li>
<li>
<a href=#backup-and-restore-with-velero aria-label="Backup and Restore with Velero">Backup and Restore with Velero</a><ul>
<li>
<a href=#set-up-a-velero-schedule aria-label="Set up a Velero Schedule">Set up a Velero Schedule</a></li>
<li>
<a href=#simulating-a-disaster aria-label="Simulating a disaster">Simulating a disaster</a></li>
<li>
<a href=#restoring-with-velero aria-label="Restoring with Velero">Restoring with Velero</a></li></ul>
</li>
<li>
<a href=#troubleshooting aria-label=Troubleshooting>Troubleshooting</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2>
<p>We&rsquo;ve covered off prepping and installing K8s on this blog a few different ways; with <a href=/kubernetes/creating-an-ubuntu-18-04-lts-cloud-image-for-cloning-on-vmware/>VM templates built manually</a>, with <a href=/infrastructure/using-cloud-init-for-vm-templating-on-vsphere/>cloud-init</a>, and with <a href=/kubernetes/first-look-automated-k8s-lifecycle-with-clusterapi/>ClusterAPI vSphere</a>. Let&rsquo;s say you&rsquo;ve grown attached to some of the workloads you&rsquo;re running on one of your clusters, naturally. It would be nice to backup and restore those should something go wrong - or even, as was my case, I deployed a distro of K8s on my Raspberry Pi cluster that I wasn&rsquo;t wild about and wanted to move to another - how do you migrate those workloads?</p>
<p>Enter <a href=https://velero.io>Velero</a>. Velero (formerly Heptio Ark) is a backup, restore and DR orchestration application for your K8s workloads. In this post i&rsquo;d like to take you through the installation and use of Velero, as well as some test backup and restores so you can kick the tyres on your own clusters and maybe give the team some feedback!</p>
<p>I&rsquo;m assuming you have a K8s cluster up and running with a working storage system. I mean, otherwise you&rsquo;d have nothing to back up. If not - check the blogs mentioned above to get one running.</p>
<p>If you just want to see it running - check out my <a href=https://s3-us-west-1.amazonaws.com/vmworld-usa-2019/HCI2763BU.mp4>VMWorld session</a> and go to 19:30</p>
<h2 id=prerequisites>Prerequisites<a hidden class=anchor aria-hidden=true href=#prerequisites>#</a></h2>
<h3 id=tools>Tools<a hidden class=anchor aria-hidden=true href=#tools>#</a></h3>
<p>I am using macOS, so will be using the <code>brew</code> package manager to install and manage my tools, if you are using Linux or Windows, use the appropriate install guide for each tool, according to your OS.</p>
<p>For each tool I will list the <code>brew</code> install command and the link to the install instructions for other OSes.</p>
<ul>
<li>brew
<ul>
<li><a href=https://brew.sh>https://brew.sh</a></li>
</ul>
</li>
<li>git - <code>brew install git</code>
<ul>
<li><a href=https://git-scm.com>https://git-scm.com</a></li>
</ul>
</li>
<li>helm - <code>brew install kubernetes-helm</code>
<ul>
<li><a href=https://helm.sh>https://helm.sh</a></li>
</ul>
</li>
<li>kubectl - <code>brew install kubernetes-cli</code>
<ul>
<li><a href=https://kubernetes.io/docs/tasks/tools/install-kubectl/>https://kubernetes.io/docs/tasks/tools/install-kubectl/</a></li>
</ul>
</li>
</ul>
<h2 id=installation-and-use-workflow>Installation and Use Workflow<a hidden class=anchor aria-hidden=true href=#installation-and-use-workflow>#</a></h2>
<p>To get Velero running on our cluster there are a few steps we need to run through, at a high level (explaination on these components in a bit):</p>
<ul>
<li>Download and install the Velero CLI to our local machine</li>
<li>Install Minio on our cluster for use as a backup repo</li>
<li>Install Velero on our cluster</li>
</ul>
<h2 id=installation>Installation<a hidden class=anchor aria-hidden=true href=#installation>#</a></h2>
<h3 id=velero-cli>Velero CLI<a hidden class=anchor aria-hidden=true href=#velero-cli>#</a></h3>
<p>The Velero CLI isn&rsquo;t strictly required but it handles a lot of the heavy lifting of creating Velero specific custom resources (CRDs) in K8s that you&rsquo;d have to do manually otherwise, things like backup schedules and all that jazz.</p>
<p>The Velero CLI is pre-compiled and available for download on the <a href=https://github.com/vmware-tanzu/velero/releases>Velero GitHub page</a>, as stated before i&rsquo;m running macOS so i&rsquo;ll download and move the binary into my PATH (adjust this to suit your OS).</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>wget https://github.com/vmware-tanzu/velero/releases/download/v1.1.0/velero-v1.1.0-darwin-amd64.tar.gz
tar -zxvf velero-v1.1.0-darwin-amd64.tar.gz
mv velero-v1.1.0-darwin-amd64/velero /usr/local/bin/.
</code></pre></div><p>As long as <code>/usr/local/bin</code> is in your PATH, you&rsquo;ll be able to now run the CLI:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ velero version
Client:
        Version: v1.1.0
        Git commit: a357f21aec6b39a8244dd23e469cc4519f1fe608
&lt;error getting server version: the server could not find the requested resource <span class=o>(</span>post serverstatusrequests.velero.io<span class=o>)</span>&gt;
</code></pre></div><p>The error is expected as we haven&rsquo;t yet installed Velero into our cluster - but it shows that the CLI is working. An important thing to note is that when using the Velero CLI, it uses the currently active K8s cluster that&rsquo;s in your terminal session.</p>
<h3 id=installing-minio>Installing Minio<a hidden class=anchor aria-hidden=true href=#installing-minio>#</a></h3>
<p>Velero uses S3 API-compatible object storage as its backup location, that means to create a backup we need something that exposes and S3 API. Minio is a small, easy to deploy S3 object store you can run on-prem.</p>
<p>For this example, we&rsquo;re going to run Minio on our K8s cluster, in production you&rsquo;d want your S3 store somewhere else, for reasons that should be obvious.</p>
<p>To install Minio we&rsquo;re going to use <a href=http://helm.sh>helm</a> which is a package manager for K8s - this simplifies the installation down to creating a <code>yaml</code> file for the configuration.</p>
<p>Let&rsquo;s create the <code>yaml</code> file for the setup of Minio with helm (a full list of variables can be found on the chart page <a href=https://github.com/helm/charts/tree/master/stable/minio>in the repo</a>):</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=l>$ cat minio.yaml</span><span class=w>
</span><span class=w></span><span class=nt>image</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>latest</span><span class=w>
</span><span class=w></span><span class=nt>accessKey</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;minio&#34;</span><span class=w>
</span><span class=w></span><span class=nt>secretKey</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;minio123&#34;</span><span class=w>
</span><span class=w></span><span class=nt>service</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>LoadBalancer</span><span class=w>
</span><span class=w></span><span class=nt>defaultBucket</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>velero</span><span class=w>
</span><span class=w></span><span class=nt>persistence</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>size</span><span class=p>:</span><span class=w> </span><span class=l>50G</span><span class=w>
</span></code></pre></div><p>Stepping through this, it will deploy the latest version of Minio available, set the username and password to <code>minio</code> and <code>minio123</code> respectively, expose the service using a <code>LoadBalancer</code> (consequently, you&rsquo;ll need a <code>LoadBalancer</code> of some kind in your cluster - I recommend <a href=http://metallb.universe.tf>MetalLB</a> for labs). Next up, we tell it to automatically create a bucket called <code>velero</code> and to persist the data in a 50GB volume.</p>
<p>Ideally, instead of using Service Type <code>LoadBalancer</code> - you&rsquo;d use an <code>Ingress Controller</code> like <a href=https://traefik.io>Traefik</a> or <a href=https://github.com/kubernetes/ingress-nginx>NginX</a>, but that&rsquo;s the subject for another blog post - an LB will do for a proof of concept.</p>
<p>I&rsquo;m assuming you have the file saved as <code>minio.yaml</code> - so let&rsquo;s now use helm to deploy this to our cluster.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>helm install stable/minio --name minio --namespace infra -f minio.yaml
</code></pre></div><p>This installs Minio to your cluster, in a namespace called <code>infra</code> and the helm deployment is given a name of <code>minio</code> (otherwise you&rsquo;ll get a randomly allocated name).</p>
<p>If we run the following, we&rsquo;ll get the IP and Port that Minio will be accessible on outside the cluster - in my case the IP is <code>10.198.26.3</code> and is accessible on port <code>9000</code>:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ kubectl get service minio -n infra
NAME    TYPE           CLUSTER-IP      EXTERNAL-IP   PORT<span class=o>(</span>S<span class=o>)</span>          AGE
minio   LoadBalancer   10.110.94.210   10.198.26.3   9000:32549/TCP   127m
</code></pre></div><p>If you substitute your own details into the below and login using <code>minio</code> and <code>minio123</code> you&rsquo;ll see the Minio UI with the Velero bucket present.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>open http://10.198.26.3:9000
</code></pre></div><p><em>Ta-da</em>, an S3 compliant object store, running on K8s.</p>
<p><picture>
<source srcset=images/minio.avif type=image/avif>
<source srcset=images/minio.webp type=image/webp>
<img src=images/minio.png alt=Minio loading=lazy decoding=async>
</picture></p>
<h3 id=installing-velero>Installing Velero<a hidden class=anchor aria-hidden=true href=#installing-velero>#</a></h3>
<p>Velero can be installed either via a <code>helm</code> chart or via the Velero CLI, my preferred method is to use the <code>helm</code> chart as it means I can store the configuration in a <code>yaml</code> file and deploy it repeatably without having to memorise commands.</p>
<p>If you want to deploy via the CLI, see the <a href=https://velero.io/docs/v1.1.0/>Velero documentation</a>, we are going to use <code>helm</code> here.</p>
<p>Again, as with the Minio chart, the first step is to create the configuration <code>yaml</code> file:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=l>$ cat velero.yaml</span><span class=w>
</span><span class=w></span><span class=nt>image</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>v1.1.0</span><span class=w>
</span><span class=w></span><span class=nt>configuration</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>provider</span><span class=p>:</span><span class=w> </span><span class=l>aws</span><span class=w>
</span><span class=w>  </span><span class=nt>backupStorageLocation</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>aws</span><span class=w>
</span><span class=w>    </span><span class=nt>bucket</span><span class=p>:</span><span class=w> </span><span class=l>velero</span><span class=w>
</span><span class=w>    </span><span class=nt>config</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>region</span><span class=p>:</span><span class=w> </span><span class=l>minio</span><span class=w>
</span><span class=w>      </span><span class=nt>s3ForcePathStyle</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>      </span><span class=nt>publicUrl</span><span class=p>:</span><span class=w> </span><span class=l>http://10.198.26.3:9000</span><span class=w>
</span><span class=w>      </span><span class=nt>s3Url</span><span class=p>:</span><span class=w> </span><span class=l>http://minio.infra.svc:9000</span><span class=w>
</span><span class=w></span><span class=nt>credentials</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>useSecret</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>  </span><span class=nt>secretContents</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>cloud</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span><span class=sd>      [default]
</span><span class=sd>      aws_access_key_id = minio
</span><span class=sd>      aws_secret_access_key = minio123</span><span class=w>      
</span><span class=w></span><span class=nt>snapshotsEnabled</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span><span class=w></span><span class=nt>configMaps</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>restic-restore-action-config</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>velero.io/plugin-config</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span><span class=w>      </span><span class=nt>velero.io/restic</span><span class=p>:</span><span class=w> </span><span class=l>RestoreItemAction</span><span class=w>
</span><span class=w>    </span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>gcr.io/heptio-images/velero-restic-restore-helper:v1.1.0</span><span class=w>
</span><span class=w></span><span class=nt>deployRestic</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></code></pre></div><p>So, it may look a little strange with the provider type <code>aws</code> and such, but that is simply there to allow us to use the S3 backup target - notice that we just use the IP address and port of the Minio service we deployed in the previous step as the URL to send the backups to.</p>
<p>One thing i&rsquo;d like to call out is the difference between <code>publicUrl</code> and <code>s3Url</code> - <code>publicUrl</code> is what the Velero CLI will communicate with when it needs to get things like logs and such, the <code>s3Url</code> is what the Velero in-cluster process sends the data and logs to. In this case <code>s3Url</code> is not publically accessible, it uses a Kubernetes in-cluster DNS record (<code>minio.infra.svc:9000</code>) - this says, send the data to service <code>minio</code> in namespace <code>infra</code> and of type <code>service</code> on port <code>9000</code>.</p>
<p>Because the <code>s3Url</code> is only resolvable within the K8s cluster, we must also specify the <code>publicUrl</code> to allow the CLI to also interface with the assets in that object store.</p>
<p>The last line may be something you&rsquo;re wondering about - <code>deployRestic</code> tells Velero to deploy the <a href=https://restic.net><code>restic</code></a> data mover to pull bits off the disk from inside the cluster, rather than relying on native snapshotting and diff capabilities and is required for vSphere installations.</p>
<p>With all that said, once you&rsquo;ve adjusted the above to suit your environment (likely just <code>publicUrl</code> and <code>s3Url</code>) you can deploy the helm chart.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>helm install stable/velero --name velero --namespace velero -f velero.yaml
</code></pre></div><p>With Velero deployed to our cluster, we can now get to creating some backup schedules and test how it all works.</p>
<h2 id=deploying-a-sample-application>Deploying a Sample Application<a hidden class=anchor aria-hidden=true href=#deploying-a-sample-application>#</a></h2>
<p>As of Velero v1.1.0, CSI volumes are supported, meaning we can backup the contents of PVs on kubernetes clusters running CSI plugins, as well as the manifests that make up that app.</p>
<p>To test this out, let&rsquo;s deploy an app - a Slack clone i&rsquo;m awfully fond of called <a href=https://rocket.chat>RocketChat</a> - as usual, we&rsquo;ll create the config <code>yaml</code> file first:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=l>$ cat rocketchat.yaml</span><span class=w>
</span><span class=w></span><span class=nt>persistence</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w></span><span class=nt>service</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>LoadBalancer</span><span class=w>
</span><span class=w></span><span class=nt>mongodb</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>mongodbPassword</span><span class=p>:</span><span class=w> </span><span class=l>password</span><span class=w>
</span><span class=w>  </span><span class=nt>mongodbRootPassword</span><span class=p>:</span><span class=w> </span><span class=l>password</span><span class=w>
</span></code></pre></div><p>This will deploy RocketChat (which uses MongoDB as a database) to our cluster and expose it using another <code>LoadBalancer</code> IP - again, ideally this would be done using an <code>Ingress Controller</code> instead, but for simplicity - we&rsquo;ll do it this way.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>helm install stable/rocketchat --name rocketchat --namespace rocketchat -f rocketchat.yaml
</code></pre></div><p>If you watch the pods as this comes up, you should see the arbiter, the primary and then the secondary MongoDB nodes come up, following that - the RocketChat app itself will come up and at that point, will be accessible within the browser:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>kubectl get pod -n rocketchat -w
</code></pre></div><p>Once all the pods show <code>Running</code> and <code>1/1</code> - we can grab the LoadBalancer IP and port and access the app:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ kubectl get svc -n rocketchat
NAME                          TYPE           CLUSTER-IP      EXTERNAL-IP   PORT<span class=o>(</span>S<span class=o>)</span>        AGE
rocketchat-mongodb            ClusterIP      10.102.96.222   &lt;none&gt;        27017/TCP      3m34s
rocketchat-mongodb-headless   ClusterIP      None            &lt;none&gt;        27017/TCP      3m34s
rocketchat-rocketchat         LoadBalancer   10.106.105.16   10.198.26.4   80:30904/TCP   3m34s
</code></pre></div><p>So, to access this service, as with Minio - sub in your own IP into the following:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>open http://10.198.26.4
</code></pre></div><p>Go through the motions of creating a user account with whatever name and password you like until you get to the main page:</p>
<p><picture>
<source srcset=images/rocketchat.avif type=image/avif>
<source srcset=images/rocketchat.webp type=image/webp>
<img src=images/rocketchat.png alt=RocketChat loading=lazy decoding=async>
</picture></p>
<p>Navigate to the <code>#general</code> channel and upload something or type in some text - this will be the data we want to protect with Velero!</p>
<p><picture>
<source srcset=images/data.avif type=image/avif>
<source srcset=images/data.webp type=image/webp>
<img src=images/data.png alt="RocketChat Contents" loading=lazy decoding=async>
</picture></p>
<p>Now, we can&rsquo;t have that data going missing - i&rsquo;m sure you&rsquo;ll agree, so let&rsquo;s back it up with Velero!</p>
<h2 id=backup-and-restore-with-velero>Backup and Restore with Velero<a hidden class=anchor aria-hidden=true href=#backup-and-restore-with-velero>#</a></h2>
<p>Now that we have an application, and data we want to protect - let&rsquo;s tag the <code>PersistentVolumes</code> so Velero will back them up. First - we need to find out what the volumes are called:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ kubectl get pvc -n rocketchat
NAME                                     STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS      AGE
datadir-rocketchat-mongodb-primary-0     Bound    pvc-dda3e972-e5fa-11e9-a30e-00505691513e   8Gi        RWO            space-efficient   23m
datadir-rocketchat-mongodb-secondary-0   Bound    pvc-ddb17d70-e5fa-11e9-a30e-00505691513e   8Gi        RWO            space-efficient   23m
rocketchat-rocketchat                    Bound    pvc-dd633f78-e5fa-11e9-a30e-00505691513e   8Gi        RWO            space-efficient   23m
</code></pre></div><p>The first word in the name of each PVC, is the name of the volume - so <code>datadir</code> and <code>rocketchat</code>. Let&rsquo;s tell Velero to backup those <code>datadir</code> volumes by tagging the pods.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ kubectl annotate pod -n rocketchat --selector<span class=o>=</span><span class=nv>release</span><span class=o>=</span>rocketchat,app<span class=o>=</span>mongodb backup.velero.io/backup-volumes<span class=o>=</span>datadir --overwrite
pod/rocketchat-mongodb-arbiter-0 annotated
pod/rocketchat-mongodb-primary-0 annotated
pod/rocketchat-mongodb-secondary-0 annotated
</code></pre></div><p>The above command looks for all pods in the <code>rocketchat</code> namespace with the tags <code>release=rocketchat</code> and <code>app=mongodb</code> and annotates them with a label <code>backup.velero.io/backup-volumes=datadir</code> - this tells Velero to backup the Persistent Volumes that are consumed with the name <code>datadir</code>.</p>
<h3 id=set-up-a-velero-schedule>Set up a Velero Schedule<a hidden class=anchor aria-hidden=true href=#set-up-a-velero-schedule>#</a></h3>
<p>Now that our app is set up to request Velero backups - let&rsquo;s schedule some - in the below example, we are asking for a backup to be taken every hour and for them to be held for 24 hours each.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>velero schedule create hourly --schedule<span class=o>=</span><span class=s2>&#34;@every 1h&#34;</span> --ttl 24h0m0s
</code></pre></div><p>Let&rsquo;s create another that runs daily and retains the backups for 7 days:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>velero schedule create daily --schedule<span class=o>=</span><span class=s2>&#34;@every 24h&#34;</span> --ttl 168h0m0s
</code></pre></div><p>If we query Velero, we can now see what schedules are set up:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ velero get schedules
NAME     STATUS    CREATED                         SCHEDULE     BACKUP TTL   LAST BACKUP   SELECTOR
daily    Enabled   2019-10-03 17:57:43 +0100 BST   @every 24h   168h0m0s     23s ago       &lt;none&gt;
hourly   Enabled   2019-10-03 17:56:20 +0100 BST   @every 1h    24h0m0s      1m ago        &lt;none&gt;
</code></pre></div><p>Additionally, we can see they&rsquo;ve already taken a backup each, we can query those backups with the following command:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ velero get backups 
NAME                    STATUS      CREATED                         EXPIRES   STORAGE LOCATION   SELECTOR
daily-20191003165757    Completed   2019-10-03 17:58:33 +0100 BST   6d        default            &lt;none&gt;
hourly-20191003165634   Completed   2019-10-03 17:56:34 +0100 BST   23h       default            &lt;none&gt;
</code></pre></div><p>If we wanted to take an ad-hoc backup that can be achieved through the following (in this case, we will only backup the <code>rocketchat</code> namespace):</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ velero backup create before-disaster --include-namespaces rocketchat
Backup request <span class=s2>&#34;before-disaster&#34;</span> submitted successfully.
Run <span class=sb>`</span>velero backup describe before-disaster<span class=sb>`</span> or <span class=sb>`</span>velero backup logs before-disaster<span class=sb>`</span> <span class=k>for</span> more details.
</code></pre></div><p>As the command says - we can query progress with the following:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>velero backup describe before-disaster --details
</code></pre></div><p>Adding the <code>--details</code> option will show us the <code>restic</code> backup status of the persistent volumes at the very bottom:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>Restic Backups:
  Completed:
    rocketchat/rocketchat-mongodb-primary-0: datadir
    rocketchat/rocketchat-mongodb-secondary-0: datadir
</code></pre></div><p>And now if we go to Minio, in the velero bucket you will see the backups and their contents (they are all encrypted on disk by default):</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>open http://10.198.26.3:9000/minio/velero/backups/before-disaster/
</code></pre></div><p><picture>
<source srcset=images/minio-data.avif type=image/avif>
<source srcset=images/minio-data.webp type=image/webp>
<img src=images/minio-data.png alt="Data in Minio" loading=lazy decoding=async>
</picture></p>
<h3 id=simulating-a-disaster>Simulating a disaster<a hidden class=anchor aria-hidden=true href=#simulating-a-disaster>#</a></h3>
<p>Now that we have a backup and some scheduled backups, let&rsquo;s delete the rocketchat app - and all it&rsquo;s data off disk and restore it using Velero.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>helm delete --purge rocketchat
</code></pre></div><p>This will delete the RocketChat app - but because MongoDB uses a <code>StatefulSet</code>, the data volumes will stick around - as you can see from the CNS UI:</p>
<p><picture>
<source srcset=images/cns-ui.avif type=image/avif>
<source srcset=images/cns-ui.webp type=image/webp>
<img src=images/cns-ui.png alt="CNS Volumes" loading=lazy decoding=async>
</picture></p>
<p>We can delete these PVs by deleting the namespace too:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>kubectl delete ns rocketchat
</code></pre></div><p>So, now all our data is truely gone - as evidenced by the CNS UI no longer showing any volumes for the <code>rocketchat</code> filter:</p>
<p><picture>
<source srcset=images/cns-ui-empty.avif type=image/avif>
<source srcset=images/cns-ui-empty.webp type=image/webp>
<img src=images/cns-ui-empty.png alt="CNS UI Empty" loading=lazy decoding=async>
</picture></p>
<h3 id=restoring-with-velero>Restoring with Velero<a hidden class=anchor aria-hidden=true href=#restoring-with-velero>#</a></h3>
<p>Our app is dead, and the data is gone - so it&rsquo;s time to restore it from one of the backups we took - i&rsquo;ll use the ad-hoc one for ease of naming:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ velero restore create --from-backup before-disaster --include-namespaces rocketchat
Restore request <span class=s2>&#34;before-disaster-20191003181320&#34;</span> submitted successfully.
Run <span class=sb>`</span>velero restore describe before-disaster-20191003181320<span class=sb>`</span> or <span class=sb>`</span>velero restore logs before-disaster-20191003181320<span class=sb>`</span> <span class=k>for</span> more details.
</code></pre></div><p>Again - let&rsquo;s monitor it with the command from above:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>velero restore describe before-disaster-20191003181320 --details
</code></pre></div><p>Once the output of the command shows completed and the Restic Restores at the bottom are done, like below, we can check on our app:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>Name:         before-disaster-20191003181320
Namespace:    velero
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;

Phase:  Completed

Backup:  before-disaster

Namespaces:
  Included:  rocketchat
  Excluded:  &lt;none&gt;

Resources:
  Included:        *
  Excluded:        nodes, events, events.events.k8s.io, backups.velero.io, restores.velero.io, resticrepositories.velero.io
  Cluster-scoped:  auto

Namespace mappings:  &lt;none&gt;

Label selector:  &lt;none&gt;

Restore PVs:  auto

Restic Restores:
  Completed:
    rocketchat/rocketchat-mongodb-primary-0: datadir
    rocketchat/rocketchat-mongodb-secondary-0: datadir
</code></pre></div><p>Let&rsquo;s see if the pods are back up and running, and our PVCs are restored in our namespace:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>$ kubectl get po,pvc -n rocketchat
NAME                                         READY   STATUS    RESTARTS   AGE
pod/rocketchat-mongodb-arbiter-0             1/1     Running   <span class=m>0</span>          3m5s
pod/rocketchat-mongodb-primary-0             1/1     Running   <span class=m>0</span>          3m5s
pod/rocketchat-mongodb-secondary-0           1/1     Running   <span class=m>0</span>          3m5s
pod/rocketchat-rocketchat-7bdf95cb47-86q9t   1/1     Running   <span class=m>0</span>          3m4s

NAME                                                           STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS      AGE
persistentvolumeclaim/datadir-rocketchat-mongodb-primary-0     Bound    pvc-1d90d0d7-e601-11e9-a30e-00505691513e   8Gi        RWO            space-efficient   3m5s
persistentvolumeclaim/datadir-rocketchat-mongodb-secondary-0   Bound    pvc-1d95abc7-e601-11e9-a30e-00505691513e   8Gi        RWO            space-efficient   3m5s
persistentvolumeclaim/rocketchat-rocketchat                    Bound    pvc-1d99ea27-e601-11e9-a30e-00505691513e   8Gi        RWO            space-efficient   3m5s
</code></pre></div><p>In the CNS UI - we&rsquo;ll see the volumes again present - this time with some extra <code>velero</code> labels against them:</p>
<p><picture>
<source srcset=images/cns-ui-post-restore.avif type=image/avif>
<source srcset=images/cns-ui-post-restore.webp type=image/webp>
<img src=images/cns-ui-post-restore.png alt="CNS UI Post Restore" loading=lazy decoding=async>
</picture></p>
<p>And our app should once be again accessible and our data safe:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>open http://10.198.26.4
</code></pre></div><p><picture>
<source srcset=images/rocketchat-post-restore.avif type=image/avif>
<source srcset=images/rocketchat-post-restore.webp type=image/webp>
<img src=images/rocketchat-post-restore.png alt="RocketChat Post Restore" loading=lazy decoding=async>
</picture></p>
<h2 id=troubleshooting>Troubleshooting<a hidden class=anchor aria-hidden=true href=#troubleshooting>#</a></h2>
<p>A tip on troubleshooting Velero backups - make liberal use of the <code>logs</code> command:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash>velero restore logs before-disaster-20191003181320
</code></pre></div><p>This is where the <code>publicUrl</code> section from the very start matters - if you don&rsquo;t have that populated, your logs won&rsquo;t get displayed to you, so if you&rsquo;re experiencing that, make sure you&rsquo;ve defined that parameter.</p>
<p>The logs have a trove of information in them, so if Restic is having trouble pulling data from a volume or such, all that info is in there!</p>
<p>This brings us to the end of our look at Velero on vSphere - and in particular the integration with CSI. If you have feedback for the Velero team - please reach out on <a href=https://github.com/vmware-tanzu/velero/issues>GitHub</a> and file some issues, whether is enhancements, bugs - or if you just need help. Stay tuned for more K8s goodness in the near future!</p>
<p>Why not follow <a href=https://twitter.com/mylesagray>@mylesagray on Twitter</a> for more like this!</p>
</div>
<footer class=post-footer>
<section class="section post-tags">
<div class=content>
<h2>Tagged with</h2>
</div>
<ul class=post-tags>
<li><a href=https://blah.cloud/tags/backup/>backup</a></li>
<li><a href=https://blah.cloud/tags/kubernetes/>Kubernetes</a></li>
<li><a href=https://blah.cloud/tags/vsphere/>vSphere</a></li>
<li><a href=https://blah.cloud/tags/velero/>velero</a></li>
<li><a href=https://blah.cloud/tags/heptio-ark/>heptio ark</a></li>
<li><a href=https://blah.cloud/tags/persistent-volumes/>persistent volumes</a></li>
</ul>
</section>
<nav class=paginav>
<a class=prev href=https://blah.cloud/kubernetes/clusterapi-for-vsphere-now-with-cns-support/>
<span class=title>« Prev Page</span>
<br>
<span>ClusterAPI for vSphere, now with CNS support</span>
</a>
<a class=next href=https://blah.cloud/kubernetes/first-look-automated-k8s-lifecycle-with-clusterapi/>
<span class=title>Next Page »</span>
<br>
<span>First-look: Automated K8s lifecycle with ClusterAPI</span>
</a>
</nav>
<section class="section related-links">
<div class="columns is-centered">
<div class="column max-800px">
<div class=content>
<h2>Related content</h2>
</div>
<div class="columns related-links-columns">
<div class="column is-one-third">
<div class=card>
<div class=card-image>
<figure class="image is-3by2">
<a href=/kubernetes/clusterapi-for-vsphere-now-with-cns-support/>
<picture>
<source srcset=/kubernetes/clusterapi-for-vsphere-now-with-cns-support/images/cns-vols.avif type=image/avif>
<source srcset=/kubernetes/clusterapi-for-vsphere-now-with-cns-support/images/cns-vols.webp type=image/webp>
<img src=/kubernetes/clusterapi-for-vsphere-now-with-cns-support/images/cns-vols_hubb99a5d454ccc2a3521f9450fb7bc52e_44991_240x0_resize_box_3.png alt="CNS Volume List" loading=lazy decoding=async>
</picture>
</a>
</figure>
</div>
<div class=card-content>
<a class="title is-5" href=https://blah.cloud/kubernetes/clusterapi-for-vsphere-now-with-cns-support/>ClusterAPI for vSphere, now with CNS support</a>
</div>
</div>
</div>
<div class="column is-one-third">
<div class=card>
<div class=card-image>
<figure class="image is-3by2">
<a href=/kubernetes/using-the-vsphere-cloud-provider-for-k8s-to-dynamically-deploy-volumes/>
<picture>
<source srcset=/kubernetes/using-the-vsphere-cloud-provider-for-k8s-to-dynamically-deploy-volumes/images/Screenshot-2019-01-27-13.42.27.avif type=image/avif>
<source srcset=/kubernetes/using-the-vsphere-cloud-provider-for-k8s-to-dynamically-deploy-volumes/images/Screenshot-2019-01-27-13.42.27.webp type=image/webp>
<img src=/kubernetes/using-the-vsphere-cloud-provider-for-k8s-to-dynamically-deploy-volumes/images/Screenshot-2019-01-27-13.42.27_hu2ec1301ff71ca12bc99cd007b161b1f9_59124_240x0_resize_box_3.png alt="K8s Dashboard" loading=lazy decoding=async>
</picture>
</a>
</figure>
</div>
<div class=card-content>
<a class="title is-5" href=https://blah.cloud/kubernetes/using-the-vsphere-cloud-provider-for-k8s-to-dynamically-deploy-volumes/>Using the vSphere Cloud Provider for K8s to dynamically deploy volumes</a>
</div>
</div>
</div>
<div class="column is-one-third">
<div class=card>
<div class=card-image>
<figure class="image is-3by2">
<a href=/kubernetes/first-look-automated-k8s-lifecycle-with-clusterapi/>
<picture>
<source srcset=/kubernetes/first-look-automated-k8s-lifecycle-with-clusterapi/images/capv-vcenter.avif type=image/avif>
<source srcset=/kubernetes/first-look-automated-k8s-lifecycle-with-clusterapi/images/capv-vcenter.webp type=image/webp>
<img src=/kubernetes/first-look-automated-k8s-lifecycle-with-clusterapi/images/capv-vcenter_hu1925b6bcee541cea5cf06c312bff99e1_56635_240x0_resize_box_3.png alt="K8s cluster running on vSphere" loading=lazy decoding=async>
</picture>
</a>
</figure>
</div>
<div class=card-content>
<a class="title is-5" href=https://blah.cloud/kubernetes/first-look-automated-k8s-lifecycle-with-clusterapi/>First-look: Automated K8s lifecycle with ClusterAPI</a>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section class="section share-icons">
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share Using Velero for K8s Backup and Restore of CSI Volumes on twitter" href="https://twitter.com/intent/tweet/?text=Using%20Velero%20for%20K8s%20Backup%20and%20Restore%20of%20CSI%20Volumes&url=https%3a%2f%2fblah.cloud%2fautomation%2fusing-velero-for-k8s-backup-and-restore-of-csi-volumes%2f&hashtags=backup%2cKubernetes%2cvSphere%2cvelero%2cheptioark%2cpersistentvolumes"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Using Velero for K8s Backup and Restore of CSI Volumes on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fblah.cloud%2fautomation%2fusing-velero-for-k8s-backup-and-restore-of-csi-volumes%2f&title=Using%20Velero%20for%20K8s%20Backup%20and%20Restore%20of%20CSI%20Volumes"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Using Velero for K8s Backup and Restore of CSI Volumes on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblah.cloud%2fautomation%2fusing-velero-for-k8s-backup-and-restore-of-csi-volumes%2f&title=Using%20Velero%20for%20K8s%20Backup%20and%20Restore%20of%20CSI%20Volumes&summary=Using%20Velero%20for%20K8s%20Backup%20and%20Restore%20of%20CSI%20Volumes&source=https%3a%2f%2fblah.cloud%2fautomation%2fusing-velero-for-k8s-backup-and-restore-of-csi-volumes%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
</div>
</section>
</footer>
<script src=https://utteranc.es/client.js repo=mylesagray/blog-comments issue-term=title theme=preferred-color-scheme crossorigin=anonymous async></script>
</article>
<aside class="hidden lg:block tableOfContentContainer" id=tableOfContentContainer>
<nav id=TableOfContents>
<ul>
<li><a href=#introduction>Introduction</a></li>
<li><a href=#prerequisites>Prerequisites</a>
<ul>
<li><a href=#tools>Tools</a></li>
</ul>
</li>
<li><a href=#installation-and-use-workflow>Installation and Use Workflow</a></li>
<li><a href=#installation>Installation</a>
<ul>
<li><a href=#velero-cli>Velero CLI</a></li>
<li><a href=#installing-minio>Installing Minio</a></li>
<li><a href=#installing-velero>Installing Velero</a></li>
</ul>
</li>
<li><a href=#deploying-a-sample-application>Deploying a Sample Application</a></li>
<li><a href=#backup-and-restore-with-velero>Backup and Restore with Velero</a>
<ul>
<li><a href=#set-up-a-velero-schedule>Set up a Velero Schedule</a></li>
<li><a href=#simulating-a-disaster>Simulating a disaster</a></li>
<li><a href=#restoring-with-velero>Restoring with Velero</a></li>
</ul>
</li>
<li><a href=#troubleshooting>Troubleshooting</a></li>
</ul>
</nav>
</aside>
</div>
</main>
</div>
<footer class=footer>
<span>&copy; 2021 <a href=https://blah.cloud/>Blah, Cloud</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>