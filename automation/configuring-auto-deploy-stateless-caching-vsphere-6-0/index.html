<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Configuring Auto Deploy Stateless Caching in vSphere 6.0 | Blah, Cloud</title>
<meta name=keywords content="autodeploy,automation,esxi,pxe,vsphere">
<meta name=description content="Following on from my previous post on configuring custom ESXi images for PXE deployment, it piqued my interest again in Auto Deploy, now that I have a lab large enough (enough physical failure domains) to justify auto-deploy I figured i&rsquo;d give it another go. I have chosen to implement stateless caching as it will allow the hosts to boot from the last used ESXi image they had if the PxE/AutoDeploy server goes down - then when it comes back up will pull the new version, this accounts for a total infrastructure outage and still allows the hosts to be bootable.">
<meta name=author content="Myles Gray">
<link rel=canonical href=https://blah.cloud/automation/configuring-auto-deploy-stateless-caching-vsphere-6-0/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.e38a41c5e7d4d3ea02d394ee536b3395f1cb27bd5a9162de1e375c7d2d1bc8f0.css integrity="sha256-44pBxefU0+oC05TuU2szlfHLJ71akWLeHjdcfS0byPA=" rel="preload stylesheet" as=style>
<link rel=preload href=/images/logo-title.png as=image>
<link rel=icon href=https://blah.cloud/images/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://blah.cloud/images/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://blah.cloud/images/favicon-32x32.png>
<link rel=apple-touch-icon href=https://blah.cloud/images/apple-touch-icon.png>
<link rel=mask-icon href=https://blah.cloud/images/logo.png>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.88.1">
<meta property="og:title" content="Configuring Auto Deploy Stateless Caching in vSphere 6.0">
<meta property="og:description" content="Following on from my previous post on configuring custom ESXi images for PXE deployment, it piqued my interest again in Auto Deploy, now that I have a lab large enough (enough physical failure domains) to justify auto-deploy I figured i&rsquo;d give it another go. I have chosen to implement stateless caching as it will allow the hosts to boot from the last used ESXi image they had if the PxE/AutoDeploy server goes down - then when it comes back up will pull the new version, this accounts for a total infrastructure outage and still allows the hosts to be bootable.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blah.cloud/automation/configuring-auto-deploy-stateless-caching-vsphere-6-0/">
<meta property="og:image" content="https://blah.cloud/images/Screen-Shot-2016-08-19-at-22.39.12.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2016-08-19T21:53:33+00:00">
<meta property="article:modified_time" content="2016-08-19T21:53:33+00:00"><meta property="og:site_name" content="Blah, Cloud">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://blah.cloud/images/Screen-Shot-2016-08-19-at-22.39.12.png">
<meta name=twitter:title content="Configuring Auto Deploy Stateless Caching in vSphere 6.0">
<meta name=twitter:description content="Following on from my previous post on configuring custom ESXi images for PXE deployment, it piqued my interest again in Auto Deploy, now that I have a lab large enough (enough physical failure domains) to justify auto-deploy I figured i&rsquo;d give it another go. I have chosen to implement stateless caching as it will allow the hosts to boot from the last used ESXi image they had if the PxE/AutoDeploy server goes down - then when it comes back up will pull the new version, this accounts for a total infrastructure outage and still allows the hosts to be bootable.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Configuring Auto Deploy Stateless Caching in vSphere 6.0","item":"https://blah.cloud/automation/configuring-auto-deploy-stateless-caching-vsphere-6-0/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Configuring Auto Deploy Stateless Caching in vSphere 6.0","name":"Configuring Auto Deploy Stateless Caching in vSphere 6.0","description":"Following on from my previous post on configuring custom ESXi images for PXE deployment, it piqued my interest again in Auto Deploy, now that I have a lab large enough (enough physical failure domains) to justify auto-deploy I figured i\u0026rsquo;d give it another go. I have chosen to implement stateless caching as it will allow the hosts to boot from the last used ESXi image they had if the PxE/AutoDeploy server goes down - then when it comes back up will pull the new version, this accounts for a total infrastructure outage and still allows the hosts to be bootable.","keywords":["autodeploy","automation","esxi","pxe","vsphere"],"articleBody":"Following on from my previous post on configuring custom ESXi images for PXE deployment, it piqued my interest again in Auto Deploy, now that I have a lab large enough (enough physical failure domains) to justify auto-deploy I figured i’d give it another go. I have chosen to implement stateless caching as it will allow the hosts to boot from the last used ESXi image they had if the PxE/AutoDeploy server goes down - then when it comes back up will pull the new version, this accounts for a total infrastructure outage and still allows the hosts to be bootable.\nSo to start off with, i’m assuming you’re using the vCenter Server Appliance and not a Windows based VC and you’re on vCenter 6.0.\nLet’s go and start the Auto Deploy service on the vCenter Web UI, you’re going to need to log in with a user with @vsphere.local/SSO permissions and navigate to Administration - System Configuration - Services - Auto Deploy and click the Actions dropdown and Edit Startup Type and change to Automatic:\n \nNow back into the Action menu and click Start. Now that the Auto Deploy service is started and set to start on every boot, we’re ready to configure the service itself, to view the current config we need to move to Home - Hosts and Clusters click your vCenter and click Manage - Settings - Auto Deploy and it should look similar to below:\n \nClick the link to Download TFTP Boot File Zip and extract - copy these files to the root of your PxE server tftpboot folder with FileZilla/your SFTP client of choice.\nNow we need to configure our DHCP server to hand out options codes to tell clients where the TFTP server is and what the boot file is called:\n 66 - next-server - IP address of the PxE server that you have previously spun up and copied the TFTP Boot File Zip contents to. 67 - filename - In above picture BIOS DHCP File Name  I have covered setting up DHCP options previously on a Fortigate and there are plenty of guides out there for doing this on Linux/Windows so trust in your Google-fu. I’m just going to show you what my finished DHCP config looks like on a Fortigate (note next-server and filename):\nconfig system dhcp server edit 2 set dns-service default set ntp-service default set default-gateway 10.0.3.1 set netmask 255.255.255.0 set interface \"MGMT\" config ip-range edit 1 set start-ip 10.0.3.2 set end-ip 10.0.3.100 next end set timezone-option default set next-server 10.0.3.189 set filename \"undionly.kpxe.vmw-hardwired\" next end Now we should be in a position to boot the hosts and have them pick up the iPxE boot environment that we pushed to it earlier, however, at this stage it shouldn’t run ESXi as we haven’t created any Auto Deploy Rules or created an active Auto Deploy Rule Set.\nFor purposes of demonstration I’ve spun up some VMs in my lab with no OS to PXE boot - when you power on the hosts at this stage, you should see the below screen, if you don’t you likely have a DHCP option problem or permissions problem on your tftpboot folder and it can’t be read by world.\n \nSo once you’re seeing the above we are good to build up our Auto Deploy rule set - you’ll need PowerCLI installed as there is no native UI for building Auto Deploy Rules (yet…).\nOpen up PowerCLI, connect to the vCenter server that has the Auto Deploy service running and we will import an offline ESXi bundle to deploy our selected version of ESXi - if you want to create a customised image profile with particular VIBs pre-installed, check my article on that here.\nConnect-VIServer vc01.lab.mylesgray.io Add-ESXSoftwareDepot E:\\DL\\update-from-esxi6.0-6.0_update02.zip Now we can get the Name field of the image profiles included\nGet-ESXImageProfile | fl For this demo i’m going to use the latest image profile that includes VMware Tools ESXi-6.0.0-20160302001-standard - let’s create our first Auto Deploy Rule (you can create other more specific ones based on the patterns here if you like and add them to the rule set):\nNew-DeployRule -Name \"InitialBootRule\" -Item \"ESXi-6.0.0-20160302001-standard\" -AllHosts This will kick off an upload of the image profile to the vCenter Server for provisioning to the hosts:\n \nSo all this has done is created the rule, it’s not in the active rule set yet, so won’t apply to any booting hosts, we need to add the rule to part of the active rule set for it to apply to hosts:\nAdd-DeployRule -DeployRule \"InitialBootRule\" And we can run Get-DeployRuleSet to ensure the rules are part of the active set, if successful we should se it listed as so:\nPowerCLI C:\\Program Files (x86)\\VMware\\Infrastructure\\vSphere PowerCLI Get-DeployRuleSet Name : InitialBootRule PatternList : ItemList : {ESXi-6.0.0-20160301001s-standard} Now as the host reboots we can see it boot the hypervisor from AutoDeploy:\n \nSo the host now boots into ESXi and joins vCenter, but is completely unconfigured and not very useful, the whole purpose of automating something like this is to for example, auto scale and IaaS cluster - especially one where the public can spin up VMs on demand.\nWith that in mind, let’s build a host profile to get some standardised config on the go - I’ve set up the first host manually with some generic stuff (NTP, Power Profile, Keyboard type, etc) and have extracted the host profile (deselecting anything irrelevant) then, attached the Host Profile to the cluster Auto Deploy will be moving the hosts into - In my case, I created a cluster TestClusterPleaseIgnore.\n \nThere is however one thing we need to change - Remember we said at the start we wanted the host to cache the image it pulls from Auto Deploy to disk in case of a PxE outage? Well, we do that in the host profile - the exact setting is in Advanced Configuration Settings - System Image Cache Configuration - Enable stateless caching on the host:\n \nThe other settings (overwrite VMFS, ignore SSD and the first disk) are up to you - however, just know the way I illustrated specifies the first disk with ESXi installed, followed by a local disk as the priority for storing the cached image.\nGiven we have got a cluster to adopt the hosts into and a host profile to provision and make the hosts useful (somewhat, this rabbit hole goes deep so spend time getting your host profile right) - we will update our Auto Deploy Rule to make it add all hosts into TestClusterPleaseIgnore and thus, automatically apply the Host Profile and make it production ready.\nLet’s remove the rule we created earlier from the active rule set (If you want to delete the rule altogether append with -Delete):\nRemove-DeployRule InitialBootRule And create a new rule with multiple arguments in the -Item field to represent Image Profile and Cluster:\nNew-DeployRule -Name \"ProductionRule\" -Item \"ESXi-6.0.0-20160302001-standard\",TestClusterPleaseIgnore -AllHosts This rule will boot all hosts to the Image Profile we selected before, then, add them to the cluster TestClusterPleaseIgnore which will in turn attach the host profile to the host on bootup.\nWe now need to add the rule to our active rule set to deploy it:\nAdd-DeployRule ProductionRule Get-DeployRuleSet And that’s it, reboot the host and it should boot into ESXi, apply customisations and join the cluster.\n \nIn the words of Tag Team, “Whoomp, There it is”.\n \nIf you have any suggestions for further customisations or nice scenarios you have used Auto Deploy in, I’d love to hear about them in the comments!\nWhy not follow @mylesagray on Twitter for more like this!\n","wordCount":"1259","inLanguage":"en","image":"https://blah.cloud/images/Screen-Shot-2016-08-19-at-22.39.12.png","datePublished":"2016-08-19T21:53:33Z","dateModified":"2016-08-19T21:53:33Z","author":{"@type":"Person","name":"Myles Gray","url":"/about"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blah.cloud/automation/configuring-auto-deploy-stateless-caching-vsphere-6-0/"},"publisher":{"@type":"Organization","name":"Blah, Cloud","logo":{"@type":"ImageObject","url":"https://blah.cloud/images/favicon.ico"}}}</script>
<script defer data-domain=blah.cloud data-api=/backend/api/event src=/backend/js/script.outbound-links.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<script>var themeColor=getComputedStyle(document.body).getPropertyValue('--primary');document.querySelector('meta[name="theme-color"]').setAttribute('content',themeColor)</script>
<noscript>
<style type=text/css>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(240, 202, 102, 1);--secondary:rgba(216, 214, 197, 1);--tertiary:rgba(128, 130 ,133 , 1);--content:rgba(206, 205, 188, 1);--hljs-bg:#282a36;--code-bg:#282a36;--border:rgba(240, 202, 102, 1)}.list{background:var(--theme)}}</style>
</noscript>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://blah.cloud/ accesskey=h title="Blah, Cloud. (Alt + H)">
<picture>
<source srcset=/images/logo-title.avif type=image/avif>
<source srcset=/images/logo-title.webp type=image/webp>
<img src=/images/logo-title.png alt=logo aria-label=logo width=245 height=40>
</picture></a>
</div>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
<ul id=menu>
<li>
<a href=https://blah.cloud/blog/ title=blog>
<span>blog</span>
</a>
</li>
<li>
<a href=https://blah.cloud/search/ title=" (Alt + /)" accesskey=/>
<span><svg style="height:1em;margin-top:1.5em" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="fill-current w-5" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span>
</a>
</li>
</ul>
</nav>
</header>
<div class=container>
<main class=main>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>
Configuring Auto Deploy Stateless Caching in vSphere 6.0
</h1>
<div class=post-meta>August 19, 2016&nbsp;·&nbsp;Myles Gray&nbsp;|&nbsp;<a href=https://github.com/mylesagray/blog/blob/master/content/posts/2016-08-19-configuring-auto-deploy-stateless-caching-vsphere-6-0/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div>
</header>
<div class=post-content><p>Following on from my previous post on <a href=/infrastructure/building-customised-esxi-image-pxe-installation/>configuring custom ESXi images for PXE deployment</a>, it piqued my interest again in Auto Deploy, now that I have a lab large enough (enough physical failure domains) to justify auto-deploy I figured i&rsquo;d give it another go. I have chosen to implement stateless caching as it will allow the hosts to boot from the last used ESXi image they had if the PxE/AutoDeploy server goes down - then when it comes back up will pull the new version, this accounts for a total infrastructure outage and still allows the hosts to be bootable.</p>
<p>So to start off with, i&rsquo;m assuming you&rsquo;re using the vCenter Server Appliance and not a Windows based VC and you&rsquo;re on vCenter 6.0.</p>
<p>Let&rsquo;s go and start the Auto Deploy service on the vCenter Web UI, you&rsquo;re going to need to log in with a user with <strong>@vsphere.local/SSO</strong> permissions and navigate to <code>Administration -> System Configuration -> Services -> Auto Deploy</code> and click the <code>Actions</code> dropdown and <code>Edit Startup Type</code> and change to <code>Automatic</code>:</p>
<p><picture>
<source srcset=images/Image-5.avif type=image/avif>
<source srcset=images/Image-5.webp type=image/webp>
<img src=images/Image-5.png alt="Auto Deploy Edit Startup Type" loading=lazy decoding=async>
</picture></p>
<p>Now back into the <code>Action</code> menu and click <code>Start</code>. Now that the Auto Deploy service is started and set to start on every boot, we&rsquo;re ready to configure the service itself, to view the current config we need to move to <code>Home -> Hosts and Clusters</code> click your vCenter and click <code>Manage -> Settings -> Auto Deploy</code> and it should look similar to below:</p>
<p><picture>
<source srcset=images/Image-6.avif type=image/avif>
<source srcset=images/Image-6.webp type=image/webp>
<img src=images/Image-6.png alt="Auto Deploy configuration settings" loading=lazy decoding=async>
</picture></p>
<p>Click the link to <code>Download TFTP Boot File Zip</code> and extract - copy these files to the root of your PxE server <code>tftpboot</code> folder with FileZilla/your SFTP client of choice.</p>
<p>Now we need to configure our DHCP server to hand out options codes to tell clients where the TFTP server is and what the boot file is called:</p>
<ul>
<li><code>66 - next-server</code> - IP address of the PxE server that you have previously spun up and copied the <code>TFTP Boot File Zip</code> contents to.</li>
<li><code>67 - filename</code> - In above picture <code>BIOS DHCP File Name</code></li>
</ul>
<p>I have <a href=/infrastructure/enabling-pxe-boot-options-fortigate-dhcp/>covered setting up DHCP options previously on a Fortigate</a> and there are plenty of guides out there for doing this on Linux/Windows so trust in your Google-fu. I&rsquo;m just going to show you what my finished DHCP config looks like on a Fortigate (note <code>next-server</code> and <code>filename</code>):</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh>config system dhcp server
    edit <span class=m>2</span>
        <span class=nb>set</span> dns-service default
        <span class=nb>set</span> ntp-service default
        <span class=nb>set</span> default-gateway 10.0.3.1
        <span class=nb>set</span> netmask 255.255.255.0
        <span class=nb>set</span> interface <span class=s2>&#34;MGMT&#34;</span>
            config ip-range
                edit <span class=m>1</span>
                    <span class=nb>set</span> start-ip 10.0.3.2
                    <span class=nb>set</span> end-ip 10.0.3.100
                next
            end
        <span class=nb>set</span> timezone-option default
        <span class=nb>set</span> next-server 10.0.3.189
        <span class=nb>set</span> filename <span class=s2>&#34;undionly.kpxe.vmw-hardwired&#34;</span>
    next
end
</code></pre></div><p>Now we should be in a position to boot the hosts and have them pick up the iPxE boot environment that we pushed to it earlier, however, at this stage it shouldn&rsquo;t run ESXi as we haven&rsquo;t created any Auto Deploy Rules or created an active Auto Deploy Rule Set.</p>
<p>For purposes of demonstration I&rsquo;ve spun up some VMs in my lab with no OS to PXE boot - when you power on the hosts at this stage, you should see the below screen, if you don&rsquo;t you likely have a DHCP option problem or permissions problem on your <code>tftpboot</code> folder and it can&rsquo;t be read by <code>world</code>.</p>
<p><picture>
<img src=images/PxE-Boot.gif alt="Auto Deploy PxE Boot" loading=lazy decoding=async>
</picture></p>
<p>So once you&rsquo;re seeing the above we are good to build up our Auto Deploy rule set - you&rsquo;ll need <a href=https://www.vmware.com/support/developer/PowerCLI/>PowerCLI</a> installed as there is no native UI for building Auto Deploy Rules (yet&mldr;).</p>
<p>Open up PowerCLI, connect to the vCenter server that has the Auto Deploy service running and we will import an <a href="https://my.vmware.com/web/vmware/details?productId=491&downloadGroup=ESXI60U2">offline ESXi bundle</a> to deploy our selected version of ESXi - if you want to create a customised image profile with particular VIBs pre-installed, <a href=/infrastructure/building-customised-esxi-image-pxe-installation/>check my article on that here</a>.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=nb>Connect-VIServer</span> <span class=n>vc01</span><span class=p>.</span><span class=n>lab</span><span class=p>.</span><span class=n>mylesgray</span><span class=p>.</span><span class=n>io</span>
<span class=nb>Add-ESXSoftwareDepot</span> <span class=n>E:</span><span class=p>\</span><span class=n>DL</span><span class=p>\</span><span class=nb>update-from</span><span class=n>-esxi6</span><span class=p>.</span><span class=n>0</span><span class=p>-</span><span class=n>6</span><span class=p>.</span><span class=n>0_update02</span><span class=p>.</span><span class=n>zip</span>
</code></pre></div><p>Now we can get the <code>Name</code> field of the image profiles included</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=nb>Get-ESXImageProfile</span> <span class=p>|</span> <span class=nb>fl
</span></code></pre></div><p>For this demo i&rsquo;m going to use the latest image profile that includes VMware Tools <code>ESXi-6.0.0-20160302001-standard</code> - let&rsquo;s create our first Auto Deploy Rule (you can create other more specific ones based <a href=http://pubs.vmware.com/vsphere-60/index.jsp#com.vmware.vsphere.install.doc/GUID-3521CBAC-8819-489D-A10A-93397E332C9A.html>on the patterns here</a> if you like and add them to the rule set):</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=nb>New-DeployRule</span> <span class=n>-Name</span> <span class=s2>&#34;InitialBootRule&#34;</span> <span class=n>-Item</span> <span class=s2>&#34;ESXi-6.0.0-20160302001-standard&#34;</span> <span class=n>-AllHosts</span>
</code></pre></div><p>This will kick off an upload of the image profile to the vCenter Server for provisioning to the hosts:</p>
<p><picture>
<img src=images/2016-08-19_21-28-01.gif alt="Auto Deploy Rule Creation" loading=lazy decoding=async>
</picture></p>
<p>So all this has done is created the rule, it&rsquo;s not in the <em>active</em> rule set yet, so won&rsquo;t apply to any booting hosts, we need to add the rule to part of the active rule set for it to apply to hosts:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=nb>Add-DeployRule</span> <span class=n>-DeployRule</span> <span class=s2>&#34;InitialBootRule&#34;</span>
</code></pre></div><p>And we can run <code>Get-DeployRuleSet</code> to ensure the rules are part of the active set, if successful we should se it listed as so:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=n>PowerCLI</span> <span class=n>C:</span><span class=p>\</span><span class=n>Program</span> <span class=n>Files</span> <span class=p>(</span><span class=n>x86</span><span class=p>)\</span><span class=n>VMware</span><span class=p>\</span><span class=n>Infrastructure</span><span class=p>\</span><span class=n>vSphere</span> <span class=n>PowerCLI</span><span class=p>&gt;</span> <span class=nb>Get-DeployRuleSet</span>


<span class=n>Name</span>        <span class=err>:</span> <span class=n>InitialBootRule</span>
<span class=n>PatternList</span> <span class=err>:</span>
<span class=n>ItemList</span>    <span class=err>:</span> <span class=p>{</span><span class=n>ESXi</span><span class=p>-</span><span class=n>6</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>0</span><span class=p>-</span><span class=n>20160301001s-standard</span><span class=p>}</span>
</code></pre></div><p>Now as the host reboots we can see it boot the hypervisor from AutoDeploy:</p>
<p><picture>
<source srcset=images/Screen-Shot-2016-08-19-at-21.48.09.avif type=image/avif>
<source srcset=images/Screen-Shot-2016-08-19-at-21.48.09.webp type=image/webp>
<img src=images/Screen-Shot-2016-08-19-at-21.48.09.png alt="ESXi Boot from Auto Deploy" loading=lazy decoding=async>
</picture></p>
<p>So the host now boots into ESXi and joins vCenter, but is completely unconfigured and not very useful, the whole purpose of automating something like this is to for example, auto scale and IaaS cluster - especially one where the public can spin up VMs on demand.</p>
<p>With that in mind, let&rsquo;s build a host profile to get some standardised config on the go - I&rsquo;ve set up the first host manually with some generic stuff (NTP, Power Profile, Keyboard type, etc) and have <a href=http://pubs.vmware.com/vsphere-60/index.jsp#com.vmware.vsphere.install.doc/GUID-4D8EDD07-6C77-4845-8F0E-A0F4C9102840.html>extracted the host profile</a> (deselecting anything irrelevant) then, attached the Host Profile to the cluster Auto Deploy will be moving the hosts into - In my case, I created a cluster <code>TestClusterPleaseIgnore</code>.</p>
<p><picture>
<source srcset=images/Screen-Shot-2016-08-19-at-22.14.04.avif type=image/avif>
<source srcset=images/Screen-Shot-2016-08-19-at-22.14.04.webp type=image/webp>
<img src=images/Screen-Shot-2016-08-19-at-22.14.04.png alt="Host Profile attached to Cluster" loading=lazy decoding=async>
</picture></p>
<p>There is however one thing we need to change - Remember we said at the start we wanted the host to cache the image it pulls from Auto Deploy to disk in case of a PxE outage? Well, we do that in the host profile - the exact setting is in <code>Advanced Configuration Settings -> System Image Cache Configuration -> Enable stateless caching on the host</code>:</p>
<p><picture>
<source srcset=images/Screen-Shot-2016-08-19-at-22.31.45.avif type=image/avif>
<source srcset=images/Screen-Shot-2016-08-19-at-22.31.45.webp type=image/webp>
<img src=images/Screen-Shot-2016-08-19-at-22.31.45.png alt="Enable Stateless Caching on Host" loading=lazy decoding=async>
</picture></p>
<p>The other settings (<code>overwrite VMFS</code>, <code>ignore SSD</code> and the <code>first disk</code>) are up to you - however, just know the way I illustrated specifies the first disk with <code>ESXi</code> installed, followed by a <code>local</code> disk as the priority for storing the cached image.</p>
<p>Given we have got a cluster to adopt the hosts into and a host profile to provision and make the hosts useful (somewhat, <a href=https://pubs.vmware.com/vsphere-60/topic/com.vmware.ICbase/PDF/vsphere-esxi-vcenter-server-60-host-profiles-guide.pdf>this rabbit hole goes deep</a> so spend time getting your host profile right) - we will update our Auto Deploy Rule to make it add all hosts into <code>TestClusterPleaseIgnore</code> and thus, automatically apply the Host Profile and make it production ready.</p>
<p>Let&rsquo;s remove the rule we created earlier from the active rule set (If you want to delete the rule altogether append with <code>-Delete</code>):</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=nb>Remove-DeployRule</span> <span class=n>InitialBootRule</span>
</code></pre></div><p>And create a new rule with multiple arguments in the <code>-Item</code> field to represent Image Profile and Cluster:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=nb>New-DeployRule</span> <span class=n>-Name</span> <span class=s2>&#34;ProductionRule&#34;</span> <span class=n>-Item</span>  <span class=s2>&#34;ESXi-6.0.0-20160302001-standard&#34;</span><span class=p>,</span><span class=n>TestClusterPleaseIgnore</span> <span class=n>-AllHosts</span>
</code></pre></div><p>This rule will boot <em>all hosts</em> to the Image Profile we selected before, then, add them to the cluster <code>TestClusterPleaseIgnore</code> which will in turn attach the host profile to the host on bootup.</p>
<p>We now need to add the rule to our active rule set to deploy it:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=nb>Add-DeployRule</span> <span class=n>ProductionRule</span>
<span class=nb>Get-DeployRuleSet</span>
</code></pre></div><p>And that&rsquo;s it, reboot the host and it should boot into ESXi, apply customisations and join the cluster.</p>
<p><picture>
<source srcset=images/Screen-Shot-2016-08-19-at-22.37.21.avif type=image/avif>
<source srcset=images/Screen-Shot-2016-08-19-at-22.37.21.webp type=image/webp>
<img src=images/Screen-Shot-2016-08-19-at-22.37.21.png alt="Applying host profile customisations" loading=lazy decoding=async>
</picture></p>
<p>In the words of <a href="https://youtu.be/Z-FPimCmbX8?t=46">Tag Team, &ldquo;Whoomp, There it is&rdquo;</a>.</p>
<p><picture>
<source srcset=images/Screen-Shot-2016-08-19-at-22.39.12.avif type=image/avif>
<source srcset=images/Screen-Shot-2016-08-19-at-22.39.12.webp type=image/webp>
<img src=images/Screen-Shot-2016-08-19-at-22.39.12.png alt="Host adopted into cluster" loading=lazy decoding=async>
</picture></p>
<p>If you have any suggestions for further customisations or nice scenarios you have used Auto Deploy in, I&rsquo;d love to hear about them in the comments!</p>
<p>Why not follow <a href=https://twitter.com/mylesagray>@mylesagray on Twitter</a> for more like this!</p>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://blah.cloud/tags/autodeploy/>autodeploy</a></li>
<li><a href=https://blah.cloud/tags/automation/>automation</a></li>
<li><a href=https://blah.cloud/tags/esxi/>esxi</a></li>
<li><a href=https://blah.cloud/tags/pxe/>pxe</a></li>
<li><a href=https://blah.cloud/tags/vsphere/>vsphere</a></li>
</ul>
<nav class=paginav>
<a class=prev href=https://blah.cloud/hardware/replicating-san-opensuse-vaai/>
<span class=title>« Prev Page</span>
<br>
<span>Replicating SAN on openSUSE with VAAI</span>
</a>
<a class=next href=https://blah.cloud/infrastructure/building-customised-esxi-image-pxe-installation/>
<span class=title>Next Page »</span>
<br>
<span>Building a customised ESXi image for PXE installation</span>
</a>
</nav>
<section class="section related-links">
<div class="columns is-centered">
<div class="column max-800px">
<div class=content>
<h2>Related content</h2>
</div>
<div class="columns related-links-columns">
<div class="column is-one-third">
<div class=card>
<div class=card-image>
<figure class="image is-3by2">
<a href=/infrastructure/building-customised-esxi-image-pxe-installation/><img src=/infrastructure/building-customised-esxi-image-pxe-installation/images/GUID-61B362E1-5350-4999-8874-264ABD687E50-high.png alt></a>
</figure>
</div>
<div class=card-content>
<a class="title is-5" href=https://blah.cloud/infrastructure/building-customised-esxi-image-pxe-installation/>Building a customised ESXi image for PXE installation</a>
</div>
</div>
</div>
<div class="column is-one-third">
<div class=card>
<div class=card-image>
<figure class="image is-3by2">
<a href=/virtualisation/vsphere-update-manager-cannot-scan-host/><img src=/virtualisation/vsphere-update-manager-cannot-scan-host/images/Screen-Shot-2016-05-15-at-15.26.34.png alt></a>
</figure>
</div>
<div class=card-content>
<a class="title is-5" href=https://blah.cloud/virtualisation/vsphere-update-manager-cannot-scan-host/>vSphere Update Manager – Cannot Scan Host</a>
</div>
</div>
</div>
<div class="column is-one-third">
<div class=card>
<div class=card-image>
<figure class="image is-3by2">
<a href=/infrastructure/migrating-vsan-vmkernel-ports-new-subnet/><img src=/infrastructure/migrating-vsan-vmkernel-ports-new-subnet/images/Screenshot-2017-11-02-12.39.08.png alt></a>
</figure>
</div>
<div class=card-content>
<a class="title is-5" href=https://blah.cloud/infrastructure/migrating-vsan-vmkernel-ports-new-subnet/>Migrating vSAN vmkernel ports to a new subnet</a>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share Configuring Auto Deploy Stateless Caching in vSphere 6.0 on twitter" href="https://twitter.com/intent/tweet/?text=Configuring%20Auto%20Deploy%20Stateless%20Caching%20in%20vSphere%206.0&url=https%3a%2f%2fblah.cloud%2fautomation%2fconfiguring-auto-deploy-stateless-caching-vsphere-6-0%2f&hashtags=autodeploy%2cautomation%2cesxi%2cpxe%2cvsphere"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Configuring Auto Deploy Stateless Caching in vSphere 6.0 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fblah.cloud%2fautomation%2fconfiguring-auto-deploy-stateless-caching-vsphere-6-0%2f&title=Configuring%20Auto%20Deploy%20Stateless%20Caching%20in%20vSphere%206.0"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Configuring Auto Deploy Stateless Caching in vSphere 6.0 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblah.cloud%2fautomation%2fconfiguring-auto-deploy-stateless-caching-vsphere-6-0%2f&title=Configuring%20Auto%20Deploy%20Stateless%20Caching%20in%20vSphere%206.0&summary=Configuring%20Auto%20Deploy%20Stateless%20Caching%20in%20vSphere%206.0&source=https%3a%2f%2fblah.cloud%2fautomation%2fconfiguring-auto-deploy-stateless-caching-vsphere-6-0%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
</div>
</footer><script src=https://utteranc.es/client.js repo=mylesagray/blog-comments issue-term=title theme=preferred-color-scheme crossorigin=anonymous async></script>
</article>
</main>
</div>
<footer class=footer>
<span>&copy; 2021 <a href=https://blah.cloud/>Blah, Cloud</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>