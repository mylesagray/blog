<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Designing a networking platform for IaaS multi-tenancy | Blah, Cloud</title>
<meta name=keywords content="architecture,design,networking,nsx,SDN,VMware">
<meta name=description content="How to architect a multi-tenant datacenter networking platform">
<meta name=author content="Myles Gray">
<link rel=canonical href=https://blah.cloud/infrastructure/designing-networking-platform-iaas-multi-tenancy/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.bb7b6cf94a3b5ac371de6cb2fa15f58bc31c449c1f93f8cd140b7233b6c89542.css integrity="sha256-u3ts+Uo7WsNx3myy+hX1i8McRJwfk/jNFAtyM7bIlUI=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/scroll-toc.min.c4f9a8e78694df8c52f7d3b0c44492ff3dcfa95d42215176796bef76438bc463.js integrity="sha256-xPmo54aU34xS99OwxESS/z3PqV1CIVF2eWvvdkOLxGM="></script>
<link rel=icon href=https://blah.cloud/images/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://blah.cloud/images/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://blah.cloud/images/favicon-32x32.png>
<link rel=apple-touch-icon href=https://blah.cloud/images/apple-touch-icon.png>
<link rel=mask-icon href=https://blah.cloud/images/logo.png>
<meta name=theme-color media="(prefers-color-scheme: dark)" content="rgba(88, 89, 91, 1)">
<meta name=theme-color content="rgba(240, 202, 102, 1)">
<meta name=msapplication-TileColor content="rgba(240, 202, 102, 1)">
<meta name=generator content="Hugo 0.88.1">
<meta property="og:title" content="Designing a networking platform for IaaS multi-tenancy">
<meta property="og:description" content="How to architect a multi-tenant datacenter networking platform">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blah.cloud/infrastructure/designing-networking-platform-iaas-multi-tenancy/">
<meta property="og:image" content="https://blah.cloud/infrastructure/designing-networking-platform-iaas-multi-tenancy/images/image-1-2.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2017-03-23T18:38:11+00:00">
<meta property="article:modified_time" content="2021-10-25T14:26:53+00:00"><meta property="og:site_name" content="Blah, Cloud">
<meta property="og:see_also" content="https://blah.cloud/networks/implementing-multi-tenant-networking-platform-nsx/"><meta property="og:see_also" content="https://blah.cloud/infrastructure/multi-tenant-network-challenges/"><meta property="og:see_also" content="https://blah.cloud/infrastructure/designing-modern-private-cloud-network/">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://blah.cloud/infrastructure/designing-networking-platform-iaas-multi-tenancy/images/image-1-2.png">
<meta name=twitter:title content="Designing a networking platform for IaaS multi-tenancy">
<meta name=twitter:description content="How to architect a multi-tenant datacenter networking platform">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Designing a networking platform for IaaS multi-tenancy","item":"https://blah.cloud/infrastructure/designing-networking-platform-iaas-multi-tenancy/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Designing a networking platform for IaaS multi-tenancy","name":"Designing a networking platform for IaaS multi-tenancy","description":"How to architect a multi-tenant datacenter networking platform","keywords":["architecture","design","networking","nsx","SDN","VMware"],"articleBody":"Based on my last post, you’ll understand some of the challenges that are faced with traditional approaches to datacenter networking so let’s get into the high-level conceptual design here of how we might solve one of these problems. Most service providers have or are at least familiar with using MPLS for customer segregation in a WAN scope as I alluded to in my previous datacenter networking article. What we want to do is simplify the provisioning and distribution of subnets to a customer’s virtual environment, all the way up to the WAN.\nConceptual Design The endgame here is - if we add a VM, or indeed a Logical switch to NSX that all the other sites in the MPLS for that customer know about it without us having to touch a thing. This gives us our first step in achieving a fully automated networking platform.\nTypically, static routes are added to customer virtual routing domains (VRFs) that tell the MPLS what subnets exist behind each site if they’re not directly connected to the customer provided equipment (CPE). You can of course use dynamic routing with a router behind the CPE, but again - manual configuration of Switch Virtual Interfaces (SVIs), not as robust as automating it all.\n \nAbove we can see the desired outcome, a Logical Switch is added to NSX for a particular customer and that subnet is automatically distributed, from the host, into the customer VRF and to all of that customer’s sites on the MPLS.\nLogical Design With the concept in mind, let’s map out what this looks like logically, I had done up a diagram recently for Mark Brookfield (virtualhobbit) on how such a solution might look for his lab so i’m going to take liberty and put it in here:\n \nAt the bottom, we have our hosts, with the Distributed Logical Router and Distributed Firewall (DLR/DFW) on top - they are connected to the Edge Services Gateway (ESG) via a Logical Interface (LIF) - the DLR control VM can be seen off to the side (it’s not a data-plane component, just control-plane for routing updates and such).\nThere is an ESG in the data path between the DLR and the upstream routers/CPE which provides the customer VRFs and gateway to the WAN.\nPhysical Design This is where the fun begins - i’m going to start with a diagram that you can refer back to as we go through these concepts below:\n \nLet’s start at the bottom as that’s where our routing decisions will largely take place and where new routes will originate from.\nDistributed Logical Router  \nWhen you add Logical Switches to the DLR and you have OSPF/BGP peering northbound to the ESG enabled, these subnets will automatically be advertised upstream - this is essential in allowing an infrastructure like this to scale.\nThe DLR provides in-kernel routing between VMs, if VMs are resident inside a single host and are on different subnets, they will route entirely inside the kernel, thus cutting out any northbound traffic leaving the host.\nIf VMs are in different subnets and are also on two separate hosts, obviously, traffic will have to leave the source host. The packet is encapsulated in a VXLAN header and will be delivered and routed in the kernel on the other host, still appearing as if it came from the same L2 segment as it originated from - thanks to the encapsulation.\nThis also saves on excessive North/South traffic on the Top of Rack (ToR) to Spine switches by simply pushing the traffic to the NSX VTEP VLAN, being switched at the ToR and then back down to the other host. In itself this alone greatly helps with oversubscription ratios on ToR - Spine links due to reduced N/S traffic and can mean racks can be made more dense owing to higher oversubscription ratios.\nThe DLR is also the place where VLAN to VXLAN bridging takes place in the kernel if you bridge any VXLAN segments to physical VLANs (In this case, vDS PortGroups) then it will be done on-host at line rate.\nBelow we can see a typical spine and leaf that utilises routing at the edge of the network:\n \nWith NSX in play; rather than needing to be routed centrally and transit across a number of switches and routers, thus consuming bandwidth on the Spine and Leaf interconnects and suffering an increased Round Trip Time, the packets are encapsulated by the VTEP on the source host, pushed to the ToR, switched and sent down to the host where that packet is destined and then routed in the kernel. See how the data path no longer traverses the Spine and Leaf interconnects for the same operation?\n \nThis is of course possible if you use VRFs and anycast gateway on your ToR switches - the packet would be sent to the ToR, routed, then sent to the corresponding host - I mentioned this in my previous DC networking article towards the end. This approach does however introduce a lot of complexity into the physical network and some very specialist configuration and debugging skills. It is operationally very heavy, high touch for subnet changes, complex and carries with it the appropriate risk. Not to mention you need relatively high-end switches. This approach also does not allow for some nice features that NSX adds (multi-site firewall/policy rules, failover, integrations with other high level virtualisation aware solutions, etc).\nDLR to ESG  \nThere are a few operations that go on between the DLR and the ESG - there will need to be a point-to-point transit network (typically a Logical Switch) that is a /29 subnet to provide N/S connectivity from the kernel LIFs to the default gateway or routes advertised by the ESG.\nTypically when I deploy dynamic routing between the DLR and the ESG I will use OSPF - the ESGs do come by default with two OSPF areas (`` - a “normal” area and 51 - a “NSSA” type), the NSSA will point towards the DLR and will allow the DLR to advertise routes into the ESG - area 0 is then pointed northbound on a transit link (usually a physical VLAN), to the upstream routers/CPE and will provide routing advertisements to the customer’s VRF in the MPLS switch/router.\nI’d like to highlight here the distinction between a /30 and a /29 between the DLR and the ESG - there is a lot of misinformation out there about this particular scenario and I want to clear it up.\nIf you are using a dynamic routing between the DLR and the ESG you must use a /29 subnet for your transit network, this is because while the DLR and ESG both have a LIF in same subnet - this is only used for data-plane traffic. The DLR kernel module’s LIF itself does not listen for dynamic routing advertisements. That is the job of the DLR Control VM as in the above diagram.\nThe DLR Control VM listens for and sends OSPF and BGP routing advertisements - it is not in the data-path but it still needs to be on the same subnet as the DLR and ESG LIFs to be updated with, and make, the routing advertisements - given a /30 subnet only has 2 usable addresses, that is obviously no good as we need one for the ESG LIF, one for the DLR kernel LIF and one for the DLR control VM interface.\nA point to point logical switch with dynamic routing between the ESG and the DLR should like like the below:\n \nIf however, you aren’t using dynamic routing between the DLR and the ESG, you can use a /30 as the DLR Control VM doesn’t need an interface in the subnet in order to update the DLR control plane.\nEdge Services Gateway  \nThe ESG provides in-path routing, NAT and L7 data services like Load balancing, SSL-VPN, IPSec, L2VPN. It is the boundary between the two OSPF areas as stated above and provides all N/S traffic in and out of a customer environment, as such, it is important to deploy them as a HA pair.\nESGs have the ability to use Equal Cost Multi-Pathing (ECMP) to statefully select traffic paths to/from both the DLR and northbound routers - this has the advantage that if a customer is pushing more than 10Gbps of traffic, you can scale out an ESG cluster and provide better performance across multiple paths.\nThe ESG can be configured to advertise a default route to the DLR (default-information originate) as well as redistribute routes learned statically, as connected, or via OSPF or BGP. The ESG is where we will focus the configuration of the routing into the customer VRFs on the upstream routers.\nUpstream Routing  \nSo this is not in NSX-scope but is a critical component of this architecture - in order to have any changes we make at an NSX level distributed to customer sites and provide multi-tenancy we need to have the upstream routers support VRF, this means we can have multiple routing tables with overlapping subnets on the same router but are kept separated and distinct.\nTo make sure there are no SPOF on the upstream the design would mandate a stack or pair of devices that are VRRP capable - this means that if a single device fails the other assumes its identity with a virtual MAC address and all traffic will continue to flow normally.\nThe link between the ESG and this upstream routing will also be a point-to-point /30 link - this differs from the transit link between the ESG and the DLR you’ll remember.\nThe reason behind this difference is that while the DLR Control VM is not in the data-path, the ESG is. As such, the ESG LIFs can also send/receive routing updates as well as normal traffic so there is no need for an “out of band” routing address.\nTo advertise routes learned from NSX via the ESG the router must be configured such that OSPF area 0 is configured within the customer’s VRF and is peered with the ESG meaning any routes learned via OSPF on the router will be added to the routing table in the customer’s VRF. This is actually the same process that you would use even if you are not using MPLS and rather are routing upstream to another Autonomous System via BGP and your routers are part of the public internet.\nConclusion You should be able to see from the above that implementing a solution like this has great value in automation terms, leading to more reliable, consistent environment configuration that will scale well, in the next article I will be covering the actual implementation of the above design and demoing the capability.\nWhy not follow @mylesagray on Twitter for more like this!\n","wordCount":"1795","inLanguage":"en","image":"https://blah.cloud/infrastructure/designing-networking-platform-iaas-multi-tenancy/images/image-1-2.png","datePublished":"2017-03-23T18:38:11Z","dateModified":"2021-10-25T14:26:53Z","author":{"@type":"Person","name":"Myles Gray","url":"/about"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blah.cloud/infrastructure/designing-networking-platform-iaas-multi-tenancy/"},"publisher":{"@type":"Organization","name":"Blah, Cloud","logo":{"@type":"ImageObject","url":"https://blah.cloud/images/favicon.ico"}}}</script>
<script defer data-domain=blah.cloud data-api=/backend/api/event src=/backend/js/script.outbound-links.js></script>
<script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script>
</head>
<body id=top>
<script>window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches?(document.body.classList.add('dark'),document.body.classList.remove('light')):(document.body.classList.remove('dark'),document.body.classList.add('light'));const darkModeMediaQuery=window.matchMedia('(prefers-color-scheme: dark)');darkModeMediaQuery.addListener(a=>{const b=a.matches;b?(document.body.classList.add('dark'),document.body.classList.remove('light')):(document.body.classList.remove('dark'),document.body.classList.add('light'))})</script>
<noscript>
<style type=text/css>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(240, 202, 102, 1);--secondary:rgba(216, 214, 197, 1);--tertiary:rgba(128, 130 ,133 , 1);--content:rgba(206, 205, 188, 1);--hljs-bg:#282a36;--code-bg:#282a36;--border:rgba(240, 202, 102, 1)}.list{background:var(--theme)}}</style>
</noscript>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://blah.cloud/ accesskey=h title="Blah, Cloud. (Alt + H)">
<picture>
<source media="(min-width: 768px)" srcset=/images/logo-title.avif type=image/avif alt=logo width=245 height=34>
<source media="(min-width: 768px)" srcset=/images/logo-title.webp type=image/webp alt=logo width=245 height=34>
<source srcset=/images/logo.avif type=image/avif alt=logo width=65 height=65>
<source srcset=/images/logo.webp type=image/webp alt=logo width=65 height=65>
<img src=/images/logo-title.png alt=logo aria-label=logo width=245 height=34>
</picture></a>
</div>
<span class=logo-switches>
</span>
<i class=hamburger><svg xmlns="http://www.w3.org/2000/svg" width="24" height="28" viewBox="0 0 24 28"><path d="M24 21v2c0 .547-.453 1-1 1H1c-.547.0-1-.453-1-1v-2c0-.547.453-1 1-1h22c.547.0 1 .453 1 1zm0-8v2c0 .547-.453 1-1 1H1c-.547.0-1-.453-1-1v-2c0-.547.453-1 1-1h22c.547.0 1 .453 1 1zm0-8v2c0 .547-.453 1-1 1H1c-.547.0-1-.453-1-1V5c0-.547.453-1 1-1h22c.547.0 1 .453 1 1z"/></svg>
</i>
<ul id=menu>
<li>
<a href=https://blah.cloud/blog/ title=blog>
<span>blog</span>
</a>
</li>
<li>
<a href=https://blah.cloud/works/ title=works>
<span>works</span>
</a>
</li>
<li>
<a href=https://blah.cloud/search/ title=" (Alt + /)" accesskey=/>
<span><svg style="height:1em" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="fill-current w-5" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span>
</a>
</li>
</ul>
</nav>
</header>
<div class=container>
<main class=main>
<div class=wrapper>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>
Designing a networking platform for IaaS multi-tenancy
</h1>
<div class=post-description>
How to architect a multi-tenant datacenter networking platform
</div>
<div class=post-meta>March 23, 2017&nbsp;·&nbsp;Myles Gray&nbsp;|&nbsp;<a href=https://github.com/mylesagray/blog/blob/master/content/posts/2017-03-23-designing-networking-platform-iaas-multi-tenancy/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#conceptual-design aria-label="Conceptual Design">Conceptual Design</a></li>
<li>
<a href=#logical-design aria-label="Logical Design">Logical Design</a></li>
<li>
<a href=#physical-design aria-label="Physical Design">Physical Design</a><ul>
<li>
<a href=#distributed-logical-router aria-label="Distributed Logical Router">Distributed Logical Router</a></li>
<li>
<a href=#dlr-to-esg aria-label="DLR to ESG">DLR to ESG</a></li>
<li>
<a href=#edge-services-gateway aria-label="Edge Services Gateway">Edge Services Gateway</a></li>
<li>
<a href=#upstream-routing aria-label="Upstream Routing">Upstream Routing</a></li></ul>
</li>
<li>
<a href=#conclusion aria-label=Conclusion>Conclusion</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><p>Based <a href=/architecture/multi-tenant-network-challenges/>on my last post</a>, you&rsquo;ll understand some of the challenges that are faced with traditional approaches to datacenter networking so let&rsquo;s get into the high-level conceptual design here of how we might solve one of these problems. Most service providers have or are at least familiar with using MPLS for customer segregation in a WAN scope as I alluded to in my previous <a href=/architecture/designing-modern-private-cloud-network/>datacenter networking</a> article. What we want to do is simplify the provisioning and distribution of subnets to a customer&rsquo;s virtual environment, all the way up to the WAN.</p>
<h2 id=conceptual-design>Conceptual Design<a hidden class=anchor aria-hidden=true href=#conceptual-design>#</a></h2>
<p>The endgame here is - if we add a VM, or indeed a Logical switch to NSX that all the other sites in the MPLS for that customer know about it without us having to touch a thing. This gives us our first step in achieving a fully automated networking platform.</p>
<p>Typically, static routes are added to customer virtual routing domains (VRFs) that tell the MPLS what subnets exist behind each site if they&rsquo;re not directly connected to the customer provided equipment (CPE). You can of course use dynamic routing with a router behind the CPE, but again - manual configuration of Switch Virtual Interfaces (SVIs), not as robust as automating it all.</p>
<p><picture>
<source srcset=images/image-1-2.avif type=image/avif>
<source srcset=images/image-1-2.webp type=image/webp>
<img src=images/image-1-2.png alt="VRF to MPLS route distribution" loading=lazy decoding=async>
</picture></p>
<p>Above we can see the desired outcome, a Logical Switch is added to NSX for a particular customer and that subnet is automatically distributed, from the host, into the customer VRF and to all of that customer&rsquo;s sites on the MPLS.</p>
<h2 id=logical-design>Logical Design<a hidden class=anchor aria-hidden=true href=#logical-design>#</a></h2>
<p>With the concept in mind, let&rsquo;s map out what this looks like logically, I had done up a diagram recently for <a href=https://twitter.com/virtualhobbit/>Mark Brookfield (virtualhobbit)</a> on how such a solution might look for his lab so i&rsquo;m going to take liberty and put it in here:</p>
<p><picture>
<source srcset=images/image-3.avif type=image/avif>
<source srcset=images/image-3.webp type=image/webp>
<img src=images/image-3.png alt="NSX IaaS Logical" loading=lazy decoding=async>
</picture></p>
<p>At the bottom, we have our hosts, with the Distributed Logical Router and Distributed Firewall (DLR/DFW) on top - they are connected to the Edge Services Gateway (ESG) via a Logical Interface (LIF) - the DLR control VM can be seen off to the side (it&rsquo;s not a data-plane component, just control-plane for routing updates and such).</p>
<p>There is an ESG in the data path between the DLR and the upstream routers/CPE which provides the customer VRFs and gateway to the WAN.</p>
<h2 id=physical-design>Physical Design<a hidden class=anchor aria-hidden=true href=#physical-design>#</a></h2>
<p>This is where the fun begins - i&rsquo;m going to start with a diagram that you can refer back to as we go through these concepts below:</p>
<p><picture>
<source srcset=images/image.avif type=image/avif>
<source srcset=images/image.webp type=image/webp>
<img src=images/image.png alt="NSX IaaS Physical Design" loading=lazy decoding=async>
</picture></p>
<p>Let&rsquo;s start at the bottom as that&rsquo;s where our routing decisions will largely take place and where new routes will originate from.</p>
<h3 id=distributed-logical-router>Distributed Logical Router<a hidden class=anchor aria-hidden=true href=#distributed-logical-router>#</a></h3>
<p><picture>
<source srcset=images/Screen-Shot-2017-03-22-at-18.22.45.avif type=image/avif>
<source srcset=images/Screen-Shot-2017-03-22-at-18.22.45.webp type=image/webp>
<img src=images/Screen-Shot-2017-03-22-at-18.22.45.png alt="DLR and DLR control VMs" loading=lazy decoding=async>
</picture></p>
<p>When you add Logical Switches to the DLR and you have OSPF/BGP peering northbound to the ESG enabled, these subnets will automatically be advertised upstream - this is essential in allowing an infrastructure like this to scale.</p>
<p>The DLR provides in-kernel routing between VMs, if VMs are resident inside a single host and are on different subnets, they will route entirely inside the kernel, thus cutting out any northbound traffic leaving the host.</p>
<p>If VMs are in different subnets and are also on two separate hosts, obviously, traffic will have to leave the source host. The packet is encapsulated in a VXLAN header and will be delivered and routed in the kernel on the other host, still appearing as if it came from the same L2 segment as it originated from - thanks to the encapsulation.</p>
<p>This also saves on excessive North/South traffic on the Top of Rack (ToR) to Spine switches by simply pushing the traffic to the NSX VTEP VLAN, being switched at the ToR and then back down to the other host. In itself this alone greatly helps with oversubscription ratios on ToR -> Spine links due to reduced N/S traffic and can mean racks can be made more dense owing to higher oversubscription ratios.</p>
<p>The DLR is also the place where VLAN to VXLAN bridging takes place in the kernel if you bridge any VXLAN segments to physical VLANs (In this case, vDS PortGroups) then it will be done on-host at line rate.</p>
<p>Below we can see a typical spine and leaf that utilises routing at the edge of the network:</p>
<p><picture>
<source srcset=images/firewall-edge.avif type=image/avif>
<source srcset=images/firewall-edge.webp type=image/webp>
<img src=images/firewall-edge.png alt="Traditional Centralised Routing" loading=lazy decoding=async>
</picture></p>
<p>With NSX in play; rather than needing to be routed centrally and transit across a number of switches and routers, thus consuming bandwidth on the Spine and Leaf interconnects and suffering an increased Round Trip Time, the packets are encapsulated by the VTEP on the source host, pushed to the ToR, switched and sent down to the host where that packet is destined and then routed in the kernel. See how the data path no longer traverses the Spine and Leaf interconnects for the same operation?</p>
<p><picture>
<img src=images/distributed-routing.jpeg alt="VXLAN ToR Switching" loading=lazy decoding=async>
</picture></p>
<p>This is of course possible if you use VRFs and anycast gateway on your ToR switches - the packet would be sent to the ToR, routed, then sent to the corresponding host - I mentioned this in my previous <a href=/architecture/designing-modern-private-cloud-network/>DC networking article</a> towards the end. This approach does however introduce a lot of complexity into the physical network and some very specialist configuration and debugging skills. It is operationally very heavy, high touch for subnet changes, complex and carries with it the appropriate risk. Not to mention you need relatively high-end switches. This approach also does not allow for some nice features that NSX adds (multi-site firewall/policy rules, failover, integrations with other high level virtualisation aware solutions, etc).</p>
<h3 id=dlr-to-esg>DLR to ESG<a hidden class=anchor aria-hidden=true href=#dlr-to-esg>#</a></h3>
<p><picture>
<source srcset=images/Screen-Shot-2017-03-22-at-18.17.55.avif type=image/avif>
<source srcset=images/Screen-Shot-2017-03-22-at-18.17.55.webp type=image/webp>
<img src=images/Screen-Shot-2017-03-22-at-18.17.55.png alt="DLR to ESG Diagram" loading=lazy decoding=async>
</picture></p>
<p>There are a few operations that go on between the DLR and the ESG - there will need to be a point-to-point transit network (typically a Logical Switch) that is a <code>/29</code> subnet to provide N/S connectivity from the kernel LIFs to the default gateway or routes advertised by the ESG.</p>
<p>Typically when I deploy dynamic routing between the DLR and the ESG I will use OSPF - the ESGs do come by default with two OSPF areas (`` - a &ldquo;normal&rdquo; area and <code>51</code> - a &ldquo;NSSA&rdquo; type), the NSSA will point towards the DLR and will allow the DLR to advertise routes into the ESG - <code>area 0</code> is then pointed northbound on a transit link (usually a physical VLAN), to the upstream routers/CPE and will provide routing advertisements to the customer&rsquo;s VRF in the MPLS switch/router.</p>
<p>I&rsquo;d like to highlight here the distinction between a <code>/30</code> and a <code>/29</code> between the DLR and the ESG - there is a <em>lot</em> of misinformation out there about this particular scenario and I want to clear it up.</p>
<p>If you are using a dynamic routing between the DLR and the ESG you <em>must</em> use a <code>/29</code> subnet for your transit network, this is because while the DLR and ESG both have a LIF in same subnet - this is <em>only</em> used for data-plane traffic. The DLR kernel module&rsquo;s LIF itself does not listen for dynamic routing advertisements. That is the job of the <em>DLR Control VM</em> as in the above diagram.</p>
<p>The DLR Control VM listens for and sends OSPF and BGP routing advertisements - it is not in the data-path but it still needs to be on the same subnet as the DLR and ESG LIFs to be updated with, and make, the routing advertisements - given a <code>/30</code> subnet only has 2 usable addresses, that is obviously no good as we need one for the ESG LIF, one for the DLR kernel LIF and one for the DLR control VM interface.</p>
<p>A point to point logical switch with dynamic routing between the ESG and the DLR should like like the below:</p>
<p><picture>
<source srcset=images/image-2.avif type=image/avif>
<source srcset=images/image-2.webp type=image/webp>
<img src=images/image-2.png alt="DLR dynamic routing advertisements" loading=lazy decoding=async>
</picture></p>
<p>If however, you aren&rsquo;t using dynamic routing between the DLR and the ESG, you can use a <code>/30</code> as the DLR Control VM doesn&rsquo;t need an interface in the subnet in order to update the DLR control plane.</p>
<h3 id=edge-services-gateway>Edge Services Gateway<a hidden class=anchor aria-hidden=true href=#edge-services-gateway>#</a></h3>
<p><picture>
<source srcset=images/Screen-Shot-2017-03-22-at-18.17.45.avif type=image/avif>
<source srcset=images/Screen-Shot-2017-03-22-at-18.17.45.webp type=image/webp>
<img src=images/Screen-Shot-2017-03-22-at-18.17.45.png alt="ESG Diagram" loading=lazy decoding=async>
</picture></p>
<p>The ESG provides in-path routing, NAT and L7 data services like Load balancing, SSL-VPN, IPSec, L2VPN. It is the boundary between the two OSPF areas as stated above and provides all N/S traffic in and out of a customer environment, as such, it is important to deploy them as a HA pair.</p>
<p>ESGs have the ability to use Equal Cost Multi-Pathing (ECMP) to <em>statefully</em> select traffic paths to/from both the DLR and northbound routers - this has the advantage that if a customer is pushing more than 10Gbps of traffic, you can scale out an ESG cluster and provide better performance across multiple paths.</p>
<p>The ESG can be configured to advertise a default route to the DLR (<code>default-information originate</code>) as well as redistribute routes learned statically, as connected, or via OSPF or BGP. The ESG is where we will focus the configuration of the routing into the customer VRFs on the upstream routers.</p>
<h3 id=upstream-routing>Upstream Routing<a hidden class=anchor aria-hidden=true href=#upstream-routing>#</a></h3>
<p><picture>
<source srcset=images/Screen-Shot-2017-03-22-at-18.17.29.avif type=image/avif>
<source srcset=images/Screen-Shot-2017-03-22-at-18.17.29.webp type=image/webp>
<img src=images/Screen-Shot-2017-03-22-at-18.17.29.png alt="ESG to Upstream Routing" loading=lazy decoding=async>
</picture></p>
<p>So this is not in NSX-scope but is a critical component of this architecture - in order to have any changes we make at an NSX level distributed to customer sites and provide multi-tenancy we need to have the upstream routers support VRF, this means we can have multiple routing tables with overlapping subnets on the same router but are kept separated and distinct.</p>
<p>To make sure there are no SPOF on the upstream the design would mandate a stack or pair of devices that are VRRP capable - this means that if a single device fails the other assumes its identity with a virtual MAC address and all traffic will continue to flow normally.</p>
<p>The link between the ESG and this upstream routing will also be a point-to-point <code>/30</code> link - this differs from the transit link between the ESG and the DLR you&rsquo;ll remember.</p>
<p>The reason behind this difference is that while the DLR Control VM is not in the data-path, the ESG is. As such, the ESG LIFs can also send/receive routing updates as well as normal traffic so there is no need for an &ldquo;out of band&rdquo; routing address.</p>
<p>To advertise routes learned from NSX via the ESG the router must be configured such that OSPF <code>area 0</code> is configured within the customer&rsquo;s VRF and is peered with the ESG meaning any routes learned via OSPF on the router will be added to the routing table in the customer&rsquo;s VRF. This is actually the same process that you would use even if you are not using MPLS and rather are routing upstream to another Autonomous System via BGP and your routers are part of the public internet.</p>
<h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2>
<p>You should be able to see from the above that implementing a solution like this has great value in automation terms, leading to more reliable, consistent environment configuration that will scale well, <a href=/networks/implementing-multi-tenant-networking-platform-nsx/>in the next article</a> I will be covering the actual implementation of the above design and demoing the capability.</p>
<p>Why not follow <a href=https://twitter.com/mylesagray>@mylesagray on Twitter</a> for more like this!</p>
</div>
<footer class=post-footer>
<section class="section post-tags">
<div class=content>
<h2>Tagged with</h2>
</div>
<ul class=post-tags>
<li><a href=https://blah.cloud/tags/architecture/>architecture</a></li>
<li><a href=https://blah.cloud/tags/design/>design</a></li>
<li><a href=https://blah.cloud/tags/networking/>networking</a></li>
<li><a href=https://blah.cloud/tags/nsx/>nsx</a></li>
<li><a href=https://blah.cloud/tags/sdn/>SDN</a></li>
<li><a href=https://blah.cloud/tags/vmware/>VMware</a></li>
</ul>
</section>
<nav class=paginav>
<a class=prev href=https://blah.cloud/networks/implementing-multi-tenant-networking-platform-nsx/>
<span class=title>« Prev Page</span>
<br>
<span>Implementing a multi-tenant networking platform with NSX</span>
</a>
<a class=next href=https://blah.cloud/infrastructure/multi-tenant-network-challenges/>
<span class=title>Next Page »</span>
<br>
<span>Multi-tenant network challenges</span>
</a>
</nav>
<section class="section related-links">
<div class="columns is-centered">
<div class="column max-800px">
<div class=content>
<h2>Related content</h2>
</div>
<div class="columns related-links-columns">
<div class="column is-one-third">
<div class=card>
<div class=card-image>
<figure class="image is-3by2">
<a href=/infrastructure/multi-tenant-network-challenges/>
<picture>
<source srcset=/infrastructure/multi-tenant-network-challenges/images/Traditional-Process-Flow.avif type=image/avif>
<source srcset=/infrastructure/multi-tenant-network-challenges/images/Traditional-Process-Flow.webp type=image/webp>
<img src=/infrastructure/multi-tenant-network-challenges/images/Traditional-Process-Flow_hub2816e950b5d448800cb97ba9ca36402_27093_240x0_resize_box_3.png alt="ITIL process flow" loading=lazy decoding=async>
</picture>
</a>
</figure>
</div>
<div class=card-content>
<a class="title is-5" href=https://blah.cloud/infrastructure/multi-tenant-network-challenges/>Multi-tenant network challenges</a>
</div>
</div>
</div>
<div class="column is-one-third">
<div class=card>
<div class=card-image>
<figure class="image is-3by2">
<a href=/networks/implementing-multi-tenant-networking-platform-nsx/>
<picture>
<source srcset=/networks/implementing-multi-tenant-networking-platform-nsx/images/Screen-Shot-2017-03-21-at-21.29.14.avif type=image/avif>
<source srcset=/networks/implementing-multi-tenant-networking-platform-nsx/images/Screen-Shot-2017-03-21-at-21.29.14.webp type=image/webp>
<img src=/networks/implementing-multi-tenant-networking-platform-nsx/images/Screen-Shot-2017-03-21-at-21.29.14_hue58c71b348ea89de6b42502ea57e817b_65292_240x0_resize_box_3.png alt="OSPF discovered routes in routing table" loading=lazy decoding=async>
</picture>
</a>
</figure>
</div>
<div class=card-content>
<a class="title is-5" href=https://blah.cloud/networks/implementing-multi-tenant-networking-platform-nsx/>Implementing a multi-tenant networking platform with NSX</a>
</div>
</div>
</div>
<div class="column is-one-third">
<div class=card>
<div class=card-image>
<figure class="image is-3by2">
<a href=/infrastructure/designing-modern-private-cloud-network/>
<picture>
<source srcset=/infrastructure/designing-modern-private-cloud-network/images/DC-Network-BGP-AS-Leaf-Spine.avif type=image/avif>
<source srcset=/infrastructure/designing-modern-private-cloud-network/images/DC-Network-BGP-AS-Leaf-Spine.webp type=image/webp>
<img src=/infrastructure/designing-modern-private-cloud-network/images/DC-Network-BGP-AS-Leaf-Spine_hubca80cde4baf9ddd5a6ac603a45afa9d_69399_240x0_resize_box_3.png alt="Network architecture with BGP" loading=lazy decoding=async>
</picture>
</a>
</figure>
</div>
<div class=card-content>
<a class="title is-5" href=https://blah.cloud/infrastructure/designing-modern-private-cloud-network/>Designing a modern multi-tenant DC network</a>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section class="section share-icons">
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share Designing a networking platform for IaaS multi-tenancy on twitter" href="https://twitter.com/intent/tweet/?text=Designing%20a%20networking%20platform%20for%20IaaS%20multi-tenancy&url=https%3a%2f%2fblah.cloud%2finfrastructure%2fdesigning-networking-platform-iaas-multi-tenancy%2f&hashtags=architecture%2cdesign%2cnetworking%2cnsx%2cSDN%2cVMware"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Designing a networking platform for IaaS multi-tenancy on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fblah.cloud%2finfrastructure%2fdesigning-networking-platform-iaas-multi-tenancy%2f&title=Designing%20a%20networking%20platform%20for%20IaaS%20multi-tenancy"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share Designing a networking platform for IaaS multi-tenancy on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblah.cloud%2finfrastructure%2fdesigning-networking-platform-iaas-multi-tenancy%2f&title=Designing%20a%20networking%20platform%20for%20IaaS%20multi-tenancy&summary=Designing%20a%20networking%20platform%20for%20IaaS%20multi-tenancy&source=https%3a%2f%2fblah.cloud%2finfrastructure%2fdesigning-networking-platform-iaas-multi-tenancy%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
</div>
</section>
</footer><script src=https://utteranc.es/client.js repo=mylesagray/blog-comments issue-term=title theme=preferred-color-scheme crossorigin=anonymous async></script>
</article>
<aside class="hidden lg:block tableOfContentContainer" id=tableOfContentContainer>
<nav id=TableOfContents>
<ul>
<li><a href=#conceptual-design>Conceptual Design</a></li>
<li><a href=#logical-design>Logical Design</a></li>
<li><a href=#physical-design>Physical Design</a>
<ul>
<li><a href=#distributed-logical-router>Distributed Logical Router</a></li>
<li><a href=#dlr-to-esg>DLR to ESG</a></li>
<li><a href=#edge-services-gateway>Edge Services Gateway</a></li>
<li><a href=#upstream-routing>Upstream Routing</a></li>
</ul>
</li>
<li><a href=#conclusion>Conclusion</a></li>
</ul>
</nav>
</aside>
</div>
</main>
</div>
<footer class=footer>
<span>&copy; 2021 <a href=https://blah.cloud/>Blah, Cloud</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>