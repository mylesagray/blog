<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Using cloud-init for VM templating on vSphere | Blah, Cloud</title><meta name=keywords content="Kubernetes,VMware,vSphere,cloud-init,ova templating,govc"><meta name=description content="Step by step guide for using cloud-init on vSphere"><meta name=author content="Myles Gray"><link rel=canonical href=https://blah.cloud/infrastructure/using-cloud-init-for-vm-templating-on-vsphere/><link crossorigin=anonymous href=/assets/css/stylesheet.min.2b0d4bd71b38b0c4364c7b98559adecd0829c4e37ca61e04b82ba83922ea3ede.css integrity="sha256-Kw1L1xs4sMQ2THuYVZrezQgpxON8ph4EuCuoOSLqPt4=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/scroll-toc.min.c3439d5ba4b7e2fc9f6a9ce0d863c91fdf56d0d4d5cfe1f5762a2bdcfb69efd3.js integrity="sha256-w0OdW6S34vyfapzg2GPJH99W0NTVz+H1dior3Ptp79M="></script><link rel=icon href=https://blah.cloud/images/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blah.cloud/images/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blah.cloud/images/favicon-32x32.png><link rel=apple-touch-icon href=https://blah.cloud/images/apple-touch-icon.png><link rel=mask-icon href=https://blah.cloud/images/logo.png><meta name=theme-color media="(prefers-color-scheme: dark)" content="rgba(88, 89, 91, 1)"><meta name=theme-color content="rgba(240, 202, 102, 1)"><meta name=msapplication-TileColor content="rgba(240, 202, 102, 1)"><meta name=generator content="Hugo 0.149.0"><link rel=alternate hreflang=en href=https://blah.cloud/infrastructure/using-cloud-init-for-vm-templating-on-vsphere/><meta property="og:title" content="Using cloud-init for VM templating on vSphere"><meta property="og:description" content="Step by step guide for using cloud-init on vSphere"><meta property="og:type" content="article"><meta property="og:url" content="https://blah.cloud/infrastructure/using-cloud-init-for-vm-templating-on-vsphere/"><meta property="og:image" content="https://blah.cloud/infrastructure/using-cloud-init-for-vm-templating-on-vsphere/images/og-card.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-06-09T19:13:10+00:00"><meta property="article:modified_time" content="2021-10-25T15:15:00+00:00"><meta property="og:site_name" content="Blah, Cloud"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blah.cloud/infrastructure/using-cloud-init-for-vm-templating-on-vsphere/images/og-card.png"><meta name=twitter:title content="Using cloud-init for VM templating on vSphere"><meta name=twitter:description content="Step by step guide for using cloud-init on vSphere"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Using cloud-init for VM templating on vSphere","item":"https://blah.cloud/infrastructure/using-cloud-init-for-vm-templating-on-vsphere/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Using cloud-init for VM templating on vSphere","name":"Using cloud-init for VM templating on vSphere","description":"Step by step guide for using cloud-init on vSphere","keywords":["Kubernetes","VMware","vSphere","cloud-init","ova templating","govc"],"wordCount":"3930","inLanguage":"en","image":"https://blah.cloud/infrastructure/using-cloud-init-for-vm-templating-on-vsphere/images/Screenshot-2019-06-09-19.36.35.webp","datePublished":"2019-06-09T19:13:10Z","dateModified":"2021-10-25T15:15:00Z","author":{"@type":"Person","name":"Myles Gray","url":"https:\/\/blah.cloud\/about"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blah.cloud/infrastructure/using-cloud-init-for-vm-templating-on-vsphere/"},"copyrightHolder":"Myles Gray","copyrightYear":"2019","isFamilyFriendly":"true","publisher":{"@type":"Person","name":"Myles Gray","logo":{"@type":"ImageObject","url":"https://blah.cloud/images/me.jpg"}}}</script><script defer data-domain=blah.cloud data-api=/backend/api/event src=/backend/js/script.outbound-links.js></script><script>window.plausible=window.plausible||function(){(window.plausible.q=window.plausible.q||[]).push(arguments)}</script></head><body id=top><script>window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?(document.body.classList.add("dark"),document.body.classList.remove("light")):(document.body.classList.remove("dark"),document.body.classList.add("light"));const darkModeMediaQuery=window.matchMedia("(prefers-color-scheme: dark)");darkModeMediaQuery.addListener(e=>{const t=e.matches;t?(document.body.classList.add("dark"),document.body.classList.remove("light")):(document.body.classList.remove("dark"),document.body.classList.add("light"))})</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(240, 202, 102, 1);--secondary:rgba(216, 214, 197, 1);--tertiary:rgb(75, 75, 75);--content:rgba(206, 205, 188, 1);--hljs-bg:#282a36;--code-bg:#282a36;--border:rgba(240, 202, 102, 1);--highlight:rgba(88, 89, 91, 1)}.list{background:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://blah.cloud/ accesskey=h title="Blah, Cloud. (Alt + H)"><picture><source media="(min-width: 768px)" srcset=/images/logo-title.avif type=image/avif alt=logo width=245 height=34><source media="(min-width: 768px)" srcset=/images/logo-title.webp type=image/webp alt=logo width=245 height=34><source media="(min-width: 768px)" srcset=/images/logo-title.png type=image/png alt=logo width=245 height=34><source srcset=/images/logo.avif type=image/avif alt=logo width=65 height=65><source srcset=/images/logo.webp type=image/webp alt=logo width=65 height=65><img class=logo src=/images/logo-title.png alt=logo aria-label=logo width=245 height=34></picture></a></div><span class=logo-switches><ul class=lang-switch><li></li></ul></span><span class=hamburger><button id=hamburger-toggle accesskey=m title="(Alt + M)">
<svg width="24" height="28" viewBox="0 0 24 28"><path d="M24 21v2c0 .547-.453 1-1 1H1c-.547.0-1-.453-1-1v-2c0-.547.453-1 1-1h22c.547.0 1 .453 1 1zm0-8v2c0 .547-.453 1-1 1H1c-.547.0-1-.453-1-1v-2c0-.547.453-1 1-1h22c.547.0 1 .453 1 1zm0-8v2c0 .547-.453 1-1 1H1c-.547.0-1-.453-1-1V5c0-.547.453-1 1-1h22c.547.0 1 .453 1 1z"/></svg></button></span><ul id=menu><li><a href=https://blah.cloud/now/ title=now><span>now</span></a></li><li><a href=https://blah.cloud/blog/ title=blog><span>blog</span></a></li><li><a href=https://blah.cloud/bio/ title=bio><span>bio</span></a></li><li><a href=https://blah.cloud/works/ title=works><span>works</span></a></li><li><a href=https://blah.cloud/search/ title=" (Alt + /)" accesskey=/><span><svg style="height:1em" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="fill-current w-5" role="img" viewBox="0 0 512 512"><path d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></a></li></ul></nav></header><div class=container><main class=main><div class=wrapper><article class=post-single><header class=post-header><h1 class=post-title>Using cloud-init for VM templating on vSphere</h1><div class=post-description>Step by step guide for using cloud-init on vSphere</div><div class=post-meta>June 9, 2019 Myles Gray&nbsp;|&nbsp;<a href=https://github.com/mylesagray/blog/blob/master/content/posts/2019-06-09-using-cloud-init-for-vm-templating-on-vsphere/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><figure class=entry-cover><img srcset="https://blah.cloud/infrastructure/using-cloud-init-for-vm-templating-on-vsphere/images/Screenshot-2019-06-09-19.36.35_hu_12f662461f69f9d8.webp 360w ,https://blah.cloud/infrastructure/using-cloud-init-for-vm-templating-on-vsphere/images/Screenshot-2019-06-09-19.36.35_hu_23093cad452f2152.webp 480w ,https://blah.cloud/infrastructure/using-cloud-init-for-vm-templating-on-vsphere/images/Screenshot-2019-06-09-19.36.35_hu_e0c21b0e2732e507.webp 720w ,https://blah.cloud/infrastructure/using-cloud-init-for-vm-templating-on-vsphere/images/Screenshot-2019-06-09-19.36.35.webp 740w" sizes="(min-width: 768px) 720px, 100vw" src=https://blah.cloud/infrastructure/using-cloud-init-for-vm-templating-on-vsphere/images/Screenshot-2019-06-09-19.36.35.webp alt="vSphere events showing cloud-init customisation" width=740 height=172></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#prerequisites aria-label=Prerequisites>Prerequisites</a><ul><li><a href=#tools aria-label=Tools>Tools</a></li><li><a href=#resources aria-label=Resources>Resources</a></li></ul></li><li><a href=#setup aria-label=Setup>Setup</a><ul><li><a href=#govc aria-label=govc>govc</a></li></ul></li><li><a href=#extract-the-image-spec aria-label="Extract the image spec">Extract the image spec</a><ul><li><a href=#extract-the-ovf-spec-from-the-ova aria-label="Extract the OVF spec from the OVA">Extract the OVF spec from the OVA</a></li><li><a href=#customise-the-ovf-spec aria-label="Customise the OVF spec">Customise the OVF spec</a></li></ul></li><li><a href=#building-the-user-data-file aria-label="Building the user-data file">Building the user-data file</a><ul><li><a href=#setting-up-users-and-groups aria-label="Setting up users and groups">Setting up users and groups</a></li><li><a href=#adding-apt-repositories-and-installing-packages aria-label="Adding apt repositories and installing packages">Adding apt repositories and installing packages</a></li><li><a href=#writing-the-kubeadm-and-vsphereconf-template-files aria-label="Writing the kubeadm and vsphere.conf template files">Writing the kubeadm and vsphere.conf template files</a></li></ul></li><li><a href=#some-system-prep-commands-and-housekeeping aria-label="Some system-prep commands and housekeeping">Some system-prep commands and housekeeping</a><ul><li><a href=#running-arbitrary-commands aria-label="Running arbitrary commands">Running arbitrary commands</a></li></ul></li><li><a href=#encoding-the-data-and-deploying-the-template aria-label="Encoding the data and deploying the template">Encoding the data and deploying the template</a><ul><li><a href=#encoding-with-base64 aria-label="Encoding with base64">Encoding with base64</a></li><li><a href=#adding-the-base64-to-ubuntujson aria-label="Adding the base64 to ubuntu.json">Adding the base64 to ubuntu.json</a></li></ul></li><li><a href=#deploy-the-template-vm aria-label="Deploy the template VM">Deploy the template VM</a><ul><li><a href=#import-the-ova aria-label="Import the OVA">Import the OVA</a></li><li><a href=#vsphere-customisation-spec aria-label="vSphere customisation spec">vSphere customisation spec</a></li><li><a href=#deploy-some-vms aria-label="Deploy some VMs">Deploy some VMs</a></li><li><a href=#move-the-vms-into-a-folder aria-label="Move the VMs into a folder">Move the VMs into a folder</a></li></ul></li><li><a href=#run-kubeadm aria-label="Run kubeadm">Run kubeadm</a><ul><li><a href=#initialise-the-master aria-label="Initialise the master">Initialise the master</a></li><li><a href=#on-your-laptop aria-label="On your laptop">On your laptop</a></li><li><a href=#join-the-workers-to-the-cluster aria-label="Join the workers to the cluster">Join the workers to the cluster</a></li></ul></li><li><a href=#verify-setup aria-label="Verify setup">Verify setup</a></li><li><a href=#detatch-the-ovfspec-iso aria-label="Detatch the OVFSpec ISO">Detatch the OVFSpec ISO</a></li><li><a href=#conclusion aria-label=Conclusion>Conclusion</a></li><li><a href=#troubleshooting aria-label=Troubleshooting>Troubleshooting</a><ul><li><a href=#vmware-guest-os-customisation aria-label="VMware Guest OS Customisation">VMware Guest OS Customisation</a><ul><li><a href=#overview aria-label=Overview>Overview</a></li><li><a href=#vsphere aria-label=vSphere>vSphere</a></li><li><a href=#in-guest aria-label=In-guest>In-guest</a></li></ul></li><li><a href=#cloud-init aria-label=cloud-init>cloud-init</a></li></ul></li><li><a href=#references aria-label=References>References</a></li></ul></div></details></div><div class=post-content><p>This isn&rsquo;t necessarily a follow-on from the other three blogs so far in this series, but more of an alternative to <a href=/kubernetes/creating-an-ubuntu-18-04-lts-cloud-image-for-cloning-on-vmware/>parts one</a> and <a href=/kubernetes/setting-up-k8s-and-the-vsphere-cloud-provider-using-kubeadm/>two</a>. Following on from those I felt that the process could be much more automated, and less &ldquo;ssh into every box and change things manually&rdquo;. After all, the less changes we can make iteratively and <a href=https://codeburst.io/declarative-vs-imperative-programming-a8a7c93d9ad2 target=_blank>imperatively ↗</a>, the more it is programmed or declarative, the better.</p><p>This blog is one way to do that - I expect to have two or three more methods blogged in the near future that will offer futher options - with a particular focus on day-2.</p><p>So what are we doing this time, and how is it different?</p><p>There is a package called <code>cloud-init</code> that comes by default on &ldquo;<a href=http://cloud-images.ubuntu.com/ target=_blank>cloud images ↗</a>&rdquo; of most Linux operating systems these days, it&rsquo;s purpose is to do day-0 setup of operating systems, things like package installations, repository setup, SSH key additions, writing out to files and running arbitrary shell commands at first boot.</p><p>With that in mind, <code>cloud-init</code> covers basically everything we did in the <a href=/kubernetes/creating-an-ubuntu-18-04-lts-cloud-image-for-cloning-on-vmware/>first part</a> of the series and most of <a href=/kubernetes/setting-up-k8s-and-the-vsphere-cloud-provider-using-kubeadm/>the second</a>, it&rsquo;s much quicker and much more scalable, and quite recently VMware Tools added support for using <code>cloud-init</code> as it&rsquo;s customisation engine as an alternative to the default <code>perl</code> scripting, this means we can deploy one <a href=https://docs.vmware.com/en/VMware-vSphere/6.7/com.vmware.vsphere.vm_admin.doc/GUID-7EF678CD-3BB0-4AA8-8430-17C657F0CD40.html target=_blank>VM template ↗</a> to vSphere and use the built in cloning and <a href=https://docs.vmware.com/en/VMware-vSphere/6.7/com.vmware.vsphere.vm_admin.doc/GUID-7EF678CD-3BB0-4AA8-8430-17C657F0CD40.html target=_blank>customisations specs ↗</a> in vSphere to add networking and hostnames to the new VMs.</p><p><code>cloud-init</code> relies, for our purposes, on one file called <code>user-data</code> - but can also include a <code>meta-data</code> file, but that is handled in vSphere&rsquo;s case by the customisation specs.</p><h2 id=prerequisites>Prerequisites<a hidden class=anchor aria-hidden=true href=#prerequisites>#</a></h2><h3 id=tools>Tools<a hidden class=anchor aria-hidden=true href=#tools>#</a></h3><p>I am using macOS, so will be using the <code>brew</code> package manager to install and manage my tools, if you are using Linux or Windows, use the appropriate install guide for each tool, according to your OS.</p><p>For each tool I will list the <code>brew</code> install command and the link to the install instructions for other OSes.</p><ul><li>brew<ul><li><a href=https://brew.sh target=_blank>https://brew.sh ↗</a></li></ul></li><li>kubectl - <code>brew install kubernetes-cli</code><ul><li><a href=https://kubernetes.io/docs/tasks/tools/install-kubectl/ target=_blank>https://kubernetes.io/docs/tasks/tools/install-kubectl/ ↗</a></li></ul></li><li>Powershell - <code>brew tap caskroom/cask && brew cask install powershell</code><ul><li><a href=https://github.com/PowerShell/PowerShell target=_blank>https://github.com/PowerShell/PowerShell ↗</a></li></ul></li><li>PowerCLI - <code>pwsh</code> then <code>Install-Module -Name VMware.PowerCLI -Scope CurrentUser</code><ul><li><a href=https://code.vmware.com/web/dp/tool/vmware-powercli target=_blank>https://code.vmware.com/web/dp/tool/vmware-powercli ↗</a></li></ul></li><li>govc - <code>brew tap govmomi/tap/govc && brew install govmomi/tap/govc</code><ul><li><a href=https://github.com/vmware/govmomi/tree/master/govc target=_blank>https://github.com/vmware/govmomi/tree/master/govc ↗</a></li></ul></li></ul><h3 id=resources>Resources<a hidden class=anchor aria-hidden=true href=#resources>#</a></h3><p>Just like in part one, we are going to need the Ubuntu 18.04 LTS Cloud image OVA from Canonical&rsquo;s repo downloaded to our local machine in order to extract the OVF specifications from it, the OVA can be found here:</p><ul><li><a href=https://cloud-images.ubuntu.com/releases/18.04/release/ubuntu-18.04-server-cloudimg-amd64.ova target=_blank>https://cloud-images.ubuntu.com/releases/18.04/release/ubuntu-18.04-server-cloudimg-amd64.ova ↗</a></li></ul><h2 id=setup>Setup<a hidden class=anchor aria-hidden=true href=#setup>#</a></h2><h3 id=govc>govc<a hidden class=anchor aria-hidden=true href=#govc>#</a></h3><p>With the OVA downloaded, we need to configure a few variables for <code>govc</code> to connect to our vCenter, handily, rather than having to define them on the CLI for every command, we can just <code>export</code> them as variables to our current shell.</p><p>I created a file called <code>govcvars.sh</code> with the following content - create one for yourself filling in the relevant details:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cat govcvars.sh
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>GOVC_INSECURE</span><span class=o>=</span><span class=m>1</span> <span class=c1># Don&#39;t verify SSL certs on vCenter</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>GOVC_URL</span><span class=o>=</span>10.198.16.4 <span class=c1># vCenter IP/FQDN</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>GOVC_USERNAME</span><span class=o>=</span>administrator@vsphere.local <span class=c1># vCenter username</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>GOVC_PASSWORD</span><span class=o>=</span>P@ssw0rd <span class=c1># vCenter password</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>GOVC_DATASTORE</span><span class=o>=</span>vsanDatastore <span class=c1># Default datastore to deploy to</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>GOVC_NETWORK</span><span class=o>=</span><span class=s2>&#34;Cluster01-LAN-1-Routable&#34;</span> <span class=c1># Default network to deploy to</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>GOVC_RESOURCE_POOL</span><span class=o>=</span><span class=s1>&#39;cluster01/Resources&#39;</span> <span class=c1># Default resource pool to deploy to</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>GOVC_DATACENTER</span><span class=o>=</span>DC01 <span class=c1># I have multiple DCs in this VC, so i&#39;m specifying the default here</span>
</span></span></code></pre></div><p>Next, we need to load the variables into our current shell session:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>source</span> govcvars.sh
</span></span></code></pre></div><p>At this point we should be able to connect to and query our vCenter:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ govc about
</span></span><span class=line><span class=cl>Name:         VMware vCenter Server
</span></span><span class=line><span class=cl>Vendor:       VMware, Inc.
</span></span><span class=line><span class=cl>Version:      6.7.0
</span></span><span class=line><span class=cl>Build:        <span class=m>13639324</span>
</span></span><span class=line><span class=cl>OS type:      linux-x64
</span></span><span class=line><span class=cl>API type:     VirtualCenter
</span></span><span class=line><span class=cl>API version:  6.7.2
</span></span><span class=line><span class=cl>Product ID:   vpx
</span></span><span class=line><span class=cl>UUID:         dc0eaa5c-3460-49ef-aeb2-09e886ad333a
</span></span></code></pre></div><h2 id=extract-the-image-spec>Extract the image spec<a hidden class=anchor aria-hidden=true href=#extract-the-image-spec>#</a></h2><h3 id=extract-the-ovf-spec-from-the-ova>Extract the OVF spec from the OVA<a hidden class=anchor aria-hidden=true href=#extract-the-ovf-spec-from-the-ova>#</a></h3><p>Use <code>govc</code> to pull the OVF spec from the Ubuntu OVA we just downloaded, for customisation (this will output the spec to a file in your current directory called <code>ubuntu.json</code>):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>govc import.spec ~/Downloads/ubuntu-18.04-server-cloudimg-amd64.ova <span class=p>|</span> python -m json.tool &gt; ubuntu.json
</span></span></code></pre></div><h3 id=customise-the-ovf-spec>Customise the OVF spec<a hidden class=anchor aria-hidden=true href=#customise-the-ovf-spec>#</a></h3><p>This is where we diverge from part one, we are going to fill in only two fields here and the rest will be encoded in our <code>user-data</code> file that we&rsquo;ll get to in a bit.</p><p>Below, I only changed three things; <code>hostname</code>, <code>Network</code> and <code>Name</code>. These correlate to the in-guest name of the VM, the vSphere Port Group the VM will be attached to for networking on deployment, and the name of the VM when deployed (<strong>note</strong>: this is not the <code>hostname</code> of the VM, just the VM name itself).</p><p>Note, I have just cleared the <code>hostname</code> value, this is important and will be populated later by the vSphere customisation spec at clone-time.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=err>$</span> <span class=err>cat</span> <span class=err>ubuntu.json</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;DiskProvisioning&#34;</span><span class=p>:</span> <span class=s2>&#34;thin&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;IPAllocationPolicy&#34;</span><span class=p>:</span> <span class=s2>&#34;dhcpPolicy&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;IPProtocol&#34;</span><span class=p>:</span> <span class=s2>&#34;IPv4&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;PropertyMapping&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;Key&#34;</span><span class=p>:</span> <span class=s2>&#34;instance-id&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;Value&#34;</span><span class=p>:</span> <span class=s2>&#34;id-ovf&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;Key&#34;</span><span class=p>:</span> <span class=s2>&#34;hostname&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;Value&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;Key&#34;</span><span class=p>:</span> <span class=s2>&#34;seedfrom&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;Value&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;Key&#34;</span><span class=p>:</span> <span class=s2>&#34;public-keys&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;Value&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;Key&#34;</span><span class=p>:</span> <span class=s2>&#34;user-data&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;Value&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;Key&#34;</span><span class=p>:</span> <span class=s2>&#34;password&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;Value&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;NetworkMapping&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;Name&#34;</span><span class=p>:</span> <span class=s2>&#34;VM Network&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;Network&#34;</span><span class=p>:</span> <span class=s2>&#34;Cluster01-LAN-1-Routable&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;MarkAsTemplate&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;PowerOn&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;InjectOvfEnv&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;WaitForIP&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;Name&#34;</span><span class=p>:</span> <span class=s2>&#34;Ubuntu1804Template&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>With that set up, it&rsquo;s time to start building out our <code>user-data</code> file which does the bulk of the operating system setup and prep.</p><h2 id=building-the-user-data-file>Building the user-data file<a hidden class=anchor aria-hidden=true href=#building-the-user-data-file>#</a></h2><p><code>cloud-init</code> has a very rich set of built-in supported primitives for OS setup, you can see a mostly <a href=https://cloudinit.readthedocs.io/en/latest/topics/examples.html target=_blank>complete list here ↗</a> (it is also extensible via plugins).</p><p>A note before we get into this - &ldquo;cloud-images&rdquo; are not meant to be logged into with a password <em>ever</em>, you are expected to use SSH public-key authentication. So you will need to grab your SSH public key for the upcoming work.</p><p>You can get your SSH public key by running <code>cat ~/.ssh/id_rsa.pub</code> - note if you run this command and you don&rsquo;t get an output - you probably need to generate an SSH key with <code>ssh-keygen</code>.</p><p>All of the below sections should be added to a single file called <code>user-data</code> on your local system, we will be encoding it as a single entity later on, but as you follow, just keep appending all the sections together in that one file.</p><h3 id=setting-up-users-and-groups>Setting up users and groups<a hidden class=anchor aria-hidden=true href=#setting-up-users-and-groups>#</a></h3><p><code>user-data</code> is entirely written in yaml, so spacing and indentation is critical here.</p><p>The below snippet is actually very simple, it adds a group to the OS called <code>docker</code> and changes the default user <code>ubuntu</code> to add a trusted SSH public key, as well as add it to the <code>sudo</code> group with no-password escalation, adds the user to the <code>docker</code> group that was just created and sets the default shell for the user to <code>bash</code>.</p><p>Note, you can add multiple SSH keys to a user for login (say if you have two laptops) by simply adding another line item under the <code>ssh-authorized-keys</code> key.</p><p>This is where you would want to take the output of <code>cat ~/.ssh/id_rsa.pub</code> and insert it into the code - you can see the SSH public key for my laptop below as an example.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>groups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>docker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>users</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ubuntu</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ssh-authorized-keys</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDcxQcNS5vzxHn2sdHHw/nTHWiME5OWv1i3cvMdqMUWKhPSv7uHCTz3Q4kot8UvdD/jIDOktIpDlayVeXkxAuMzIB0lbVEku1mjLyDQ0syGVSAvj4BkH2uLp0Hybc97U0PQHYgLy60d2l8c96qajPHxRmDYRKbCQaNxQeafxwlQUzr615RvzjOgt5v7zhdZ+V5pIDH2Amf/rRiPrq0NLTYShpoRwtFeS4bQtG5mHfDDvzg+Jh1Sxt63oB0AGy0ORv7GzSDlqraFADxOwFnKz0/fbVKeauFCFXRKrral+PSRgbr39cVJHykaYVDw9D3nKMZqDKITRXAJiWAEES91yk6nikAwgyXup+wpiymMmgUq60ASHgpTqWbtPdEZAsjtlhJXSDit+iWS1yrdLg5ayza8PAr5YijT0g+xMkJXudxgGOr913Oty04Fxk61n3kcjadsbt5hjc3QWxK0Rj0jJK9HwV2sn8lHVdvSfwOkgZLH7WH4E2IBGQVm+4Cd8RLMsAev5tnWGIiSLl2uRi63+mKwynIriSAAdWurrs11Q36qYrdwPK2XXq/MvUcTnm3yXSLjeSLWMmdoyqiLqxerOiBcMRbTwvVwfe73UJXdLPbfA0xqAB/gTg2NxmcAI/F3OEWMRM4/PsqPS2t/VAL993OdSshHGtT30AP86G+vuHuecw== mylesg@vmware.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>sudo</span><span class=p>:</span><span class=w> </span><span class=l>ALL=(ALL) NOPASSWD:ALL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>groups</span><span class=p>:</span><span class=w> </span><span class=l>sudo, docker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class=l>/bin/bash</span><span class=w>
</span></span></span></code></pre></div><h3 id=adding-apt-repositories-and-installing-packages>Adding apt repositories and installing packages<a hidden class=anchor aria-hidden=true href=#adding-apt-repositories-and-installing-packages>#</a></h3><p>Next up, as we&rsquo;re making a base image for Kubernetes cluters, we are going to add two repositories - one for Kubernetes and one for Docker. I found the easiest way to add them is by using the <code>keyid</code> rather than the GPG key in it&rsquo;s entirety, it&rsquo;s much smaller and less error prone.</p><p>The documentation for each module is here: <a href=https://cloudinit.readthedocs.io/en/latest/topics/modules.html#apt-configure target=_blank><code>apt</code> ↗</a>, <a href=https://cloudinit.readthedocs.io/en/latest/topics/modules.html#package-update-upgrade-install target=_blank><code>package_upgrade</code>, <code>packages</code> ↗</a>.</p><p>To briefly go over what&rsquo;s happening below: we are adding the two repositories for K8s and Docker to <code>apt</code> and trusting them by adding the GPG key ids for each. Next up, we tell the OS to upgrade all packages on boot and finally, we tell the OS to install four packages; <code>kubelet</code>, <code>kubectl</code>, <code>kubeadm</code> and <code>docker-ce</code> at specific target versions (in this case, for K8s v1.14.2 and the supported Docker runtime version).</p><p>The neat thing about this is, if you ever want to change the base packages that come on your OS (like when kubernetes or docker get upgraded) - you would simply update the version strings next to each package and deploy the OVA again with the new spec attached, rather than having to rebuild an image manually and in its entirety via SSH.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apt</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>sources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kubernetes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>source</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;deb http://apt.kubernetes.io/ kubernetes-xenial main&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>keyserver</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;hkp://keyserver.ubuntu.com:80&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>keyid</span><span class=p>:</span><span class=w> </span><span class=l>BA07F4FB</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>docker</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>arches</span><span class=p>:</span><span class=w> </span><span class=l>amd64</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>source</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;deb https://download.docker.com/linux/ubuntu bionic stable&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>keyserver</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;hkp://keyserver.ubuntu.com:80&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>keyid</span><span class=p>:</span><span class=w> </span><span class=l>0EBFCD88</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>package_upgrade</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>packages</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=p>[</span><span class=l>kubelet, 1.14.3-00]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=p>[</span><span class=l>kubectl, 1.14.3-00]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=p>[</span><span class=l>kubeadm, 1.14.3-00]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=p>[</span><span class=l>docker-ce, &#39;5:18.09.6~3-0~ubuntu-bionic&#39;]</span><span class=w>
</span></span></span></code></pre></div><h3 id=writing-the-kubeadm-and-vsphereconf-template-files>Writing the kubeadm and vsphere.conf template files<a hidden class=anchor aria-hidden=true href=#writing-the-kubeadm-and-vsphereconf-template-files>#</a></h3><p>This section may look unwieldy and complex, but it&rsquo;s actually one of the simplest to understand. In this instance we are using the <a href=https://cloudinit.readthedocs.io/en/latest/topics/modules.html#write-files target=_blank><code>write_files</code> module ↗</a> and specifying a <code>file path</code> as well as the content to go inside that file, simple!</p><p>There are four files in total here:</p><p>The first one <code>/etc/docker/daemon.json</code> to create the Docker daemon config as-per the <a href=https://kubernetes.io/docs/setup/cri/#docker target=_blank>K8s docs ↗</a>.</p><p>Next up, <code>/etc/kubernetes/kubeadminitmaster.yaml</code> for the <code>kubeadm</code> master initialisation where we specify things like the <code>token</code> to use for cluster membership and <code>kubeadm join</code> operations, the K8s version to install, the <code>cloud-provider</code> name and config location as well as the <code>pod</code> networking overlay subnet. For further explaination on these, check out <a href=/kubernetes/setting-up-k8s-and-the-vsphere-cloud-provider-using-kubeadm/>my previous article</a> on this.</p><p>The third file is <code>/etc/kubernetes/kubeadminitworker.yaml</code> which tells the worker nodes how to join the K8s cluster, by specifying the same <code>token</code> as in the last file, the same <code>cloud-provider</code> configuration and introduces the <code>discovery.yaml</code> file, which tells the workers what IP address to access the master on and what credentials to use to log into it (more on that in a little bit).</p><p>Up to this point, you could have copied and pasted the below config verbatim with zero ill-effect. The fourth file however, requires a little customisation. This is the <code>cloud-provider</code> config file for the vSphere Cloud Provider and you&rsquo;ll need to fill in your own environment details here. It will live at <code>/etc/kubernetes/vsphere.conf</code>.</p><p>You&rsquo;ll probably notice that the config looks almost identical as the <code>govcvars.sh</code> file from above, and that&rsquo;s because it&rsquo;s the same environment! So fill this section in with details like your vCenter IP, username, password, Datacenter name, Resource pool and network. A full rundown of the <a href=https://vmware.github.io/vsphere-storage-for-kubernetes/documentation/existing.html target=_blank>config options can be found here ↗</a>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>write_files</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>content</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>        {
</span></span></span><span class=line><span class=cl><span class=sd>          &#34;exec-opts&#34;: [&#34;native.cgroupdriver=systemd&#34;],
</span></span></span><span class=line><span class=cl><span class=sd>          &#34;log-driver&#34;: &#34;json-file&#34;,
</span></span></span><span class=line><span class=cl><span class=sd>          &#34;log-opts&#34;: {
</span></span></span><span class=line><span class=cl><span class=sd>            &#34;max-size&#34;: &#34;100m&#34;
</span></span></span><span class=line><span class=cl><span class=sd>          },
</span></span></span><span class=line><span class=cl><span class=sd>          &#34;storage-driver&#34;: &#34;overlay2&#34;
</span></span></span><span class=line><span class=cl><span class=sd>        }</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/etc/docker/daemon.json</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>content</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>        apiVersion: kubeadm.k8s.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=sd>        kind: InitConfiguration
</span></span></span><span class=line><span class=cl><span class=sd>        bootstrapTokens:
</span></span></span><span class=line><span class=cl><span class=sd>              - groups:
</span></span></span><span class=line><span class=cl><span class=sd>                - system:bootstrappers:kubeadm:default-node-token
</span></span></span><span class=line><span class=cl><span class=sd>                token: y7yaev.9dvwxx6ny4ef8vlq
</span></span></span><span class=line><span class=cl><span class=sd>                ttl: 0s
</span></span></span><span class=line><span class=cl><span class=sd>                usages:
</span></span></span><span class=line><span class=cl><span class=sd>                - signing
</span></span></span><span class=line><span class=cl><span class=sd>                - authentication
</span></span></span><span class=line><span class=cl><span class=sd>        nodeRegistration:
</span></span></span><span class=line><span class=cl><span class=sd>          kubeletExtraArgs:
</span></span></span><span class=line><span class=cl><span class=sd>            cloud-provider: &#34;vsphere&#34;
</span></span></span><span class=line><span class=cl><span class=sd>            cloud-config: &#34;/etc/kubernetes/vsphere.conf&#34;
</span></span></span><span class=line><span class=cl><span class=sd>        ---
</span></span></span><span class=line><span class=cl><span class=sd>        apiVersion: kubeadm.k8s.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=sd>        kind: ClusterConfiguration
</span></span></span><span class=line><span class=cl><span class=sd>        kubernetesVersion: v1.14.3
</span></span></span><span class=line><span class=cl><span class=sd>        apiServer:
</span></span></span><span class=line><span class=cl><span class=sd>          extraArgs:
</span></span></span><span class=line><span class=cl><span class=sd>            cloud-provider: &#34;vsphere&#34;
</span></span></span><span class=line><span class=cl><span class=sd>            cloud-config: &#34;/etc/kubernetes/vsphere.conf&#34;
</span></span></span><span class=line><span class=cl><span class=sd>          extraVolumes:
</span></span></span><span class=line><span class=cl><span class=sd>          - name: cloud
</span></span></span><span class=line><span class=cl><span class=sd>            hostPath: &#34;/etc/kubernetes/vsphere.conf&#34;
</span></span></span><span class=line><span class=cl><span class=sd>            mountPath: &#34;/etc/kubernetes/vsphere.conf&#34;
</span></span></span><span class=line><span class=cl><span class=sd>        controllerManager:
</span></span></span><span class=line><span class=cl><span class=sd>          extraArgs:
</span></span></span><span class=line><span class=cl><span class=sd>            cloud-provider: &#34;vsphere&#34;
</span></span></span><span class=line><span class=cl><span class=sd>            cloud-config: &#34;/etc/kubernetes/vsphere.conf&#34;
</span></span></span><span class=line><span class=cl><span class=sd>          extraVolumes:
</span></span></span><span class=line><span class=cl><span class=sd>          - name: cloud
</span></span></span><span class=line><span class=cl><span class=sd>            hostPath: &#34;/etc/kubernetes/vsphere.conf&#34;
</span></span></span><span class=line><span class=cl><span class=sd>            mountPath: &#34;/etc/kubernetes/vsphere.conf&#34;
</span></span></span><span class=line><span class=cl><span class=sd>        networking:
</span></span></span><span class=line><span class=cl><span class=sd>          podSubnet: &#34;10.244.0.0/16&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/etc/kubernetes/kubeadminitmaster.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>content</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>        apiVersion: kubeadm.k8s.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=sd>        discovery:
</span></span></span><span class=line><span class=cl><span class=sd>          file:
</span></span></span><span class=line><span class=cl><span class=sd>            kubeConfigPath: discovery.yaml
</span></span></span><span class=line><span class=cl><span class=sd>          timeout: 5m0s
</span></span></span><span class=line><span class=cl><span class=sd>          tlsBootstrapToken: y7yaev.9dvwxx6ny4ef8vlq
</span></span></span><span class=line><span class=cl><span class=sd>        kind: JoinConfiguration
</span></span></span><span class=line><span class=cl><span class=sd>        nodeRegistration:
</span></span></span><span class=line><span class=cl><span class=sd>          kubeletExtraArgs:
</span></span></span><span class=line><span class=cl><span class=sd>            cloud-provider: vsphere</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/etc/kubernetes/kubeadminitworker.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>content</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>           [Global]
</span></span></span><span class=line><span class=cl><span class=sd>            user = &#34;administrator@vsphere.local&#34;
</span></span></span><span class=line><span class=cl><span class=sd>            password = &#34;P@ssw0rd&#34;
</span></span></span><span class=line><span class=cl><span class=sd>            port = &#34;443&#34;
</span></span></span><span class=line><span class=cl><span class=sd>            insecure-flag = &#34;1&#34;
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>            [VirtualCenter &#34;10.198.16.4&#34;]
</span></span></span><span class=line><span class=cl><span class=sd>            datacenters = &#34;DC01&#34;
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>            [Workspace]
</span></span></span><span class=line><span class=cl><span class=sd>            server = &#34;10.198.16.4&#34;
</span></span></span><span class=line><span class=cl><span class=sd>            datacenter = &#34;DC01&#34;
</span></span></span><span class=line><span class=cl><span class=sd>            default-datastore = &#34;vsanDatastore&#34;
</span></span></span><span class=line><span class=cl><span class=sd>            resourcepool-path = &#34;cluster01/Resources&#34;
</span></span></span><span class=line><span class=cl><span class=sd>            folder = &#34;k8s&#34;
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>            [Disk]
</span></span></span><span class=line><span class=cl><span class=sd>            scsicontrollertype = pvscsi
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>            [Network]
</span></span></span><span class=line><span class=cl><span class=sd>            public-network = &#34;Cluster01-LAN-1-Routable&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/etc/kubernetes/vsphere.conf</span><span class=w>
</span></span></span></code></pre></div><h2 id=some-system-prep-commands-and-housekeeping>Some system-prep commands and housekeeping<a hidden class=anchor aria-hidden=true href=#some-system-prep-commands-and-housekeeping>#</a></h2><p>Because the system is going to be booted once on import to set up VMware Tools and customisation specs - we need to run a few commands to clean up any uniqueness in the OS as well as set up some K8s-specific pre-requisites.</p><h3 id=running-arbitrary-commands>Running arbitrary commands<a hidden class=anchor aria-hidden=true href=#running-arbitrary-commands>#</a></h3><p>The below <a href=https://cloudinit.readthedocs.io/en/latest/topics/modules.html#runcmd target=_blank><code>runcmd</code> module ↗</a> allows us to use <code>cloud-init</code> to run commands on the OS boot, they usually run last in the chain after the other modules.</p><p>To run through them in order we are:</p><ul><li>Turning off Swap on the OS</li><li>Persisting the <code>swapoff</code> operation by removing it from the filesystem mounts</li><li>Creating a Docker daemon <code>systemd</code> file location</li><li>Reloading the <code>systemd</code> config files</li><li>Restarting the <code>docker</code> service</li><li>Allowing IPv4 bridge traffic to traverse <code>iptables</code> (<a href=https://kubernetes.io/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/#network-plugin-requirements target=_blank>required by most CNIs ↗</a>)</li><li>Allowing IPv6 bridge traffic to traverse <code>iptables</code> (<a href=https://kubernetes.io/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/#network-plugin-requirements target=_blank>required by most CNIs ↗</a>)</li><li>Enabling vSphere customiation to call <code>cloud-init</code> - <a href=https://github.com/vmware/open-vm-tools/issues/240#issuecomment-395652692 target=_blank>reference ↗</a></li><li>Don&rsquo;t clear <code>/tmp</code> on reboot for customisation - <a href=https://github.com/vmware/open-vm-tools/issues/240#issuecomment-395652692 target=_blank>reference ↗</a></li><li>Clear the <code>machine-id</code> to ensure the cloned VMs get unique <a href=https://unix.stackexchange.com/a/419322/24359 target=_blank>IDs and IP addresses ↗</a>.</li></ul><p>With all the commands run, we <a href=https://cloudinit.readthedocs.io/en/latest/topics/modules.html#final-message target=_blank>post a <code>final_message</code> ↗</a> to state the system is prepped and how long it took.</p><p>And finally, we shutdown the VM via the <a href=https://cloudinit.readthedocs.io/en/latest/topics/modules.html#power-state-change target=_blank><code>power_state</code> module ↗</a> when everything is run, allowing a max of 30s for processes to terminate.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>runcmd</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>swapoff --all</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>sed -ri &#39;/\sswap\s/s/^#?/#/&#39; /etc/fstab</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>mkdir -p /etc/systemd/system/docker.service.d</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>systemctl daemon-reload</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>systemctl restart docker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>sysctl net.bridge.bridge-nf-call-iptables=1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>sysctl net.bridge.bridge-nf-call-ip6tables=1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s1>&#39;echo &#34;disable_vmware_customization: false&#34; &gt;&gt; /etc/cloud/cloud.cfg&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>sed -i &#39;s/D \/tmp 1777 root root -/#D \/tmp 1777 root root -/g&#39; /usr/lib/tmpfiles.d/tmp.conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>echo -n &gt; /etc/machine-id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>final_message</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;The system is prepped, after $UPTIME seconds&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>power_state</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=l>poweroff</span><span class=w>
</span></span></span></code></pre></div><p>With your <code>user-data</code> fully built, if you like you can validate it using the Ubuntu <code>cloud-init</code> tool as below - this step is optional, but it&rsquo;s worth doing to make sure it parses correctly:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cloud-init devel schema --config-file my-user-data-file.txt
</span></span></code></pre></div><h2 id=encoding-the-data-and-deploying-the-template>Encoding the data and deploying the template<a hidden class=anchor aria-hidden=true href=#encoding-the-data-and-deploying-the-template>#</a></h2><p>Now that our full <code>user-data</code> file is built (<a href=https://gist.github.com/b61c0cc77605158a797cc59080e6fe07 target=_blank>full example here ↗</a>) we need to encode it in <code>base64</code> to allow us to put it into the <code>ubuntu.json</code> file at the start (almost forgot about that, didn&rsquo;t ya?).</p><h3 id=encoding-with-base64>Encoding with base64<a hidden class=anchor aria-hidden=true href=#encoding-with-base64>#</a></h3><p>This is very easy, to verify it gets encoded properly, we&rsquo;ll run a decode and the output should be the same as your <code>user-data</code> file - spacing and all.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>base64 user-data <span class=p>|</span> base64 -D <span class=c1># Note - on Linux it&#39;s lowercase -d</span>
</span></span></code></pre></div><p>If all is well, run it again without the decode and copy the <code>base64</code> encoded string it outputs:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>base64 user-data
</span></span></code></pre></div><h3 id=adding-the-base64-to-ubuntujson>Adding the base64 to ubuntu.json<a hidden class=anchor aria-hidden=true href=#adding-the-base64-to-ubuntujson>#</a></h3><p>With the output from above copied, paste it into the <code>user-data</code> section of the <code>ubuntu.json</code> file in the <code>Value</code> field. You can see my <a href=https://gist.github.com/f250efff3be83e44626c14203a2f3268 target=_blank>finished <code>ubuntu.json</code> example here ↗</a>.</p><p>It essentially looks something like this (but a lot longer):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;Key&#34;</span><span class=p>:</span> <span class=s2>&#34;user-data&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;Value&#34;</span><span class=p>:</span> <span class=s2>&#34;I2Nsb3VkLWNvbmZpZwpjaHBhc3N3ZDoKICAgIGxpc3Q6IHwKICAgICAgdWJ1bnR1OlZNd2FyZTEhCiAgICBleHBpcmU6IGZh...Y29uZHMiCnBvd2VyX3N0YXRlOgogIHRpbWVvdXQ6IDMwCiAgbW9kZTogcG93ZXJvZmY=&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span><span class=err>,</span>
</span></span></code></pre></div><h2 id=deploy-the-template-vm>Deploy the template VM<a hidden class=anchor aria-hidden=true href=#deploy-the-template-vm>#</a></h2><p>Now that the <code>ubuntu.json</code> is complete and includes all our <code>user-data</code> options encoded in <code>base64</code>, it&rsquo;s time to deploy the template VM all the other will be cloned from.</p><h3 id=import-the-ova>Import the OVA<a hidden class=anchor aria-hidden=true href=#import-the-ova>#</a></h3><p>Deploy the OVA with the spec attached:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>govc import.ova -options<span class=o>=</span>ubuntu.json ~/Downloads/ubuntu-18.04-server-cloudimg-amd64.ova
</span></span></code></pre></div><p><strong>Note:</strong> When deploying you&rsquo;ll see this output, that is expected and can be safely ignored:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Warning: Line 107: Unable to parse <span class=s1>&#39;enableMPTSupport&#39;</span> <span class=k>for</span> attribute <span class=s1>&#39;key&#39;</span> on element <span class=s1>&#39;Config&#39;</span>.
</span></span></code></pre></div><p>Update the VM to have a larger disk and more CPUs and RAM:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>govc vm.change -vm Ubuntu1804Template -c <span class=m>4</span> -m <span class=m>4096</span> -e<span class=o>=</span><span class=s2>&#34;disk.enableUUID=1&#34;</span>
</span></span><span class=line><span class=cl>govc vm.disk.change -vm Ubuntu1804Template -disk.label <span class=s2>&#34;Hard disk 1&#34;</span> -size 60G
</span></span></code></pre></div><p>Power on the VM and allow customisation to run (it&rsquo;ll auto-shut down when done, as we specified in <code>user-data</code>) this should take around 3-4 minutes, maximum:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>govc vm.power -on<span class=o>=</span><span class=nb>true</span> Ubuntu1804Template
</span></span></code></pre></div><p>Wait for the VM to shut down and mark the VM as a template for cloning:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=k>until</span> govc vm.info -json Ubuntu1804Template <span class=p>|</span> jq -r <span class=s1>&#39;.VirtualMachines[].Runtime.PowerState&#39;</span> <span class=p>|</span> grep -q  <span class=s2>&#34;poweredOff&#34;</span><span class=p>;</span> <span class=k>do</span> sleep 5<span class=p>;</span> <span class=k>done</span>
</span></span><span class=line><span class=cl>govc vm.markastemplate Ubuntu1804Template
</span></span></code></pre></div><h3 id=vsphere-customisation-spec>vSphere customisation spec<a hidden class=anchor aria-hidden=true href=#vsphere-customisation-spec>#</a></h3><p>At this point we need to create our vSphere Customisation Spec we talked about at the start, this is very simple and currently requires PowerShell and PowerCLI, but this functionality may get included in <code>govc</code> if there is <a href=https://github.com/vmware/govmomi/issues/984 target=_blank>enough interest ↗</a>.</p><p>Start up PowerShell and create a guest customisation spec</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pwsh
</span></span></code></pre></div><p>I am connecting to my vCenter from above, creating a customisation spec called <code>Ubuntu</code> and using my internal DNS servers as well as domain name and setting the <code>hostname</code> to be the same as the VM name (advised) - but customise whichever way you see fit:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>&gt;</span> <span class=nb>Connect-VIServer</span> <span class=mf>10.198</span><span class=p>.</span><span class=py>16</span><span class=p>.</span><span class=py>4</span> <span class=n>-User</span> <span class=n>administrator</span><span class=nv>@vsphere</span><span class=p>.</span><span class=py>local</span> <span class=n>-Password</span> <span class=n>P</span><span class=nv>@ssw0rd</span>
</span></span><span class=line><span class=cl><span class=p>&gt;</span> <span class=nb>New-OSCustomizationSpec</span> <span class=n>-Name</span> <span class=n>Ubuntu</span> <span class=n>-OSType</span> <span class=n>Linux</span> <span class=n>-DnsServer</span> <span class=mf>10.198</span><span class=p>.</span><span class=py>16</span><span class=p>.</span><span class=mf>1</span><span class=p>,</span><span class=mf>10.198</span><span class=p>.</span><span class=py>16</span><span class=p>.</span><span class=py>2</span> <span class=n>-DnsSuffix</span> <span class=n>satm</span><span class=p>.</span><span class=py>eng</span><span class=p>.</span><span class=py>vmware</span><span class=p>.</span><span class=py>com</span> <span class=n>-Domain</span> <span class=n>satm</span><span class=p>.</span><span class=py>eng</span><span class=p>.</span><span class=py>vmware</span><span class=p>.</span><span class=py>com</span> <span class=n>-NamingScheme</span> <span class=n>vm</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Name</span>                                         <span class=n>Description</span> <span class=nb>Type </span>         <span class=n>OSType</span>  <span class=n>LastUpdate</span>           <span class=n>Server</span>
</span></span><span class=line><span class=cl><span class=p>----</span>                                         <span class=p>-----------</span> <span class=p>----</span>          <span class=p>------</span>  <span class=p>----------</span>           <span class=p>------</span>
</span></span><span class=line><span class=cl><span class=n>Ubuntu</span>                                                   <span class=n>Persistent</span>    <span class=n>Linux</span>   <span class=mf>27</span><span class=p>/</span><span class=mf>01</span><span class=p>/</span><span class=mf>2019</span> <span class=mf>21</span><span class=err>:</span><span class=mf>43</span><span class=err>:</span><span class=mf>40</span>  <span class=mf>10.198</span><span class=p>.</span><span class=py>17</span><span class=p>.</span><span class=py>160</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&gt;</span> <span class=n>exit</span>
</span></span></code></pre></div><h3 id=deploy-some-vms>Deploy some VMs<a hidden class=anchor aria-hidden=true href=#deploy-some-vms>#</a></h3><p>With that done, we can now clone as we see fit.</p><p>I&rsquo;d recommend you deploy a test VM first, just to make sure the customisation works as you expect - if not, see my &ldquo;Troubleshooting&rdquo; section at the bottom of this blog.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>govc vm.clone -vm Ubuntu1804Template -customization<span class=o>=</span>Ubuntu customisation-test
</span></span></code></pre></div><p>I&rsquo;m going to create a single master and three workers by specifying the template VM and the vSphere customisation spec we just defined above. The last command will check for IP addresses for the new nodes every 10 seconds:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>govc vm.clone -vm Ubuntu1804Template -customization<span class=o>=</span>Ubuntu k8s-master01
</span></span><span class=line><span class=cl>govc vm.clone -vm Ubuntu1804Template -customization<span class=o>=</span>Ubuntu k8s-worker01
</span></span><span class=line><span class=cl>govc vm.clone -vm Ubuntu1804Template -customization<span class=o>=</span>Ubuntu k8s-worker02
</span></span><span class=line><span class=cl>govc vm.clone -vm Ubuntu1804Template -customization<span class=o>=</span>Ubuntu k8s-worker03
</span></span><span class=line><span class=cl>watch -n <span class=m>10</span> <span class=s2>&#34;govc find / -type m -name &#39;k8s*&#39; | xargs govc vm.ip -a -v4 -wait 10m&#34;</span>
</span></span></code></pre></div><h3 id=move-the-vms-into-a-folder>Move the VMs into a folder<a hidden class=anchor aria-hidden=true href=#move-the-vms-into-a-folder>#</a></h3><p>Let&rsquo;s move the VMs into the folder that was specified in the <code>vsphere.conf</code> above, for cleanliness. You&rsquo;ll need to adjust this to match your datacenter and folder names:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>govc folder.create /DC01/vm/k8s
</span></span><span class=line><span class=cl>govc object.mv /DC01/vm/k8s-<span class=se>\*</span> /DC01/vm/k8s
</span></span></code></pre></div><h2 id=run-kubeadm>Run kubeadm<a hidden class=anchor aria-hidden=true href=#run-kubeadm>#</a></h2><p>Now that the VMs are deployed, we can SSH into them and set up K8s. At this point the setup is basically identical to the &ldquo;Initialising the clusterwith kubeadm&rdquo; sectino of <a href=/kubernetes/setting-up-k8s-and-the-vsphere-cloud-provider-using-kubeadm/>part two</a> of the series, but i&rsquo;ve condensed the outputs and included the broad steps here for brevity.</p><h3 id=initialise-the-master>Initialise the master<a hidden class=anchor aria-hidden=true href=#initialise-the-master>#</a></h3><p>First, SSH into the master node (on whatever IP you got from above):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ssh ubuntu@10.198.25.84
</span></span></code></pre></div><p>Run the kubeadm initialisation using the file that was part of our <code>user-data</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo kubeadm init --config /etc/kubernetes/kubeadminitmaster.yaml
</span></span></code></pre></div><p>Import the <code>kubeconfig</code> file from the master:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir -p <span class=nv>$HOME</span>/.kube
</span></span><span class=line><span class=cl>sudo cp -i /etc/kubernetes/admin.conf <span class=nv>$HOME</span>/.kube/config
</span></span><span class=line><span class=cl>sudo chown <span class=k>$(</span>id -u<span class=k>)</span>:<span class=k>$(</span>id -g<span class=k>)</span> <span class=nv>$HOME</span>/.kube/config
</span></span></code></pre></div><p>Ensure the master initialised:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get nodes -o wide
</span></span><span class=line><span class=cl>NAME           STATUS   ROLES    AGE   VERSION   INTERNAL-IP    EXTERNAL-IP    OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME
</span></span><span class=line><span class=cl>k8s-master01   Ready    master   14m   v1.14.3   10.198.25.84   10.198.25.84   Ubuntu 18.04.2 LTS   4.15.0-51-generic   docker://18.9.6
</span></span></code></pre></div><p>Deploy <code>flannel</code> pod overlay networking so the pods can communicate with each other.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/bc79dd1505b0c8681ece4de4c0d86c5cd2643275/Documentation/kube-flannel.yml
</span></span></code></pre></div><p>Check to make sure the pods are all in the status <code>Running</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get pods --all-namespaces
</span></span><span class=line><span class=cl>NAMESPACE     NAME                                   READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>kube-system   coredns-fb8b8dccf-jwrr9                1/1     Running   <span class=m>0</span>          12m
</span></span><span class=line><span class=cl>kube-system   coredns-fb8b8dccf-ktqf4                1/1     Running   <span class=m>0</span>          12m
</span></span><span class=line><span class=cl>kube-system   etcd-k8s-master01                      1/1     Running   <span class=m>0</span>          11m
</span></span><span class=line><span class=cl>kube-system   kube-apiserver-k8s-master01            1/1     Running   <span class=m>0</span>          11m
</span></span><span class=line><span class=cl>kube-system   kube-controller-manager-k8s-master01   1/1     Running   <span class=m>0</span>          11m
</span></span><span class=line><span class=cl>kube-system   kube-flannel-ds-amd64-d8fhm            1/1     Running   <span class=m>0</span>          77s
</span></span><span class=line><span class=cl>kube-system   kube-proxy-kfmbr                       1/1     Running   <span class=m>0</span>          12m
</span></span><span class=line><span class=cl>kube-system   kube-scheduler-k8s-master01            1/1     Running   <span class=m>0</span>          11m
</span></span></code></pre></div><p>Export the master node config used to point the workers being joined to the master:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl -n kube-public get configmap cluster-info -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.data.kubeconfig}&#39;</span> &gt; discovery.yaml
</span></span></code></pre></div><h3 id=on-your-laptop>On your laptop<a hidden class=anchor aria-hidden=true href=#on-your-laptop>#</a></h3><p>Copy the <code>discovery.yaml</code> to your local machine with <code>scp</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>scp ubuntu@10.198.25.84:~/discovery.yaml discovery.yaml
</span></span></code></pre></div><p>Then upload it to the worker nodes.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>scp discovery.yaml ubuntu@10.198.25.92:~/discovery.yaml
</span></span><span class=line><span class=cl>scp discovery.yaml ubuntu@10.198.25.93:~/discovery.yaml
</span></span><span class=line><span class=cl>scp discovery.yaml ubuntu@10.198.25.94:~/discovery.yaml
</span></span></code></pre></div><h3 id=join-the-workers-to-the-cluster>Join the workers to the cluster<a hidden class=anchor aria-hidden=true href=#join-the-workers-to-the-cluster>#</a></h3><p>SSH into each worker node and run the following to join them to the K8s cluster:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo kubeadm join --config /etc/kubernetes/kubeadminitworker.yaml
</span></span></code></pre></div><h2 id=verify-setup>Verify setup<a hidden class=anchor aria-hidden=true href=#verify-setup>#</a></h2><p>Back on the master node, check that all nodes have joined the cluster:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ubuntu@k8s-master01:~$ kubectl get nodes -o wide
</span></span><span class=line><span class=cl>NAME           STATUS   ROLES    AGE   VERSION   INTERNAL-IP    EXTERNAL-IP    OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME
</span></span><span class=line><span class=cl>k8s-master01   Ready    master   20m   v1.14.3   10.198.25.84   10.198.25.84   Ubuntu 18.04.2 LTS   4.15.0-51-generic   docker://18.9.6
</span></span><span class=line><span class=cl>k8s-worker01   Ready    &lt;none&gt;   61s   v1.14.3   10.198.25.92   10.198.25.92   Ubuntu 18.04.2 LTS   4.15.0-51-generic   docker://18.9.6
</span></span><span class=line><span class=cl>k8s-worker02   Ready    &lt;none&gt;   61s   v1.14.3   10.198.25.93   10.198.25.93   Ubuntu 18.04.2 LTS   4.15.0-51-generic   docker://18.9.6
</span></span><span class=line><span class=cl>k8s-worker03   Ready    &lt;none&gt;   61s   v1.14.3   10.198.25.94   10.198.25.94   Ubuntu 18.04.2 LTS   4.15.0-51-generic   docker://18.9.6
</span></span></code></pre></div><p>Verify the <code>providerID</code> is set on all the nodes for the VCP to operate correctly:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ubuntu@k8s-master01:~$ kubectl describe nodes <span class=p>|</span> grep <span class=s2>&#34;ProviderID&#34;</span>
</span></span><span class=line><span class=cl>ProviderID:                  vsphere://421cb10a-b42b-dedc-a4ba-ff772488c565
</span></span><span class=line><span class=cl>ProviderID:                  vsphere://421ca947-60a0-464d-ba72-996fc96c6c92
</span></span><span class=line><span class=cl>ProviderID:                  vsphere://421c9702-358e-8253-0c21-faac1e95748b
</span></span><span class=line><span class=cl>ProviderID:                  vsphere://421cb1a3-946d-b7b6-9286-1d021a0b7ba4
</span></span></code></pre></div><h2 id=detatch-the-ovfspec-iso>Detatch the OVFSpec ISO<a hidden class=anchor aria-hidden=true href=#detatch-the-ovfspec-iso>#</a></h2><p>An interesting tidbit is that when using <code>cloud-init</code> through OVF properties, a small ISO is mounted into each VM that contains the spec itself, this needs to be disconnected before any reboots to avoid double-prepping and hostname resets on reboot.</p><p>Eject the OVF ISO:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>govc device.cdrom.eject -vm  k8s-master01
</span></span><span class=line><span class=cl>govc device.cdrom.eject -vm  k8s-worker01
</span></span><span class=line><span class=cl>govc device.cdrom.eject -vm  k8s-worker02
</span></span><span class=line><span class=cl>govc device.cdrom.eject -vm  k8s-worker03
</span></span></code></pre></div><p>In a separate terminal run this to force the eject:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>govc vm.question -vm k8s-master01 -answer <span class=m>0</span>
</span></span><span class=line><span class=cl>govc vm.question -vm k8s-worker01 -answer <span class=m>0</span>
</span></span><span class=line><span class=cl>govc vm.question -vm k8s-worker02 -answer <span class=m>0</span>
</span></span><span class=line><span class=cl>govc vm.question -vm k8s-worker03 -answer <span class=m>0</span>
</span></span></code></pre></div><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>So there we have the second of two methods for VM templating on vSphere - this one is much more prescriptive, scalable and easier to operationalise and we&rsquo;ve gone from nothing to a K8s cluster in this single blog post.</p><p>Go on to <a href=/kubernetes/using-the-vsphere-cloud-provider-for-k8s-to-dynamically-deploy-volumes/>part three</a> of the series here and deploy some apps!</p><h2 id=troubleshooting>Troubleshooting<a hidden class=anchor aria-hidden=true href=#troubleshooting>#</a></h2><p>I learned a LOT about OS customisation during this exercise, a lot of it I didn&rsquo;t want to know. However, most importantly I learned how to troubleshoot it. So below are a few places you can look for guidance when something isn&rsquo;t working.</p><h3 id=vmware-guest-os-customisation>VMware Guest OS Customisation<a hidden class=anchor aria-hidden=true href=#vmware-guest-os-customisation>#</a></h3><h4 id=overview>Overview<a hidden class=anchor aria-hidden=true href=#overview>#</a></h4><p>VMware GOSC has two methods for setting up the deployed OS; <code>cloud-init</code> and custom <code>perl</code> scripts that are part of VMTools. <code>cloud-init</code> being the preferred method from now and hence, the existence of this article.</p><p>When a VM is cloned via a Customisation Spec as above and with the <code>disable_vmware_customisation: false</code> set in <code>/etc/cloud/cloud.cfg</code> and <code>/tmp</code> set to not clear, as we did in the <code>user-data</code> above, vSphere hands off the details specified in the spec (like VM name, DNS domain, DNS servers) to <code>cloud-init</code> within the guest OS to carry out the customisation making it more reliable and easier to maintain.</p><h4 id=vsphere>vSphere<a hidden class=anchor aria-hidden=true href=#vsphere>#</a></h4><p>There are a few places to look if your VMs fail to prep correctly, the first of which is in vSphere itself, when the VMs are cloned if they ever come up with their network disconnected and never get an IP, check the <code>Monitor -> Events</code> tab and see what error occurs here. A successful deployment will have the following in the log (a failed one tells you to check the log in the VM):</p><p><picture><source srcset=images/Screenshot-2019-06-09-19.36.35.avif type=image/avif><source srcset=images/Screenshot-2019-06-09-19.36.35.webp type=image/webp><img src=images/Screenshot-2019-06-09-19.36.35.png alt="VM Events" loading=lazy decoding=async></picture></p><h4 id=in-guest>In-guest<a hidden class=anchor aria-hidden=true href=#in-guest>#</a></h4><p>If you are consistently having VMs come up without networks, either not connected to the port group, or no IP (you shouldn&rsquo;t if you followed the above guide) - throw in your 2c at the <a href=https://github.com/vmware/open-vm-tools/issues/240#issuecomment-395652692 target=_blank>following GitHub issue ↗</a>.</p><p><strong>Critically: do not change</strong> the <a href=https://github.com/vmware/open-vm-tools/issues/240#issuecomment-413150508 target=_blank><code>open-vm-tools systemd</code> unit file ↗</a> when using <code>cloud-init</code> as the customisation engine (like we are). I got caught up here <strong>for days</strong>. Don&rsquo;t repeat my mistakes - this advice is everywhere, including in VMware KBs but is ONLY relevant if using the <code>perl</code> scripts, which we aren&rsquo;t.</p><p>The VMTools customisation log, which handles the handoff of the VMware GOSC spec to <code>cloud-init</code> is located at <code>/var/log/vmware-imc/toolsDeployPkg.log</code> and is very useful if you have customisation problems. I have included a <a href=https://gist.github.com/85c1a8b9c8f86620fef84e1c70270079 target=_blank>successful log here ↗</a>.</p><p>If you see <code>Customization command failed: Failed to create bus connection: No such file or directory</code> in the log, GOSC is using <code>perl</code> instead of <code>cloud-init</code> and is likely either because <code>disable_vmware_customisation: false</code> is not in <code>/etc/cloud/cloud.cfg</code>, or, you edited the <code>open-vm-tools systemd</code> unit file to change the startup order as mentioned above.</p><h3 id=cloud-init>cloud-init<a hidden class=anchor aria-hidden=true href=#cloud-init>#</a></h3><p><code>cloud-init</code> has a number of tools and logs, but the most useful for debugging will be <code>/var/log/cloud-init-output.log</code> it will tell you what modules ran and whether they were successful for not.</p><p>I have found that occasionally, using <code>sudo cloud-init collect-logs</code> and extracting the resulting <code>tar</code> file is very useful for figuring out everything it&rsquo;s doing.</p><h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2><p>Some extra stuff that really helped me along the course of this learning exercise:</p><ul><li><a href=https://apple.stackexchange.com/a/229457/314650 target=_blank>https://apple.stackexchange.com/a/229457/314650 ↗</a></li><li><a href=https://serverfault.com/a/922051/74265 target=_blank>https://serverfault.com/a/922051/74265 ↗</a></li><li><a href=https://medium.com/@andreidascalu/how-to-test-cloud-init-setup-locally-ae05a2fefcf target=_blank>https://medium.com/@andreidascalu/how-to-test-cloud-init-setup-locally-ae05a2fefcf ↗</a></li></ul><p>Why not follow <a href=https://twitter.com/mylesagray target=_blank>@mylesagray on Twitter ↗</a> for more like this!</p></div><footer class=post-footer><section class="section post-tags"><div class=content><h2>Tagged with</h2></div><ul class=post-tags><li><a href=https://blah.cloud/tags/kubernetes/>Kubernetes</a></li><li><a href=https://blah.cloud/tags/vmware/>VMware</a></li><li><a href=https://blah.cloud/tags/vsphere/>VSphere</a></li><li><a href=https://blah.cloud/tags/cloud-init/>Cloud-Init</a></li><li><a href=https://blah.cloud/tags/ova-templating/>Ova Templating</a></li><li><a href=https://blah.cloud/tags/govc/>Govc</a></li></ul></section><nav class=paginav><a class=prev href=https://blah.cloud/kubernetes/first-look-automated-k8s-lifecycle-with-clusterapi/><span class=title>« Prev Page</span><br><span>First-look: Automated K8s lifecycle with ClusterAPI</span>
</a><a class=next href=https://blah.cloud/kubernetes/using-the-vsphere-cloud-provider-for-k8s-to-dynamically-deploy-volumes/><span class=title>Next Page »</span><br><span>Using the vSphere Cloud Provider for K8s to dynamically deploy volumes</span></a></nav><section class="section related-links"><div class="columns is-centered"><div class="column max-800px"><div class=content><h2>Related content</h2></div><div class="columns related-links-columns"><div class="column is-one-third"><div class=card><div class=card-image><figure class="image is-3by2"><a href=/kubernetes/creating-an-ubuntu-18-04-lts-cloud-image-for-cloning-on-vmware/><picture><img src=/kubernetes/creating-an-ubuntu-18-04-lts-cloud-image-for-cloning-on-vmware/images/Screenshot-2019-01-27-22.07.55_hu_3072146f716134dc.webp alt loading=lazy decoding=async></picture></a></figure></div><div class=card-content><a class="title is-5" href=https://blah.cloud/kubernetes/creating-an-ubuntu-18-04-lts-cloud-image-for-cloning-on-vmware/>Creating an Ubuntu 18.04 LTS cloud image for cloning on VMware</a></div></div></div><div class="column is-one-third"><div class=card><div class=card-image><figure class="image is-3by2"><a href=/kubernetes/first-look-automated-k8s-lifecycle-with-clusterapi/><picture><source srcset=/kubernetes/first-look-automated-k8s-lifecycle-with-clusterapi/images/capv-vcenter.avif type=image/avif><source srcset=/kubernetes/first-look-automated-k8s-lifecycle-with-clusterapi/images/capv-vcenter.webp type=image/webp><img src=/kubernetes/first-look-automated-k8s-lifecycle-with-clusterapi/images/capv-vcenter_hu_5ea9f23d5df41b7a.png alt="K8s cluster running on vSphere" loading=lazy decoding=async></picture></a></figure></div><div class=card-content><a class="title is-5" href=https://blah.cloud/kubernetes/first-look-automated-k8s-lifecycle-with-clusterapi/>First-look: Automated K8s lifecycle with ClusterAPI</a></div></div></div><div class="column is-one-third"><div class=card><div class=card-image><figure class="image is-3by2"><a href=/kubernetes/using-the-vsphere-cloud-provider-for-k8s-to-dynamically-deploy-volumes/><picture><img src=/kubernetes/using-the-vsphere-cloud-provider-for-k8s-to-dynamically-deploy-volumes/images/Screenshot-2019-01-27-13.42.27_hu_c0c02942228ad1f6.webp alt="K8s Dashboard" loading=lazy decoding=async></picture></a></figure></div><div class=card-content><a class="title is-5" href=https://blah.cloud/kubernetes/using-the-vsphere-cloud-provider-for-k8s-to-dynamically-deploy-volumes/>Using the vSphere Cloud Provider for K8s to dynamically deploy volumes</a></div></div></div></div></div></div></section><section class="section share-icons"><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Using cloud-init for VM templating on vSphere on twitter" href="https://twitter.com/intent/tweet/?text=Using%20cloud-init%20for%20VM%20templating%20on%20vSphere&amp;url=https%3a%2f%2fblah.cloud%2finfrastructure%2fusing-cloud-init-for-vm-templating-on-vsphere%2f&amp;hashtags=Kubernetes%2cVMware%2cvSphere%2ccloud-init%2covatemplating%2cgovc"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share Using cloud-init for VM templating on vSphere on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fblah.cloud%2finfrastructure%2fusing-cloud-init-for-vm-templating-on-vsphere%2f&title=Using%20cloud-init%20for%20VM%20templating%20on%20vSphere"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share Using cloud-init for VM templating on vSphere on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fblah.cloud%2finfrastructure%2fusing-cloud-init-for-vm-templating-on-vsphere%2f&amp;title=Using%20cloud-init%20for%20VM%20templating%20on%20vSphere&amp;summary=Using%20cloud-init%20for%20VM%20templating%20on%20vSphere&amp;source=https%3a%2f%2fblah.cloud%2finfrastructure%2fusing-cloud-init-for-vm-templating-on-vsphere%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></div></section></footer><script src=https://utteranc.es/client.js repo=mylesagray/blog-comments issue-term=title theme=preferred-color-scheme crossorigin=anonymous async></script></article><aside class="hidden lg:block tableOfContentContainer" id=tableOfContentContainer><nav id=TableOfContents><ul><li><a href=#prerequisites>Prerequisites</a><ul><li><a href=#tools>Tools</a></li><li><a href=#resources>Resources</a></li></ul></li><li><a href=#setup>Setup</a><ul><li><a href=#govc>govc</a></li></ul></li><li><a href=#extract-the-image-spec>Extract the image spec</a><ul><li><a href=#extract-the-ovf-spec-from-the-ova>Extract the OVF spec from the OVA</a></li><li><a href=#customise-the-ovf-spec>Customise the OVF spec</a></li></ul></li><li><a href=#building-the-user-data-file>Building the user-data file</a><ul><li><a href=#setting-up-users-and-groups>Setting up users and groups</a></li><li><a href=#adding-apt-repositories-and-installing-packages>Adding apt repositories and installing packages</a></li><li><a href=#writing-the-kubeadm-and-vsphereconf-template-files>Writing the kubeadm and vsphere.conf template files</a></li></ul></li><li><a href=#some-system-prep-commands-and-housekeeping>Some system-prep commands and housekeeping</a><ul><li><a href=#running-arbitrary-commands>Running arbitrary commands</a></li></ul></li><li><a href=#encoding-the-data-and-deploying-the-template>Encoding the data and deploying the template</a><ul><li><a href=#encoding-with-base64>Encoding with base64</a></li><li><a href=#adding-the-base64-to-ubuntujson>Adding the base64 to ubuntu.json</a></li></ul></li><li><a href=#deploy-the-template-vm>Deploy the template VM</a><ul><li><a href=#import-the-ova>Import the OVA</a></li><li><a href=#vsphere-customisation-spec>vSphere customisation spec</a></li><li><a href=#deploy-some-vms>Deploy some VMs</a></li><li><a href=#move-the-vms-into-a-folder>Move the VMs into a folder</a></li></ul></li><li><a href=#run-kubeadm>Run kubeadm</a><ul><li><a href=#initialise-the-master>Initialise the master</a></li><li><a href=#on-your-laptop>On your laptop</a></li><li><a href=#join-the-workers-to-the-cluster>Join the workers to the cluster</a></li></ul></li><li><a href=#verify-setup>Verify setup</a></li><li><a href=#detatch-the-ovfspec-iso>Detatch the OVFSpec ISO</a></li><li><a href=#conclusion>Conclusion</a></li><li><a href=#troubleshooting>Troubleshooting</a><ul><li><a href=#vmware-guest-os-customisation>VMware Guest OS Customisation</a></li><li><a href=#cloud-init>cloud-init</a></li></ul></li><li><a href=#references>References</a></li></ul></nav></aside></div></main></div><footer class=footer><span>&copy; 2025 <a href=https://blah.cloud/>Blah, Cloud</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://git.io/JPbaU rel=noopener target=_blank>BurgerMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>